= Learning R Code Samples

////
% \VignetteEngine{knitr::knitr}
% \VignetteIndexEntry{Learning R Code Samples}
////


Preface
=======
About This Book
~~~~~~~~~~~~~~~
What is in This Book
~~~~~~~~~~~~~~~~~~~~
Which Chapters Should I Read?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Conventions Used in This Book
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Goals, Summaries, Quizzes and Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Using Code Examples
~~~~~~~~~~~~~~~~~~~
Safari Books Online
~~~~~~~~~~~~~~~~~~~
Errata and Support
~~~~~~~~~~~~~~~~~~
Acknowledgements
~~~~~~~~~~~~~~~~
Introduction
------------  
Chapter Goals
~~~~~~~~~~~~~
What Is R?
~~~~~~~~~~
Installing R
~~~~~~~~~~~~
Choosing an IDE
~~~~~~~~~~~~~~~
Emacs + ESS
^^^^^^^^^^^
Eclipse/Architect
^^^^^^^^^^^^^^^^
RStudio
^^^^^^^^
Revolution-R
^^^^^^^^^^^^
Live-R
^^^^^^
Other IDEs and Editors
~~~~~~~~~~~~~~~~~~~~~~
Your First Program
~~~~~~~~~~~~~~~~~~

[source,r]
----
mean(1:5)
----


[[TIP]]
====
In R GUI and most of the IDEs mentioned, you can press the UP arrow key to cycle back through previous commands.
====
How to Get Help in R
~~~~~~~~~~~~~~~~~~~~

[source,r]
----
`?`(mean  #opens the help page for the mean function
)
`?`("+"  #opens the help page for addition
)
`?`("if"  #opens the help page for if, used for branching code
)
`?`(`?`(plotting  #searches for help containing words like 'plotting'
))
`?`(`?`("regression model"  #searches for the help containing phrases like this
))
----



[source,r]
----
help("mean")
help("+")
help("if")
help.search("plotting")
help.search("regression model")
----



[source,r]
----
a_vector <- c(1, 3, 6, 10)
apropos("vector")
----



----
## [1] ".__C__vector"         "a_vector"             "as.data.frame.vector"
## [4] "as.vector"            "as.vector.factor"     "is.vector"           
## [7] "vector"               "Vectorize"
----



[source,r]
----
apropos("z$")
----

----
## [1] "alpe_d_huez" "SSgompertz"  "toeplitz"    "unz"
----

[source,r]
----
apropos("[4-9]")
----

----
##  [1] ".__C__S4"       ".TAOCP1997init" "asS4"           "blues9"        
##  [5] "enc2utf8"       "fixPre1.8"      "Harman74.cor"   "intToUtf8"     
##  [9] "isS4"           "seemsS4Object"  "state.x77"      "utf8ToInt"
----



[source,r]
----
example(plot)
demo()  #list all demonstrations
demo(Japanese)
----



[source,r]
----
browseVignettes()
----



[source,r]
----
vignette("Sweave", package = "utils")
----



[source,r]
----
RSiteSearch("{Bayesian regression}")
----


[[TIP]]
====
Learning to help yourself is an extremely important skill.  Think of a keyword related to your work and try +?+, +??+, +apropos+ and +RSiteSearch+ with it.
====
Installing Extra Related Software
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
install.packages("installr")  #download and install the package named installr
library(installr)  #load the installr package
install.RStudio()  #download and install the RStudio IDE
install.Rtools()  #Rtools is needed for building your own packages
install.git()  #git provides version control for your code
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A scientific calculator
----------------------- 
Chapter Goals
~~~~~~~~~~~~~
Mathematical Operations and Vectors
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
1:5 + 6:10  #look, no loops!
----

----
## [1]  7  9 11 13 15
----

[source,r]
----
c(1, 3, 6, 10, 15) + c(0, 1, 3, 6, 10)
----

----
## [1]  1  4  9 16 25
----


[TIP]
====
The colon operator and the +c+ function are used almost everywhere in R code, so it's good to practice using them.  Try creating some vectors of your own now.
====

[source,r]
----
sum(1:5)
----

----
## [1] 15
----

[source,r]
----
median(1:5)
----

----
## [1] 3
----



[source,r]
----
sum(1, 2, 3, 4, 5)
----

----
## [1] 15
----

[source,r]
----
median(1, 2, 3, 4, 5)  #this throws an error
----

[CAUTION]
====
.Error
unused arguments (3, 4, 5)

====



[source,r]
----
c(2, 3, 5, 7, 11, 13) - 2  #subtraction                           
----

----
## [1]  0  1  3  5  9 11
----

[source,r]
----
-2:2 * -2:2  #multiplication
----

----
## [1] 4 1 0 1 4
----

[source,r]
----
identical(2^3, 2^3)  #we can use ^ or ** for exponentiation
----

----
## [1] TRUE
----

[source,r]
----
# though ^ is more common
1:10/3  #floating point division
----

----
##  [1] 0.3333 0.6667 1.0000 1.3333 1.6667 2.0000 2.3333 2.6667 3.0000 3.3333
----

[source,r]
----
1:10%/%3  #integer division
----

----
##  [1] 0 0 1 1 1 2 2 2 3 3
----

[source,r]
----
1:10%%3  #remainder after division
----

----
##  [1] 1 2 0 1 2 0 1 2 0 1
----



[source,r]
----
cos(c(0, pi/4, pi/2, pi))  #pi is a built-in constant
----

----
## [1]  1.000e+00  7.071e-01  6.123e-17 -1.000e+00
----

[source,r]
----
exp(pi * 1) + 1  #Euler's formula
----

----
## [1] 24.14
----

[source,r]
----
factorial(7) + factorial(1) - 71^2  #5041 is a great number
----

----
## [1] 0
----

[source,r]
----
choose(5, 0:5)
----

----
## [1]  1  5 10 10  5  1
----



[source,r]
----
c(3, 4 - 1, 1 + 1 + 1) == 3  #operators are vectorised too 
----

----
## [1] TRUE TRUE TRUE
----

[source,r]
----
1:3 != 3:1
----

----
## [1]  TRUE FALSE  TRUE
----

[source,r]
----
exp(1:5) < 100
----

----
## [1]  TRUE  TRUE  TRUE  TRUE FALSE
----

[source,r]
----
(1:5)^2 >= 16
----

----
## [1] FALSE FALSE FALSE  TRUE  TRUE
----



[source,r]
----
sqrt(2)^2 == 2  #sqrt is the square-root function
----

----
## [1] FALSE
----

[source,r]
----
sqrt(2)^2 - 2  #this small value is the rounding error
----

----
## [1] 4.441e-16
----



[source,r]
----
all.equal(sqrt(2)^2, 2)
----

----
## [1] TRUE
----



[source,r]
----
all.equal(sqrt(2)^2, 3)
----

----
## [1] "Mean relative difference: 0.5"
----

[source,r]
----
isTRUE(all.equal(sqrt(2)^2, 3))
----

----
## [1] FALSE
----


[NOTE]
====
To check that two numbers are the same, don't use +==+.  Instead, use the +all.equal+ function.
====

[source,r]
----
c("Can", "you", "can", "a", "can", "as", "a", "canner", "can", "can", "a", "can?") == 
    "can"
----

----
##  [1] FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE  TRUE  TRUE FALSE
## [12] FALSE
----

[source,r]
----
c("A", "B", "C", "D") < "C"
----

----
## [1]  TRUE  TRUE FALSE FALSE
----

[source,r]
----
c("a", "b", "c", "d") < "C"  #your results may vary
----

----
## [1]  TRUE  TRUE  TRUE FALSE
----


[TIP]
====
The help pages +?Arithmetic+, +?Trig+, +?Special+ and +?Comparison+ have more examples, and explain the gory details of what happens in edge cases.  (Try +0 ^ 0+ or integer division on non-integers if you are curious.)
====
Assigning Variables
~~~~~~~~~~~~~~~~~~~

[source,r]
----
x <- 1:5
y = 6:10
----



[source,r]
----
x + 2 * y - 3
----

----
## [1] 10 13 16 19 22
----



[source,r]
----
x <- 3
x < -3
x <- 3  #is this assignment or less than?
----



[source,r]
----
x <<- exp(exp(1))
----



[source,r]
----
assign("my_local_variable", 9^3 + 10^3)
----



[source,r]
----
assign("my_global_variable", 1^3 + 12^3, globalenv())
----


[WARNING]
====
Also note that the +assign+ function doesn't check its first argument to see if it is a valid variable name: it always just creates it. 
====

[source,r]
----
x
----

----
## [1] 15.15
----



[source,r]
----
z <- rnorm(5)
z
----

----
## [1]  0.3964 -0.8407  0.9568  0.7299  0.5045
----

[source,r]
----
(zz <- rlnorm(5))
----

----
## [1]  0.5879 11.3400  1.3155  0.3550  0.5160
----


Special Numbers
~~~~~~~~~~~~~~~

[source,r]
----
c(Inf + 1, Inf - 1, Inf - Inf)
----

----
## [1] Inf Inf NaN
----

[source,r]
----
c(1/Inf, Inf/1, Inf/Inf)
----

----
## [1]   0 Inf NaN
----

[source,r]
----
c(sqrt(Inf), sin(Inf))
----

[WARNING]
====
.Warning
NaNs produced

====

----
## [1] Inf NaN
----

[source,r]
----
c(log(Inf), log(Inf, base = Inf))
----

[WARNING]
====
.Warning
NaNs produced

====

----
## [1] Inf NaN
----

[source,r]
----
c(NA + 1, NA * 5, NA + Inf)
----

----
## [1] NA NA NA
----



[source,r]
----
c(NA + NA, NaN + NaN, NaN + NA, NA + NaN)
----

----
## [1]  NA NaN NaN  NA
----



[source,r]
----
x <- c(0, Inf, -Inf, NaN, NA)
is.finite(x)
----

----
## [1]  TRUE FALSE FALSE FALSE FALSE
----

[source,r]
----
is.infinite(x)
----

----
## [1] FALSE  TRUE  TRUE FALSE FALSE
----

[source,r]
----
is.nan(x)
----

----
## [1] FALSE FALSE FALSE  TRUE FALSE
----

[source,r]
----
is.na(x)
----

----
## [1] FALSE FALSE FALSE  TRUE  TRUE
----


Logical Vectors
~~~~~~~~~~~~~~~

[source,r]
----
(x <- 1:10 >= 5)
----

----
##  [1] FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
----

[source,r]
----
!x
----

----
##  [1]  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
----

[source,r]
----
(y <- 1:10%%2 == 0)
----

----
##  [1] FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE  TRUE
----

[source,r]
----
x & y
----

----
##  [1] FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE  TRUE
----

[source,r]
----
x | y
----

----
##  [1] FALSE  TRUE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
----



[source,r]
----
x <- c(TRUE, FALSE, NA)         #the three logical values
xy <- expand.grid(x = x, y = x) #get all combinations of x and y
within(                         #make the next assignments within xy
  xy,
  {
    and <- x & y
    or  <- x | y
    not.y <- !y   
    not.x <- !x
  }
)
----

----
##       x     y not.x not.y    or   and
## 1  TRUE  TRUE FALSE FALSE  TRUE  TRUE
## 2 FALSE  TRUE  TRUE FALSE  TRUE FALSE
## 3    NA  TRUE    NA FALSE  TRUE    NA
## 4  TRUE FALSE FALSE  TRUE  TRUE FALSE
## 5 FALSE FALSE  TRUE  TRUE FALSE FALSE
## 6    NA FALSE    NA  TRUE    NA FALSE
## 7  TRUE    NA FALSE    NA  TRUE    NA
## 8 FALSE    NA  TRUE    NA    NA FALSE
## 9    NA    NA    NA    NA    NA    NA
----



[source,r]
----
none_true <- c(FALSE, FALSE, FALSE)
some_true <- c(FALSE, TRUE, FALSE)
all_true <- c(TRUE, TRUE, TRUE)
any(none_true)
----

----
## [1] FALSE
----

[source,r]
----
any(some_true)
----

----
## [1] TRUE
----

[source,r]
----
any(all_true)
----

----
## [1] TRUE
----

[source,r]
----
all(none_true)
----

----
## [1] FALSE
----

[source,r]
----
all(some_true)
----

----
## [1] FALSE
----

[source,r]
----
all(all_true)
----

----
## [1] TRUE
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Inspecting variables and your workspace
---------------------------------------
Chapter Goals
~~~~~~~~~~~~~
Classes
~~~~~~~

[source,r]
----
class(c(TRUE, FALSE))
----

----
## [1] "logical"
----


Different Types of Numbers
~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
class(sqrt(1:10))
----

----
## [1] "numeric"
----

[source,r]
----
class(3 + 1)  #'i' creates imaginary components of complex numbers
----

----
## [1] "numeric"
----

[source,r]
----
class(1)  #although this is a whole number, it has class numeric
----

----
## [1] "numeric"
----

[source,r]
----
class(1L)  #add a suffix of 'L' to make the number an integer
----

----
## [1] "integer"
----

[source,r]
----
class(0.5:4.5)  #the colon operator returns a value that is numeric ...
----

----
## [1] "numeric"
----

[source,r]
----
class(1:5)  #unless all its values are whole numbers
----

----
## [1] "integer"
----


Other Common Classes
~~~~~~~~~~~~~~~~~~~~           

[source,r]
----
class(c("she", "sells", "seashells", "on", "the", "sea", "shore"))
----

----
## [1] "character"
----



[source,r]
----
(gender <- factor(c("male", "female", "female", "male", "female")))
----

----
## [1] male   female female male   female
## Levels: female male
----



[source,r]
----
levels(gender)
----

----
## [1] "female" "male"
----

[source,r]
----
nlevels(gender)
----

----
## [1] 2
----



[source,r]
----
as.integer(gender)
----

----
## [1] 2 1 1 2 1
----


[NOTE]
====
Variables take up different amounts of memory on 32-bit and 64-bit systems, so +object.size+ will return different values in each case.
====

[source,r]
----
gender_char <- sample(c("female", "male"), 10000, replace = TRUE)
gender_fac <- as.factor(gender_char)
object.size(gender_char)
----

----
## 80136 bytes
----

[source,r]
----
object.size(gender_fac)
----

----
## 40512 bytes
----



[source,r]
----
as.character(gender)
----

----
## [1] "male"   "female" "female" "male"   "female"
----



[source,r]
----
as.raw(1:17)
----

----
##  [1] 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 10 11
----

[source,r]
----
as.raw(c(pi, 1 + 1, -1, 256))
----

[WARNING]
====
.Warning
out-of-range values treated as 0 in coercion to raw

====

----
## [1] 03 02 00 00
----

[source,r]
----
(sushi <- charToRaw("Fish!"))
----

----
## [1] 46 69 73 68 21
----

[source,r]
----
class(sushi)
----

----
## [1] "raw"
----


Checking and Changing Classes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
if (!is(x, "some_class")) {
    # Some corrective measure
}
----



[source,r]
----
is.character("red lorry, yellow lorry")
----

----
## [1] TRUE
----

[source,r]
----
is.logical(FALSE)
----

----
## [1] TRUE
----

[source,r]
----
is.list(list(a = 1, b = 2))
----

----
## [1] TRUE
----



[source,r]
----
ls(pattern = "^is", baseenv())
----

----
##  [1] "is.array"              "is.atomic"            
##  [3] "is.call"               "is.character"         
##  [5] "is.complex"            "is.data.frame"        
##  [7] "is.double"             "is.element"           
##  [9] "is.environment"        "is.expression"        
## [11] "is.factor"             "is.finite"            
## [13] "is.function"           "is.infinite"          
## [15] "is.integer"            "is.language"          
## [17] "is.list"               "is.loaded"            
## [19] "is.logical"            "is.matrix"            
## [21] "is.na"                 "is.na.data.frame"     
## [23] "is.na.numeric_version" "is.na.POSIXlt"        
## [25] "is.na<-"               "is.na<-.default"      
## [27] "is.na<-.factor"        "is.name"              
## [29] "is.nan"                "is.null"              
## [31] "is.numeric"            "is.numeric.Date"      
## [33] "is.numeric.difftime"   "is.numeric.POSIXt"    
## [35] "is.numeric_version"    "is.object"            
## [37] "is.ordered"            "is.package_version"   
## [39] "is.pairlist"           "is.primitive"         
## [41] "is.qr"                 "is.R"                 
## [43] "is.raw"                "is.recursive"         
## [45] "is.single"             "is.symbol"            
## [47] "is.table"              "is.unsorted"          
## [49] "is.vector"             "isatty"               
## [51] "isBaseNamespace"       "isdebugged"           
## [53] "isIncomplete"          "isNamespace"          
## [55] "isOpen"                "isRestart"            
## [57] "isS4"                  "isSeekable"           
## [59] "isSymmetric"           "isSymmetric.matrix"   
## [61] "isTRUE"
----



[source,r]
----
is.numeric(1)
----

----
## [1] TRUE
----

[source,r]
----
is.numeric(1L)
----

----
## [1] TRUE
----

[source,r]
----
is.integer(1)
----

----
## [1] FALSE
----

[source,r]
----
is.integer(1L)
----

----
## [1] TRUE
----

[source,r]
----
is.double(1)
----

----
## [1] TRUE
----

[source,r]
----
is.double(1L)
----

----
## [1] FALSE
----


[NOTE]
====
The number of decimal places that R prints for numbers depends upon your R setup.  You can set a global default using +options(digits = n)+, where +n+ is between 1 and 22.  Further control of printing numbers is discussed in the chapter on Strings and Factors.
====

[source,r]
----
x <- "123.456"
as(x, "numeric")
----

----
## [1] 123.5
----

[source,r]
----
as.numeric(x)
----

----
## [1] 123.5
----



[source,r]
----
y <- c(2, 12, 343, 34997)  #See http://oeis.org/A192892
as(y, "data.frame")
as.data.frame(y)
----



[source,r]
----
x <- "123.456"
class(x) <- "numeric"
x
----

----
## [1] 123.5
----

[source,r]
----
is.numeric(x)
----

----
## [1] TRUE
----


Examining Variables
~~~~~~~~~~~~~~~~~~~

[source,r]
----
ulams_spiral <- c(1, 8, 23, 46, 77)  #See http://oeis.org/A033951
for (i in ulams_spiral) i  #uh-oh, the values aren't printed
for (i in ulams_spiral) print(i)
----

----
## [1] 1
## [1] 8
## [1] 23
## [1] 46
## [1] 77
----


[NOTE]
====
Both the +c+ and +cat+ functions are short for concatenate; though they perform quite different tasks! +cat+ is named after a Unix function.
====

[source,r]
----
num <- runif(30)
summary(num)
----

----
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.0832  0.1870  0.3850  0.4640  0.7730  0.9770
----



[source,r]
----
fac <- factor(sample(letters[1:5], 30, replace = TRUE))
summary(fac)
----

----
##  a  b  c  d  e 
## 11  7  3  5  4
----

[source,r]
----
bool <- sample(c(TRUE, FALSE, NA), 30, replace = TRUE)
summary(bool)
----

----
##    Mode   FALSE    TRUE    NA's 
## logical      14      11       5
----



[source,r]
----
dfr <- data.frame(num, fac, bool)
head(dfr)
----

----
##      num fac  bool
## 1 0.4383   e    NA
## 2 0.9767   a FALSE
## 3 0.6355   c FALSE
## 4 0.1820   d FALSE
## 5 0.1096   a FALSE
## 6 0.1531   d    NA
----



[source,r]
----
summary(dfr)
----

----
##       num         fac       bool        
##  Min.   :0.0832   a:11   Mode :logical  
##  1st Qu.:0.1868   b: 7   FALSE:14       
##  Median :0.3853   c: 3   TRUE :11       
##  Mean   :0.4639   d: 5   NA's :5        
##  3rd Qu.:0.7729   e: 4                  
##  Max.   :0.9767
----



[source,r]
----
str(num)
----

----
##  num [1:30] 0.438 0.977 0.636 0.182 0.11 ...
----

[source,r]
----
str(dfr)
----

----
## 'data.frame':	30 obs. of  3 variables:
##  $ num : num  0.438 0.977 0.636 0.182 0.11 ...
##  $ fac : Factor w/ 5 levels "a","b","c","d",..: 5 1 3 4 1 4 1 1 2 1 ...
##  $ bool: logi  NA FALSE FALSE FALSE FALSE NA ...
----



[source,r]
----
unclass(fac)
----

----
##  [1] 5 1 3 4 1 4 1 1 2 1 2 1 2 1 4 2 2 5 5 4 1 2 1 1 4 5 2 1 3 3
## attr(,"levels")
## [1] "a" "b" "c" "d" "e"
----



[source,r]
----
attributes(fac)
----

----
## $levels
## [1] "a" "b" "c" "d" "e"
## 
## $class
## [1] "factor"
----



[source,r]
----
View(dfr)  #no changes allowed
new_dfr <- edit(dfr)  #changes stored in new_dfr
fix(dfr)  #changes stored in dfr
----



[source,r]
----
View(head(dfr, 50))  #view first 50 rows
----


The Workspace
~~~~~~~~~~~~~



[source,r]
----
# Create some variables to find
peach <- 1
plum <- "fruity"
pear <- TRUE
ls()
----

----
##  [1] "a_vector"           "all_true"           "bool"              
##  [4] "dfr"                "fac"                "gender"            
##  [7] "gender_char"        "gender_fac"         "i"                 
## [10] "my_global_variable" "my_local_variable"  "none_true"         
## [13] "num"                "peach"              "pear"              
## [16] "pkg"                "pkglr"              "plum"              
## [19] "some_true"          "sushi"              "ulams_spiral"      
## [22] "x"                  "xy"                 "y"                 
## [25] "z"                  "zz"
----

[source,r]
----
ls(pattern = "ea")
----

----
## [1] "peach" "pear"
----



[source,r]
----
browseEnv()
----



[source,r]
----
rm(peach, plum, pear)
rm(list = ls())  #Remove everything.  Use with caution!
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Vectors, Matrices And Arrays
----------------------------
Chapter Goals
~~~~~~~~~~~~~
Vectors
~~~~~~~

[source,r]
----
8.5:4.5  #sequence of numbers from 8.5 down to 4.5
----

----
## [1] 8.5 7.5 6.5 5.5 4.5
----

[source,r]
----
c(1, 1:3, c(5, 8), 13)  #values concatenated into single vector
----

----
## [1]  1  1  2  3  5  8 13
----



[source,r]
----
vector("numeric", 5)
----

----
## [1] 0 0 0 0 0
----

[source,r]
----
vector("complex", 5)
----

----
## [1] 0+0i 0+0i 0+0i 0+0i 0+0i
----

[source,r]
----
vector("logical", 5)
----

----
## [1] FALSE FALSE FALSE FALSE FALSE
----

[source,r]
----
vector("character", 5)
----

----
## [1] "" "" "" "" ""
----

[source,r]
----
vector("list", 5)
----

----
## [[1]]
## NULL
## 
## [[2]]
## NULL
## 
## [[3]]
## NULL
## 
## [[4]]
## NULL
## 
## [[5]]
## NULL
----



[source,r]
----
numeric(5)
----

----
## [1] 0 0 0 0 0
----

[source,r]
----
complex(5)
----

----
## [1] 0+0i 0+0i 0+0i 0+0i 0+0i
----

[source,r]
----
logical(5)
----

----
## [1] FALSE FALSE FALSE FALSE FALSE
----

[source,r]
----
character(5)
----

----
## [1] "" "" "" "" ""
----


Sequences
^^^^^^^^^

[source,r]
----
seq.int(3, 12)  #same as 3:12       
----

----
##  [1]  3  4  5  6  7  8  9 10 11 12
----



[source,r]
----
seq.int(3, 12, 2)
----

----
## [1]  3  5  7  9 11
----

[source,r]
----
seq.int(0.1, 0.01, -0.01)
----

----
##  [1] 0.10 0.09 0.08 0.07 0.06 0.05 0.04 0.03 0.02 0.01
----



[source,r]
----
n <- 0
1:n  #not what you might expect!
----

----
## [1] 1 0
----

[source,r]
----
seq_len(n)
----

----
## integer(0)
----



[source,r]
----
pp <- c("Peter", "Piper", "picked", "a", "peck", "of", "pickled", "peppers")
for (i in seq_along(pp)) print(pp[i])
----

----
## [1] "Peter"
## [1] "Piper"
## [1] "picked"
## [1] "a"
## [1] "peck"
## [1] "of"
## [1] "pickled"
## [1] "peppers"
----


Lengths
^^^^^^^

[source,r]
----
length(1:5)
----

----
## [1] 5
----

[source,r]
----
length(c(TRUE, FALSE, NA))
----

----
## [1] 3
----



[source,r]
----
sn <- c("Sheena", "leads", "Sheila", "needs")
length(sn)
----

----
## [1] 4
----

[source,r]
----
nchar(sn)
----

----
## [1] 6 5 6 5
----



[source,r]
----
poincare <- c(1, 0, 0, 0, 2, 0, 2, 0)  #See http://oeis.org/A051629
length(poincare) <- 3
poincare
----

----
## [1] 1 0 0
----

[source,r]
----
length(poincare) <- 8
poincare
----

----
## [1]  1  0  0 NA NA NA NA NA
----


Names
^^^^^

[source,r]
----
c(apple = 1, banana = 2, `kiwi fruit` = 3, 4)
----

----
##      apple     banana kiwi fruit            
##          1          2          3          4
----



[source,r]
----
x <- 1:4
names(x) <- c("apple", "bananas", "kiwi fruit", "")
x
----

----
##      apple    bananas kiwi fruit            
##          1          2          3          4
----



[source,r]
----
names(x)
----

----
## [1] "apple"      "bananas"    "kiwi fruit" ""
----



[source,r]
----
names(1:4)
----

----
## NULL
----


Indexing Vectors
^^^^^^^^^^^^^^^^

[source,r]
----
(x <- (1:5)^2)
----

----
## [1]  1  4  9 16 25
----



[source,r]
----
x[c(1, 3, 5)]
----

----
## [1]  1  9 25
----

[source,r]
----
x[c(-2, -4)]
----

----
## [1]  1  9 25
----

[source,r]
----
x[c(TRUE, FALSE, TRUE, FALSE, TRUE)]
----

----
## [1]  1  9 25
----



[source,r]
----
names(x) <- c("one", "four", "nine", "sixteen", "twenty five")
x[c("one", "nine", "twenty five")]
----

----
##         one        nine twenty five 
##           1           9          25
----



[source,r]
----
x[c(1, -1)]  #This doesn't make sense!
----

[CAUTION]
====
.Error
only 0's may be mixed with negative subscripts

====



[source,r]
----
x[c(1, NA, 5)]
----

----
##         one        <NA> twenty five 
##           1          NA          25
----

[source,r]
----
x[c(TRUE, FALSE, NA, FALSE, TRUE)]
----

----
##         one        <NA> twenty five 
##           1          NA          25
----



[source,r]
----
x[c(-2, NA)]  #This doesn't make sense either!
----

[CAUTION]
====
.Error
only 0's may be mixed with negative subscripts

====



[source,r]
----
x[6]
----

----
## <NA> 
##   NA
----



[source,r]
----
x[1.9]  #1.9 rounded to 1
----

----
## one 
##   1
----

[source,r]
----
x[-1.9]  #-1.9 rounded to -1
----

----
##        four        nine     sixteen twenty five 
##           4           9          16          25
----



[source,r]
----
x[]
----

----
##         one        four        nine     sixteen twenty five 
##           1           4           9          16          25
----



[source,r]
----
which(x > 10)
----

----
##     sixteen twenty five 
##           4           5
----



[source,r]
----
which.min(x)
----

----
## one 
##   1
----

[source,r]
----
which.max(x)
----

----
## twenty five 
##           5
----


Vector Recycling and Repetition
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
1:5 + 1
----

----
## [1] 2 3 4 5 6
----

[source,r]
----
1 + 1:5
----

----
## [1] 2 3 4 5 6
----



[source,r]
----
1:5 + 1:15
----

----
##  [1]  2  4  6  8 10  7  9 11 13 15 12 14 16 18 20
----



[source,r]
----
1:5 + 1:7
----

[WARNING]
====
.Warning
longer object length is not a multiple of shorter object length

====

----
## [1]  2  4  6  8 10  7  9
----



[source,r]
----
rep(1:5, 3)
----

----
##  [1] 1 2 3 4 5 1 2 3 4 5 1 2 3 4 5
----

[source,r]
----
rep(1:5, each = 3)
----

----
##  [1] 1 1 1 2 2 2 3 3 3 4 4 4 5 5 5
----

[source,r]
----
rep(1:5, times = 1:5)
----

----
##  [1] 1 2 2 3 3 3 4 4 4 4 5 5 5 5 5
----

[source,r]
----
rep(1:5, length.out = 7)
----

----
## [1] 1 2 3 4 5 1 2
----



[source,r]
----
rep.int(1:5, 3)  #the same as rep(1:5, 3) 
----

----
##  [1] 1 2 3 4 5 1 2 3 4 5 1 2 3 4 5
----



[source,r]
----
rep_len(1:5, 13)
----

----
##  [1] 1 2 3 4 5 1 2 3 4 5 1 2 3
----


Matrices and Arrays
~~~~~~~~~~~~~~~~~~~
Creating Arrays and Matrices
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
(three_d_array <- array(1:24, dim = c(4, 3, 2), dimnames = list(c("one", "two", 
    "three", "four"), c("ein", "zwei", "drei"), c("un", "deux"))))
----

----
## , , un
## 
##       ein zwei drei
## one     1    5    9
## two     2    6   10
## three   3    7   11
## four    4    8   12
## 
## , , deux
## 
##       ein zwei drei
## one    13   17   21
## two    14   18   22
## three  15   19   23
## four   16   20   24
----

[source,r]
----
class(three_d_array)
----

----
## [1] "array"
----



[source,r]
----
(a_matrix <- matrix(
  1:12,
  nrow = 4,            #ncol = 3 works the same
  dimnames = list(
    c("one", "two", "three", "four"),
    c("ein", "zwei", "drei")
  )
))                           
----

----
##       ein zwei drei
## one     1    5    9
## two     2    6   10
## three   3    7   11
## four    4    8   12
----

[source,r]
----
class(a_matrix)
----

----
## [1] "matrix"
----



[source,r]
----
(two_d_array <- array(1:12, dim = c(4, 3), dimnames = list(c("one", "two", "three", 
    "four"), c("ein", "zwei", "drei"))))
----

----
##       ein zwei drei
## one     1    5    9
## two     2    6   10
## three   3    7   11
## four    4    8   12
----

[source,r]
----
identical(two_d_array, a_matrix)
----

----
## [1] TRUE
----

[source,r]
----
class(two_d_array)
----

----
## [1] "matrix"
----



[source,r]
----
matrix(1:12, nrow = 4, byrow = TRUE, dimnames = list(c("one", "two", "three", 
    "four"), c("ein", "zwei", "drei")))
----

----
##       ein zwei drei
## one     1    2    3
## two     4    5    6
## three   7    8    9
## four   10   11   12
----


Rows, Columns and Dimensions
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
dim(three_d_array)
----

----
## [1] 4 3 2
----

[source,r]
----
dim(a_matrix)
----

----
## [1] 4 3
----



[source,r]
----
nrow(a_matrix)
----

----
## [1] 4
----

[source,r]
----
ncol(a_matrix)
----

----
## [1] 3
----



[source,r]
----
nrow(three_d_array)
----

----
## [1] 4
----

[source,r]
----
ncol(three_d_array)
----

----
## [1] 3
----



[source,r]
----
length(three_d_array)
----

----
## [1] 24
----

[source,r]
----
length(a_matrix)
----

----
## [1] 12
----



[source,r]
----
dim(a_matrix) <- c(6, 2)
a_matrix
----

----
##      [,1] [,2]
## [1,]    1    7
## [2,]    2    8
## [3,]    3    9
## [4,]    4   10
## [5,]    5   11
## [6,]    6   12
----



[source,r]
----
identical(nrow(a_matrix), NROW(a_matrix))
----

----
## [1] TRUE
----

[source,r]
----
identical(ncol(a_matrix), NCOL(a_matrix))
----

----
## [1] TRUE
----

[source,r]
----
recaman <- c(0, 1, 3, 6, 2, 7, 13, 20)  #See http://oeis.org/A005132
nrow(x)
----

----
## NULL
----

[source,r]
----
NROW(x)
----

----
## [1] 5
----

[source,r]
----
ncol(x)
----

----
## NULL
----

[source,r]
----
NCOL(x)
----

----
## [1] 1
----

[source,r]
----
dim(x)  #There is no DIM(X)
----

----
## NULL
----


Row, Column and Dimension Names
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^



[source,r]
----
rownames(a_matrix)
----

----
## [1] "one"   "two"   "three" "four"
----

[source,r]
----
colnames(a_matrix)
----

----
## [1] "ein"  "zwei" "drei"
----

[source,r]
----
dimnames(a_matrix)
----

----
## [[1]]
## [1] "one"   "two"   "three" "four" 
## 
## [[2]]
## [1] "ein"  "zwei" "drei"
----

[source,r]
----
rownames(three_d_array)
----

----
## [1] "one"   "two"   "three" "four"
----

[source,r]
----
colnames(three_d_array)
----

----
## [1] "ein"  "zwei" "drei"
----

[source,r]
----
dimnames(three_d_array)
----

----
## [[1]]
## [1] "one"   "two"   "three" "four" 
## 
## [[2]]
## [1] "ein"  "zwei" "drei"
## 
## [[3]]
## [1] "un"   "deux"
----


Indexing Arrays
^^^^^^^^^^^^^^^

[source,r]
----
a_matrix[1, c("zwei", "drei")]  #elements in 1st row, 2nd and 3rd columns
----

----
## zwei drei 
##    5    9
----



[source,r]
----
a_matrix[1, ]  #all the first row
----

----
##  ein zwei drei 
##    1    5    9
----

[source,r]
----
a_matrix[, c("zwei", "drei")]  #all the second and third columns
----

----
##       zwei drei
## one      5    9
## two      6   10
## three    7   11
## four     8   12
----


Combining Matrices
^^^^^^^^^^^^^^^^^^

[source,r]
----
(another_matrix <- matrix(seq.int(2, 24, 2), nrow = 4, dimnames = list(c("five", 
    "six", "seven", "eight"), c("vier", "funf", "sechs"))))
----

----
##       vier funf sechs
## five     2   10    18
## six      4   12    20
## seven    6   14    22
## eight    8   16    24
----

[source,r]
----
c(a_matrix, another_matrix)
----

----
##  [1]  1  2  3  4  5  6  7  8  9 10 11 12  2  4  6  8 10 12 14 16 18 20 22
## [24] 24
----



[source,r]
----
cbind(a_matrix, another_matrix)
----

----
##       ein zwei drei vier funf sechs
## one     1    5    9    2   10    18
## two     2    6   10    4   12    20
## three   3    7   11    6   14    22
## four    4    8   12    8   16    24
----

[source,r]
----
rbind(a_matrix, another_matrix)
----

----
##       ein zwei drei
## one     1    5    9
## two     2    6   10
## three   3    7   11
## four    4    8   12
## five    2   10   18
## six     4   12   20
## seven   6   14   22
## eight   8   16   24
----


Array Arithmetic
^^^^^^^^^^^^^^^^

[source,r]
----
a_matrix + another_matrix
----

----
##       ein zwei drei
## one     3   15   27
## two     6   18   30
## three   9   21   33
## four   12   24   36
----

[source,r]
----
a_matrix * another_matrix
----

----
##       ein zwei drei
## one     2   50  162
## two     8   72  200
## three  18   98  242
## four   32  128  288
----



[source,r]
----
(another_matrix <- matrix(1:12, nrow = 2))
a_matrix + another_matrix  #adding non-conformable matrices throws an error
----



[source,r]
----
t(a_matrix)
----

----
##      one two three four
## ein    1   2     3    4
## zwei   5   6     7    8
## drei   9  10    11   12
----



[source,r]
----
a_matrix %*% t(a_matrix)  #inner multiplication
----

----
##       one two three four
## one   107 122   137  152
## two   122 140   158  176
## three 137 158   179  200
## four  152 176   200  224
----

[source,r]
----
1:3 %o% 4:6  #outer multiplication
----

----
##      [,1] [,2] [,3]
## [1,]    4    5    6
## [2,]    8   10   12
## [3,]   12   15   18
----

[source,r]
----
outer(1:3, 4:6)  #same
----

----
##      [,1] [,2] [,3]
## [1,]    4    5    6
## [2,]    8   10   12
## [3,]   12   15   18
----



[source,r]
----
(m <- matrix(c(1, 0, 1, 5, -3, 1, 2, 4, 7), nrow = 3))
----

----
##      [,1] [,2] [,3]
## [1,]    1    5    2
## [2,]    0   -3    4
## [3,]    1    1    7
----

[source,r]
----
m^-1
----

----
##      [,1]    [,2]   [,3]
## [1,]    1  0.2000 0.5000
## [2,]  Inf -0.3333 0.2500
## [3,]    1  1.0000 0.1429
----

[source,r]
----
(inverse_of_m <- solve(m))
----

----
##      [,1] [,2] [,3]
## [1,]  -25  -33   26
## [2,]    4    5   -4
## [3,]    3    4   -3
----

[source,r]
----
m %*% inverse_of_m
----

----
##      [,1] [,2] [,3]
## [1,]    1    0    0
## [2,]    0    1    0
## [3,]    0    0    1
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Lists And Data Frames
---------------------
Chapter Goals
~~~~~~~~~~~~~
Lists
~~~~~
Creating Lists
^^^^^^^^^^^^^^

[source,r]
----
(a_list <- list(
  c(1, 1, 2, 5, 14, 42),    #See http://oeis.org/A000108
  month.abb, 
  matrix(c(3, -8, 1, -3), nrow = 2),
  asin
))
----

----
## [[1]]
## [1]  1  1  2  5 14 42
## 
## [[2]]
##  [1] "Jan" "Feb" "Mar" "Apr" "May" "Jun" "Jul" "Aug" "Sep" "Oct" "Nov"
## [12] "Dec"
## 
## [[3]]
##      [,1] [,2]
## [1,]    3    1
## [2,]   -8   -3
## 
## [[4]]
## function (x)  .Primitive("asin")
----



[source,r]
----
names(a_list) <- c("catalan", "months", "involutary", "arcsin")
a_list
----

----
## $catalan
## [1]  1  1  2  5 14 42
## 
## $months
##  [1] "Jan" "Feb" "Mar" "Apr" "May" "Jun" "Jul" "Aug" "Sep" "Oct" "Nov"
## [12] "Dec"
## 
## $involutary
##      [,1] [,2]
## [1,]    3    1
## [2,]   -8   -3
## 
## $arcsin
## function (x)  .Primitive("asin")
----

[source,r]
----
(the_same_list <- list(catalan = c(1, 1, 2, 5, 14, 42), months = month.abb, 
    involutary = matrix(c(3, -8, 1, -3), nrow = 2), arcsin = asin))
----

----
## $catalan
## [1]  1  1  2  5 14 42
## 
## $months
##  [1] "Jan" "Feb" "Mar" "Apr" "May" "Jun" "Jul" "Aug" "Sep" "Oct" "Nov"
## [12] "Dec"
## 
## $involutary
##      [,1] [,2]
## [1,]    3    1
## [2,]   -8   -3
## 
## $arcsin
## function (x)  .Primitive("asin")
----



[source,r]
----
(main_list <- list(middle_list = list(element_in_middle_list = diag(3), inner_list = list(element_in_inner_list = pi^1:4, 
    another_element_in_inner_list = "a")), element_in_main_list = log10(1:10)))
----

----
## $middle_list
## $middle_list$element_in_middle_list
##      [,1] [,2] [,3]
## [1,]    1    0    0
## [2,]    0    1    0
## [3,]    0    0    1
## 
## $middle_list$inner_list
## $middle_list$inner_list$element_in_inner_list
## [1] 3.142
## 
## $middle_list$inner_list$another_element_in_inner_list
## [1] "a"
## 
## 
## 
## $element_in_main_list
##  [1] 0.0000 0.3010 0.4771 0.6021 0.6990 0.7782 0.8451 0.9031 0.9542 1.0000
----


Atomic and Recursive Variables
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
is.atomic(list())
----

----
## [1] FALSE
----

[source,r]
----
is.recursive(list())
----

----
## [1] TRUE
----

[source,r]
----
is.atomic(numeric())
----

----
## [1] TRUE
----

[source,r]
----
is.recursive(numeric())
----

----
## [1] FALSE
----


List Dimensions and Arithmetic
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
length(a_list)
----

----
## [1] 4
----

[source,r]
----
length(main_list)  #doesn't include the lengths of nested lists
----

----
## [1] 2
----



[source,r]
----
dim(a_list)
----

----
## NULL
----



[source,r]
----
nrow(a_list)
----

----
## NULL
----

[source,r]
----
ncol(a_list)
----

----
## NULL
----

[source,r]
----
NROW(a_list)
----

----
## [1] 4
----

[source,r]
----
NCOL(a_list)
----

----
## [1] 1
----



[source,r]
----
l1 <- list(1:5)
l2 <- list(6:10)
l1[[1]] + l2[[1]]
----

----
## [1]  7  9 11 13 15
----


Indexing Lists
^^^^^^^^^^^^^^

[source,r]
----
l <- list(first = 1, second = 2, third = list(alpha = 3.1, beta = 3.2))
----



[source,r]
----
l[1:2]
----

----
## $first
## [1] 1
## 
## $second
## [1] 2
----

[source,r]
----
l[-3]
----

----
## $first
## [1] 1
## 
## $second
## [1] 2
----

[source,r]
----
l[c("first", "second")]
----

----
## $first
## [1] 1
## 
## $second
## [1] 2
----

[source,r]
----
l[c(TRUE, TRUE, FALSE)]
----

----
## $first
## [1] 1
## 
## $second
## [1] 2
----



[source,r]
----
l[[1]]
----

----
## [1] 1
----

[source,r]
----
l[["first"]]
----

----
## [1] 1
----



[source,r]
----
is.list(l[1])
----

----
## [1] TRUE
----

[source,r]
----
is.list(l[[1]])
----

----
## [1] FALSE
----



[source,r]
----
l$first
----

----
## [1] 1
----

[source,r]
----
l$f  #partial matching interprets 'f' as 'first'
----

----
## [1] 1
----



[source,r]
----
l[["third"]]["beta"]
----

----
## $beta
## [1] 3.2
----

[source,r]
----
l[["third"]][["beta"]]
----

----
## [1] 3.2
----

[source,r]
----
l[[c("third", "beta")]]
----

----
## [1] 3.2
----



[source,r]
----
l[c(4, 2, 5)]
----

----
## $<NA>
## NULL
## 
## $second
## [1] 2
## 
## $<NA>
## NULL
----

[source,r]
----
l[c("fourth", "second", "fifth")]
----

----
## $<NA>
## NULL
## 
## $second
## [1] 2
## 
## $<NA>
## NULL
----



[source,r]
----
l[["fourth"]]
----

----
## NULL
----

[source,r]
----
l$fourth
----

----
## NULL
----



[source,r]
----
l[[4]]  #this throws an error 
----


Converting Between Vectors and Lists
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
busy_beaver <- c(1, 6, 21, 107)  #See http://oeis.org/A060843
as.list(busy_beaver)
----

----
## [[1]]
## [1] 1
## 
## [[2]]
## [1] 6
## 
## [[3]]
## [1] 21
## 
## [[4]]
## [1] 107
----



[source,r]
----
as.numeric(list(1, 6, 21, 107))
----

----
## [1]   1   6  21 107
----



[source,r]
----
(prime_factors <- list(two = 2, three = 3, four = c(2, 2), five = 5, six = c(2, 
    3), seven = 7, eight = c(2, 2, 2), nine = c(3, 3), ten = c(2, 5)))
----

----
## $two
## [1] 2
## 
## $three
## [1] 3
## 
## $four
## [1] 2 2
## 
## $five
## [1] 5
## 
## $six
## [1] 2 3
## 
## $seven
## [1] 7
## 
## $eight
## [1] 2 2 2
## 
## $nine
## [1] 3 3
## 
## $ten
## [1] 2 5
----



[source,r]
----
unlist(prime_factors)
----

----
##    two  three  four1  four2   five   six1   six2  seven eight1 eight2 
##      2      3      2      2      5      2      3      7      2      2 
## eight3  nine1  nine2   ten1   ten2 
##      2      3      3      2      5
----


Combining Lists
^^^^^^^^^^^^^^^

[source,r]
----
c(list(a = 1, b = 2), list(3))
----

----
## $a
## [1] 1
## 
## $b
## [1] 2
## 
## [[3]]
## [1] 3
----



[source,r]
----
c(list(a = 1, b = 2), 3)
----

----
## $a
## [1] 1
## 
## $b
## [1] 2
## 
## [[3]]
## [1] 3
----



[source,r]
----
(matrix_list_hybrid <- cbind(list(a = 1, b = 2), list(c = 3, list(d = 4))))
----

----
##   [,1] [,2]  
## a 1    3     
## b 2    List,1
----

[source,r]
----
str(matrix_list_hybrid)
----

----
## List of 4
##  $ : num 1
##  $ : num 2
##  $ : num 3
##  $ :List of 1
##   ..$ d: num 4
##  - attr(*, "dim")= int [1:2] 2 2
##  - attr(*, "dimnames")=List of 2
##   ..$ : chr [1:2] "a" "b"
##   ..$ : NULL
----


NULL
~~~~

[source,r]
----
(uk_bank_holidays_2013 <- list(Jan = "New Year's Day", Feb = NULL, Mar = "Good Friday", 
    Apr = "Easter Monday", May = c("Early May Bank Holiday", "Spring Bank Holiday"), 
    Jun = NULL, Jul = NULL, Aug = "Summer Bank Holiday", Sep = NULL, Oct = NULL, 
    Nov = NULL, Dec = c("Christmas Day", "Boxing Day")))
----

----
## $Jan
## [1] "New Year's Day"
## 
## $Feb
## NULL
## 
## $Mar
## [1] "Good Friday"
## 
## $Apr
## [1] "Easter Monday"
## 
## $May
## [1] "Early May Bank Holiday" "Spring Bank Holiday"   
## 
## $Jun
## NULL
## 
## $Jul
## NULL
## 
## $Aug
## [1] "Summer Bank Holiday"
## 
## $Sep
## NULL
## 
## $Oct
## NULL
## 
## $Nov
## NULL
## 
## $Dec
## [1] "Christmas Day" "Boxing Day"
----



[source,r]
----
length(NULL)
----

----
## [1] 0
----

[source,r]
----
length(NA)
----

----
## [1] 1
----



[source,r]
----
is.null(NULL)
----

----
## [1] TRUE
----

[source,r]
----
is.null(NA)
----

----
## [1] FALSE
----



[source,r]
----
is.na(NULL)
----

[WARNING]
====
.Warning
is.na() applied to non-(list or vector) of type 'NULL'

====

----
## logical(0)
----



[source,r]
----
uk_bank_holidays_2013$Jan <- NULL
uk_bank_holidays_2013$Feb <- NULL
uk_bank_holidays_2013
----

----
## $Mar
## [1] "Good Friday"
## 
## $Apr
## [1] "Easter Monday"
## 
## $May
## [1] "Early May Bank Holiday" "Spring Bank Holiday"   
## 
## $Jun
## NULL
## 
## $Jul
## NULL
## 
## $Aug
## [1] "Summer Bank Holiday"
## 
## $Sep
## NULL
## 
## $Oct
## NULL
## 
## $Nov
## NULL
## 
## $Dec
## [1] "Christmas Day" "Boxing Day"
----



[source,r]
----
uk_bank_holidays_2013["Aug"] <- list(NULL)
uk_bank_holidays_2013
----

----
## $Mar
## [1] "Good Friday"
## 
## $Apr
## [1] "Easter Monday"
## 
## $May
## [1] "Early May Bank Holiday" "Spring Bank Holiday"   
## 
## $Jun
## NULL
## 
## $Jul
## NULL
## 
## $Aug
## NULL
## 
## $Sep
## NULL
## 
## $Oct
## NULL
## 
## $Nov
## NULL
## 
## $Dec
## [1] "Christmas Day" "Boxing Day"
----


Pairlists
~~~~~~~~~

[source,r]
----
(arguments_of_sd <- formals(sd))
----

----
## $x
## 
## 
## $na.rm
## [1] FALSE
----

[source,r]
----
class(arguments_of_sd)
----

----
## [1] "pairlist"
----



[source,r]
----
pairlist()
----

----
## NULL
----

[source,r]
----
list()
----

----
## list()
----


Data Frames
~~~~~~~~~~~
Creating Data Frames
^^^^^^^^^^^^^^^^^^^^

[source,r]
----
(a_data_frame <- data.frame(x = letters[1:5], y = rnorm(5), z = runif(5) > 0.5))
----

----
##   x        y     z
## 1 a  0.39403 FALSE
## 2 b  0.44723  TRUE
## 3 c  0.06824 FALSE
## 4 d  1.14910 FALSE
## 5 e -0.21998 FALSE
----

[source,r]
----
class(a_data_frame)
----

----
## [1] "data.frame"
----



[source,r]
----
y <- rnorm(5)
names(y) <- month.name[1:5]
data.frame(x = letters[1:5], y = y, z = runif(5) > 0.5)
----

----
##          x       y     z
## January  a -0.4641  TRUE
## February b -0.4518 FALSE
## March    c  0.4774 FALSE
## April    d  1.4138  TRUE
## May      e  0.3977 FALSE
----



[source,r]
----
data.frame(x = letters[1:5], y = y, z = runif(5) > 0.5, row.names = NULL)
----

----
##   x       y     z
## 1 a -0.4641  TRUE
## 2 b -0.4518  TRUE
## 3 c  0.4774 FALSE
## 4 d  1.4138  TRUE
## 5 e  0.3977 FALSE
----



[source,r]
----
data.frame(x = letters[1:5], y = y, z = runif(5) > 0.5, row.names = c("Jackie", 
    "Tito", "Jermaine", "Marlon", "Michael"))
----

----
##          x       y     z
## Jackie   a -0.4641  TRUE
## Tito     b -0.4518 FALSE
## Jermaine c  0.4774  TRUE
## Marlon   d  1.4138 FALSE
## Michael  e  0.3977 FALSE
----



[source,r]
----
rownames(a_data_frame)
----

----
## [1] "1" "2" "3" "4" "5"
----

[source,r]
----
colnames(a_data_frame)
----

----
## [1] "x" "y" "z"
----

[source,r]
----
dimnames(a_data_frame)
----

----
## [[1]]
## [1] "1" "2" "3" "4" "5"
## 
## [[2]]
## [1] "x" "y" "z"
----

[source,r]
----
nrow(a_data_frame)
----

----
## [1] 5
----

[source,r]
----
ncol(a_data_frame)
----

----
## [1] 3
----

[source,r]
----
dim(a_data_frame)
----

----
## [1] 5 3
----



[source,r]
----
length(a_data_frame)
----

----
## [1] 3
----

[source,r]
----
names(a_data_frame)
----

----
## [1] "x" "y" "z"
----



[source,r]
----
data.frame(        #lengths 1, 2 and 4 are OK
  x = 1,           #recycled 4 times
  y = 2:3,         #recycled twice
  z = 4:7          #the longest input; no recycling
)
----

----
##   x y z
## 1 1 2 4
## 2 1 3 5
## 3 1 2 6
## 4 1 3 7
----



[source,r]
----
data.frame(       #lengths 1, 2 and 3 cause an error
  x = 1,          #lowest common multiple is 6, which
  y = 2:3,        #is more than 3                                    
  z = 4:6
)
----



[source,r]
----
data.frame(`A column` = letters[1:5], `!@#$%^&*()` = rnorm(5), ... = runif(5) > 
    0.5, check.names = FALSE)
----

----
##   A column !@#$%^&*()  ...
## 1        a     1.1195 TRUE
## 2        b    -0.7356 TRUE
## 3        c    -0.7693 TRUE
## 4        d    -0.4357 TRUE
## 5        e     0.9339 TRUE
----


Indexing Data Frames
^^^^^^^^^^^^^^^^^^^^

[source,r]
----
a_data_frame[2:3, -3]
----

----
##   x       y
## 2 b 0.44723
## 3 c 0.06824
----

[source,r]
----
a_data_frame[c(FALSE, TRUE, TRUE, FALSE, FALSE), c("x", "y")]
----

----
##   x       y
## 2 b 0.44723
## 3 c 0.06824
----



[source,r]
----
class(a_data_frame[2:3, -3])
----

----
## [1] "data.frame"
----

[source,r]
----
class(a_data_frame[2:3, 1])
----

----
## [1] "factor"
----



[source,r]
----
a_data_frame$x[2:3]
----

----
## [1] b c
## Levels: a b c d e
----

[source,r]
----
a_data_frame[[1]][2:3]
----

----
## [1] b c
## Levels: a b c d e
----

[source,r]
----
a_data_frame[["x"]][2:3]
----

----
## [1] b c
## Levels: a b c d e
----



[source,r]
----
a_data_frame[a_data_frame$y > 0 | a_data_frame$z, "x"]
----

----
## [1] a b c d
## Levels: a b c d e
----

[source,r]
----
subset(a_data_frame, y > 0 | z, x)
----

----
##   x
## 1 a
## 2 b
## 3 c
## 4 d
----


Basic Data Frame Manipulation
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
t(a_data_frame)
----

----
##   [,1]       [,2]       [,3]       [,4]       [,5]      
## x "a"        "b"        "c"        "d"        "e"       
## y " 0.39403" " 0.44723" " 0.06824" " 1.14910" "-0.21998"
## z "FALSE"    " TRUE"    "FALSE"    "FALSE"    "FALSE"
----



[source,r]
----
another_data_frame <- data.frame(  #same cols as a_data_frame, different order
  z = rlnorm(5),       #log-normally distributed numbers
  y = sample(5),       #the numbers 1 to 5, in some order
  x = letters[3:7]
)
rbind(a_data_frame, another_data_frame) 
----

----
##    x        y      z
## 1  a  0.39403 0.0000
## 2  b  0.44723 1.0000
## 3  c  0.06824 0.0000
## 4  d  1.14910 0.0000
## 5  e -0.21998 0.0000
## 6  c  1.00000 0.9088
## 7  d  3.00000 2.6931
## 8  e  2.00000 0.9400
## 9  f  4.00000 0.7106
## 10 g  5.00000 1.3600
----

[source,r]
----
cbind(a_data_frame, another_data_frame)
----

----
##   x        y     z      z y x
## 1 a  0.39403 FALSE 0.9088 1 c
## 2 b  0.44723  TRUE 2.6931 3 d
## 3 c  0.06824 FALSE 0.9400 2 e
## 4 d  1.14910 FALSE 0.7106 4 f
## 5 e -0.21998 FALSE 1.3600 5 g
----



[source,r]
----
merge(a_data_frame, another_data_frame, by = "x")
----

----
##   x      y.x   z.x    z.y y.y
## 1 c  0.06824 FALSE 0.9088   1
## 2 d  1.14910 FALSE 2.6931   3
## 3 e -0.21998 FALSE 0.9400   2
----

[source,r]
----
merge(a_data_frame, another_data_frame, by = "x", all = TRUE)
----

----
##   x      y.x   z.x    z.y y.y
## 1 a  0.39403 FALSE     NA  NA
## 2 b  0.44723  TRUE     NA  NA
## 3 c  0.06824 FALSE 0.9088   1
## 4 d  1.14910 FALSE 2.6931   3
## 5 e -0.21998 FALSE 0.9400   2
## 6 f       NA    NA 0.7106   4
## 7 g       NA    NA 1.3600   5
----



[source,r]
----
colSums(a_data_frame[, 2:3])
----

----
##     y     z 
## 1.839 1.000
----

[source,r]
----
colMeans(a_data_frame[, 2:3])
----

----
##      y      z 
## 0.3677 0.2000
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
list(alpha = 1, list(beta = 2, gamma = 3, delta = 4), eta = NULL)
----

----
## $alpha
## [1] 1
## 
## [[2]]
## [[2]]$beta
## [1] 2
## 
## [[2]]$gamma
## [1] 3
## 
## [[2]]$delta
## [1] 4
## 
## 
## $eta
## NULL
----


Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Environments and Functions
--------------------------
Chapter Goals
~~~~~~~~~~~~~
Environments
~~~~~~~~~~~~

[source,r]
----
an_environment <- new.env()
----



[source,r]
----
an_environment[["pythag"]] <- c(12, 15, 20, 21)  #See http://oeis.org/A156683
an_environment$root <- polyroot(c(6, -5, 1))
----



[source,r]
----
assign("moonday", weekdays(as.Date("1969/07/20")), an_environment)
----



[source,r]
----
an_environment[["pythag"]]
----

----
## [1] 12 15 20 21
----

[source,r]
----
an_environment$root
----

----
## [1] 2+0i 3-0i
----

[source,r]
----
get("moonday", an_environment)
----

----
## [1] "Sunday"
----



[source,r]
----
ls(envir = an_environment)
----

----
## [1] "moonday" "pythag"  "root"
----

[source,r]
----
ls.str(envir = an_environment)
----

----
## moonday :  chr "Sunday"
## pythag :  num [1:4] 12 15 20 21
## root :  cplx [1:2] 2+0i 3-0i
----



[source,r]
----
exists("pythag", an_environment)
----

----
## [1] TRUE
----



[source,r]
----
# Convert to list
(a_list <- as.list(an_environment))
----

----
## $pythag
## [1] 12 15 20 21
## 
## $moonday
## [1] "Sunday"
## 
## $root
## [1] 2+0i 3-0i
----

[source,r]
----
# ... and back again.  Both lines of code do the same thing
as.environment(a_list)
----

----
## <environment: 0x000000000b1a3630>
----

[source,r]
----
list2env(a_list)
----

----
## <environment: 0x000000000b11fbb0>
----



[source,r]
----
nested_environment <- new.env(parent = an_environment)
exists("pythag", nested_environment)
----

----
## [1] TRUE
----

[source,r]
----
exists("pythag", nested_environment, inherits = FALSE)
----

----
## [1] FALSE
----


[NOTE]
====
The word ``frame'' is used almost interchangeably with ``environment''.  (See section 2.1.10 of the R Language Definition manual that ships with R for the technicalities.)  This means that some functions that work with environments have `frame'' in their name, +parent.frame+ being the most common of these.
====

[source,r]
----
non_stormers <<- c(3, 7, 8, 13, 17, 18, 21)  #See http://oeis.org/A002312
get("non_stormers", envir = globalenv())
----

----
## [1]  3  7  8 13 17 18 21
----

[source,r]
----
head(ls(envir = baseenv()), 20)
----

----
##  [1] "-"                 "-.Date"            "-.POSIXt"         
##  [4] "!"                 "!.hexmode"         "!.octmode"        
##  [7] "!="                "$"                 "$.data.frame"     
## [10] "$.DLLInfo"         "$.package_version" "$<-"              
## [13] "$<-.data.frame"    "%%"                "%*%"              
## [16] "%/%"               "%in%"              "%o%"              
## [19] "%x%"               "&"
----


Functions
~~~~~~~~~
Creating and Calling Functions
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
rt
----

----
## function (n, df, ncp) 
## {
##     if (missing(ncp)) 
##         .External(C_rt, n, df)
##     else rnorm(n, ncp)/sqrt(rchisq(n, df)/df)
## }
## <bytecode: 0x000000000bb6b3a8>
## <environment: namespace:stats>
----


[NOTE]
====
The difference between arguments and formal arguments isn't very important, so the rest of the book doesn't make an effort to differentiate between the two concepts.  
====

[source,r]
----
hypotenuse <- function(x, y) {
    sqrt(x^2 + y^2)
}
----



[source,r]
----
hypotenuse <- function(x, y) sqrt(x^2 + y^2)  #same as before
----


[NOTE]
====
R is very permissive with how you can space your code, so ``one line of code'' can be stretched to run over several lines.  The amount of code that can be included without braces is one statement.  The exact definition of a statement is technical, but from a practical point of view, it is how much you can type at the command line before it executes.
====

[source,r]
----
hypotenuse(3, 4)
----

----
## [1] 5
----

[source,r]
----
hypotenuse(y = 24, x = 7)
----

----
## [1] 25
----



[source,r]
----
hypotenuse <- function(x = 5, y = 12) {
    sqrt(x^2 + y^2)
}
hypotenuse()  #equivalent to hypotenuse(5, 12)
----

----
## [1] 13
----



[source,r]
----
formals(hypotenuse)
----

----
## $x
## [1] 5
## 
## $y
## [1] 12
----

[source,r]
----
args(hypotenuse)
----

----
## function (x = 5, y = 12) 
## NULL
----

[source,r]
----
formalArgs(hypotenuse)
----

----
## [1] "x" "y"
----



[source,r]
----
(body_of_hypotenuse <- body(hypotenuse))
----

----
## {
##     sqrt(x^2 + y^2)
## }
----

[source,r]
----
deparse(body_of_hypotenuse)
----

----
## [1] "{"                   "    sqrt(x^2 + y^2)" "}"
----



[source,r]
----
normalize <- function(x, m = mean(x), s = sd(x)) {
    (x - m)/s
}
normalized <- normalize(c(1, 3, 6, 10, 15))
mean(normalized)  #almost 0!
----

----
## [1] -5.573e-18
----

[source,r]
----
sd(normalized)
----

----
## [1] 1
----



[source,r]
----
normalize(c(1, 3, 6, 10, NA))
----

----
## [1] NA NA NA NA NA
----



[source,r]
----
normalize <- function(x, m = mean(x, na.rm = na.rm), s = sd(x, na.rm = na.rm), 
    na.rm = FALSE) {
    (x - m)/s
}
normalize(c(1, 3, 6, 10, NA))
----

----
## [1] NA NA NA NA NA
----

[source,r]
----
normalize(c(1, 3, 6, 10, NA), na.rm = TRUE)
----

----
## [1] -1.0215 -0.5108  0.2554  1.2769      NA
----



[source,r]
----
normalize <- function(x, m = mean(x, ...), s = sd(x, ...), ...) {
    (x - m)/s
}
normalize(c(1, 3, 6, 10, NA))
----

----
## [1] NA NA NA NA NA
----

[source,r]
----
normalize(c(1, 3, 6, 10, NA), na.rm = TRUE)
----

----
## [1] -1.0215 -0.5108  0.2554  1.2769      NA
----


Passing Functions To and From Other Functions
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
do.call(hypotenuse, list(x = 3, y = 4))  #same as hypotenuse(3, 4)
----

----
## [1] 5
----



[source,r]
----
dfr1 <- data.frame(x = 1:5, y = rt(5, 1))
dfr2 <- data.frame(x = 6:10, y = rf(5, 1, 1))
dfr3 <- data.frame(x = 11:15, y = rbeta(5, 1, 1))
do.call(rbind, list(dfr1, dfr2, dfr3))  #same as rbind(dfr1, dfr2, dfr3)
----

----
##     x          y
## 1   1  3.242e+00
## 2   2 -3.329e-01
## 3   3  5.344e-01
## 4   4  2.481e+00
## 5   5  1.313e+01
## 6   6  8.355e-03
## 7   7  5.661e-01
## 8   8  1.063e-01
## 9   9  5.187e-01
## 10 10  3.933e-05
## 11 11  1.877e-01
## 12 12  7.893e-01
## 13 13  6.127e-02
## 14 14  2.583e-01
## 15 15  9.402e-01
----



[source,r]
----
menage <- c(1, 0, 0, 1, 2, 13, 80)  #See http://oeis.org/A000179
mean(menage)
----

----
## [1] 13.86
----



[source,r]
----
mean(c(1, 0, 0, 1, 2, 13, 80))
----

----
## [1] 13.86
----



[source,r]
----
x_plus_y <- function(x, y) x + y
do.call(x_plus_y, list(1:5, 5:1))
----

----
## [1] 6 6 6 6 6
----

[source,r]
----
# is the same as
do.call(function(x, y) x + y, list(1:5, 5:1))
----

----
## [1] 6 6 6 6 6
----



[source,r]
----
(emp_cum_dist_fn <- ecdf(rnorm(50)))
----

----
## Empirical CDF 
## Call: ecdf(rnorm(50))
##  x[1:50] = -2.8, -2.3,  -2,  ..., 2.1, 2.3
----

[source,r]
----
is.function(emp_cum_dist_fn)
----

----
## [1] TRUE
----

[source,r]
----
plot(emp_cum_dist_fn)
----
.An empirical cumulative distribution function.
image::figure/ecdf.png[An empirical cumulative distribution function.,align=default]

Variable Scope
^^^^^^^^^^^^^^



[source,r]
----
f <- function(x) {
    y <- 1
    g <- function(x) {
        (x + y)/2  #y is used, but is not a formal argument of g.
    }
    g(x)
}
f(sqrt(5))  #It works! y is magically found in the environment of f
----

----
## [1] 1.618
----



[source,r]
----
f <- function(x) {
    y <- 1
    g(x)
}
g <- function(x) {
    (x + y)/2
}
f(sqrt(5))
----

----
##  January February    March    April      May 
##   0.8860   0.8921   1.3567   1.8249   1.3169
----



[source,r]
----
h <- function(x) {
    x * y
}
----



[source,r]
----
h(9)
----

----
##  January February    March    April      May 
##   -4.177   -4.066    4.297   12.724    3.579
----



[source,r]
----
y <- 16
h(9)
----

----
## [1] 144
----



[source,r]
----
h2 <- function(x) {
    if (runif(1) > 0.5) 
        y <- 12
    x * y
}
----



[source,r]
----
replicate(10, h2(9))
----

----
##  [1] 144 144 108 144 144 144 144 144 108 108
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Strings and Factors
-------------------
Chapter Goals
~~~~~~~~~~~~~
Strings
~~~~~~~
Constructing and Printing Strings
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
c("You should use double quotes most of the time", "Single quotes are better for including \" inside the string")
----

----
## [1] "You should use double quotes most of the time"              
## [2] "Single quotes are better for including \" inside the string"
----



[source,r]
----
paste(c("red", "yellow"), "lorry")
----

----
## [1] "red lorry"    "yellow lorry"
----

[source,r]
----
paste(c("red", "yellow"), "lorry", sep = "-")
----

----
## [1] "red-lorry"    "yellow-lorry"
----

[source,r]
----
paste(c("red", "yellow"), "lorry", collapse = ", ")
----

----
## [1] "red lorry, yellow lorry"
----

[source,r]
----
paste0(c("red", "yellow"), "lorry")
----

----
## [1] "redlorry"    "yellowlorry"
----



[source,r]
----
x <- (1:15)^2
toString(x)
----

----
## [1] "1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144, 169, 196, 225"
----

[source,r]
----
toString(x, width = 40)
----

----
## [1] "1, 4, 9, 16, 25, 36, 49, 64, 81, 100...."
----



[source,r]
----
cat(c("red", "yellow"), "lorry")
----

----
## red yellow lorry
----



[source,r]
----
x <- c("I", "saw", "a", "saw", "that", "could", "out", "saw", "any", "other", 
    "saw", "I", "ever", "saw")
y <- noquote(x)
x
----

----
##  [1] "I"     "saw"   "a"     "saw"   "that"  "could" "out"   "saw"  
##  [9] "any"   "other" "saw"   "I"     "ever"  "saw"
----

[source,r]
----
y
----

----
##  [1] I     saw   a     saw   that  could out   saw   any   other saw  
## [12] I     ever  saw
----


Formatting Numbers
^^^^^^^^^^^^^^^^^^

[source,r]
----
pow <- 1:3
(powers_of_e <- exp(pow))
----

----
## [1]  2.718  7.389 20.086
----

[source,r]
----
formatC(powers_of_e)
----

----
## [1] "2.718" "7.389" "20.09"
----

[source,r]
----
formatC(powers_of_e, digits = 3)  #3 sig figs
----

----
## [1] "2.72" "7.39" "20.1"
----

[source,r]
----
formatC(powers_of_e, digits = 3, width = 10)  #preceding spaces
----

----
## [1] "      2.72" "      7.39" "      20.1"
----

[source,r]
----
formatC(powers_of_e, digits = 3, format = "e")  #scientific formatting
----

----
## [1] "2.718e+00" "7.389e+00" "2.009e+01"
----

[source,r]
----
formatC(powers_of_e, digits = 3, flag = "+")  #precede +ve values with +
----

----
## [1] "+2.72" "+7.39" "+20.1"
----



[source,r]
----
sprintf("%s %d = %f", "Euler's constant to the power", pow, powers_of_e)
----

----
## [1] "Euler's constant to the power 1 = 2.718282" 
## [2] "Euler's constant to the power 2 = 7.389056" 
## [3] "Euler's constant to the power 3 = 20.085537"
----

[source,r]
----
sprintf("To three decimal places, e ^ %d = %.3f", pow, powers_of_e)
----

----
## [1] "To three decimal places, e ^ 1 = 2.718" 
## [2] "To three decimal places, e ^ 2 = 7.389" 
## [3] "To three decimal places, e ^ 3 = 20.086"
----

[source,r]
----
sprintf("In scientific notation, e ^ %d = %e", pow, powers_of_e)
----

----
## [1] "In scientific notation, e ^ 1 = 2.718282e+00"
## [2] "In scientific notation, e ^ 2 = 7.389056e+00"
## [3] "In scientific notation, e ^ 3 = 2.008554e+01"
----



[source,r]
----
format(powers_of_e)
----

----
## [1] " 2.718" " 7.389" "20.086"
----

[source,r]
----
format(powers_of_e, digits = 3)  #at least 3 sig figs
----

----
## [1] " 2.72" " 7.39" "20.09"
----

[source,r]
----
format(powers_of_e, digits = 3, trim = TRUE)  #remove leading zeroes
----

----
## [1] "2.72"  "7.39"  "20.09"
----

[source,r]
----
format(powers_of_e, digits = 3, scientific = TRUE)
----

----
## [1] "2.72e+00" "7.39e+00" "2.01e+01"
----

[source,r]
----
prettyNum(c(1e+10, 1e-20), big.mark = ",", small.mark = " ", preserve.width = "individual", 
    scientific = FALSE)
----

----
## [1] "10,000,000,000"            "0.00000 00000 00000 00001"
----


Special Characters
^^^^^^^^^^^^^^^^^^

[source,r]
----
cat("foo\tbar", fill = TRUE)
----

----
## foo	bar
----



[source,r]
----
cat("foo\nbar", fill = TRUE)
----

----
## foo
## bar
----



[source,r]
----
cat("foo\0bar", fill = TRUE)  #this throws an error
----



[source,r]
----
cat("foo\\bar", fill = TRUE)
----

----
## foo\bar
----



[source,r]
----
cat("foo\"bar", fill = TRUE)
----

----
## foo"bar
----

[source,r]
----
cat("foo'bar", fill = TRUE)
----

----
## foo'bar
----



[source,r]
----
cat("foo'bar", fill = TRUE)
----

----
## foo'bar
----

[source,r]
----
cat("foo\"bar", fill = TRUE)
----

----
## foo"bar
----



[source,r]
----
cat("\a")
alarm()
----


Changing Case
^^^^^^^^^^^^^

[source,r]
----
toupper("I'm Shouting")
----

----
## [1] "I'M SHOUTING"
----

[source,r]
----
tolower("I'm Whispering")
----

----
## [1] "i'm whispering"
----


Extracting Substrings
^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
woodchuck <- c("How much wood would a woodchuck chuck", "If a woodchuck could chuck wood?", 
    "He would chuck, he would, as much as he could", "And chuck as much wood as a woodchuck would", 
    "If a woodchuck could chuck wood.")
substring(woodchuck, 1:6, 10)
----

----
## [1] "How much w" "f a woodc"  " would c"   " chuck "    " woodc"    
## [6] "uch w"
----

[source,r]
----
substr(woodchuck, 1:6, 10)
----

----
## [1] "How much w" "f a woodc"  " would c"   " chuck "    " woodc"
----


Splitting Strings
^^^^^^^^^^^^^^^^^

[source,r]
----
strsplit(woodchuck, " ", fixed = TRUE)
----

----
## [[1]]
## [1] "How"       "much"      "wood"      "would"     "a"         "woodchuck"
## [7] "chuck"    
## 
## [[2]]
## [1] "If"        "a"         "woodchuck" "could"     "chuck"     "wood?"    
## 
## [[3]]
##  [1] "He"     "would"  "chuck," "he"     "would," "as"     "much"  
##  [8] "as"     "he"     "could" 
## 
## [[4]]
## [1] "And"       "chuck"     "as"        "much"      "wood"      "as"       
## [7] "a"         "woodchuck" "would"    
## 
## [[5]]
## [1] "If"        "a"         "woodchuck" "could"     "chuck"     "wood."
----



[source,r]
----
strsplit(woodchuck, ",? ")
----

----
## [[1]]
## [1] "How"       "much"      "wood"      "would"     "a"         "woodchuck"
## [7] "chuck"    
## 
## [[2]]
## [1] "If"        "a"         "woodchuck" "could"     "chuck"     "wood?"    
## 
## [[3]]
##  [1] "He"    "would" "chuck" "he"    "would" "as"    "much"  "as"   
##  [9] "he"    "could"
## 
## [[4]]
## [1] "And"       "chuck"     "as"        "much"      "wood"      "as"       
## [7] "a"         "woodchuck" "would"    
## 
## [[5]]
## [1] "If"        "a"         "woodchuck" "could"     "chuck"     "wood."
----


File paths
^^^^^^^^^^



[source,r]
----
getwd()
----

----
## [1] "d:/workspace/LearningR/build/vignettes"
----

[source,r]
----
setwd("c:/windows")
getwd()
----

----
## [1] "c:/windows"
----



[source,r]
----
"c:\\windows"  #remember to double up the slashes
"\\\\myserver\\mydir"  #UNC names need four slashes at the start
----



[source,r]
----
file.path("c:", "Program Files", "R", "R-devel")
----

----
## [1] "c:/Program Files/R/R-devel"
----

[source,r]
----
R.home()  #Same place: a shortcut to the R installation dir
----

----
## [1] "C:/PROGRA~1/R/R-devel"
----



[source,r]
----
path.expand(".")
----

----
## [1] "."
----

[source,r]
----
path.expand("..")
----

----
## [1] ".."
----

[source,r]
----
path.expand("~")
----

----
## [1] "C:\\Users\\richie\\Documents"
----



[source,r]
----
file_name <- "C:/Program Files/R/R-devel/bin/x64/RGui.exe"
basename(file_name)
----

----
## [1] "RGui.exe"
----

[source,r]
----
dirname(file_name)
----

----
## [1] "C:/Program Files/R/R-devel/bin/x64"
----




Factors
~~~~~~~
Creating Factors
^^^^^^^^^^^^^^^^

[source,r]
----
(heights <- data.frame(height_cm = c(153, 181, 150, 172, 165, 149, 174, 169, 
    198, 163), gender = c("female", "male", "female", "male", "male", "female", 
    "female", "male", "male", "female")))
----

----
##    height_cm gender
## 1        153 female
## 2        181   male
## 3        150 female
## 4        172   male
## 5        165   male
## 6        149 female
## 7        174 female
## 8        169   male
## 9        198   male
## 10       163 female
----



[source,r]
----
class(heights$gender)
----

----
## [1] "factor"
----



[source,r]
----
heights$gender
----

----
##  [1] female male   female male   male   female female male   male   female
## Levels: female male
----



[source,r]
----
heights$gender[1] <- "Female"  #notice the capital 'F'
----

[WARNING]
====
.Warning
invalid factor level, NA generated

====

[source,r]
----
heights$gender
----

----
##  [1] <NA>   male   female male   male   female female male   male   female
## Levels: female male
----



[source,r]
----
levels(heights$gender)
----

----
## [1] "female" "male"
----



[source,r]
----
nlevels(heights$gender)
----

----
## [1] 2
----



[source,r]
----
gender_char <- c("female", "male", "female", "male", "male", "female", "female", 
    "male", "male", "female")
(gender_fac <- factor(gender_char))
----

----
##  [1] female male   female male   male   female female male   male   female
## Levels: female male
----


Changing Factor Levels
^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
factor(gender_char, levels = c("male", "female"))
----

----
##  [1] female male   female male   male   female female male   male   female
## Levels: male female
----



[source,r]
----
factor(gender_fac, levels = c("male", "female"))
----

----
##  [1] female male   female male   male   female female male   male   female
## Levels: male female
----


[WARNING]
====
What we shouldn't do is directly change the levels using the +levels+ function.  This will relabel each level, changing data values, which is usually undesirable.
====

[source,r]
----
levels(gender_fac) <- c("male", "female")
gender_fac
----

----
##  [1] male   female male   female female male   male   female female male  
## Levels: male female
----



[source,r]
----
relevel(gender_fac, "male")
----

----
##  [1] male   female male   female female male   male   female female male  
## Levels: male female
----


Dropping Factor Levels
^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
getting_to_work <- data.frame(mode = c("bike", "car", "bus", "car", "walk", 
    "bike", "car", "bike", "car", "car"), time_mins = c(25, 13, NA, 22, 65, 
    28, 15, 24, NA, 14))
----



[source,r]
----
(getting_to_work <- subset(getting_to_work, !is.na(time_mins)))
----

----
##    mode time_mins
## 1  bike        25
## 2   car        13
## 4   car        22
## 5  walk        65
## 6  bike        28
## 7   car        15
## 8  bike        24
## 10  car        14
----



[source,r]
----
unique(getting_to_work$mode)
----

----
## [1] bike car  walk
## Levels: bike bus car walk
----



[source,r]
----
getting_to_work$mode <- droplevels(getting_to_work$mode)
getting_to_work <- droplevels(getting_to_work)
levels(getting_to_work$mode)
----

----
## [1] "bike" "car"  "walk"
----


Ordered Factors
^^^^^^^^^^^^^^^

[source,r]
----
happy_choices <- c("depressed", "grumpy", "so-so", "cheery", "ecstatic")
happy_values <- sample(happy_choices, 10000, replace = TRUE)
happy_fac <- factor(happy_values, happy_choices)
head(happy_fac)
----

----
## [1] grumpy    ecstatic  depressed cheery    grumpy    so-so    
## Levels: depressed grumpy so-so cheery ecstatic
----



[source,r]
----
happy_ord <- ordered(happy_values, happy_choices)
head(happy_ord)
----

----
## [1] grumpy    ecstatic  depressed cheery    grumpy    so-so    
## Levels: depressed < grumpy < so-so < cheery < ecstatic
----



[source,r]
----
is.factor(happy_ord)
----

----
## [1] TRUE
----

[source,r]
----
is.ordered(happy_fac)
----

----
## [1] FALSE
----


Converting Continuous Variables to be Categorical
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
ages <- 16 + 50 * rbeta(10000, 2, 3)
grouped_ages <- cut(ages, seq.int(16, 66, 10))
head(grouped_ages)
----

----
## [1] (26,36] (36,46] (16,26] (26,36] (36,46] (26,36]
## Levels: (16,26] (26,36] (36,46] (46,56] (56,66]
----

[source,r]
----
table(grouped_ages)
----

----
## grouped_ages
## (16,26] (26,36] (36,46] (46,56] (56,66] 
##    1842    3459    2934    1498     267
----



[source,r]
----
class(ages)
----

----
## [1] "numeric"
----

[source,r]
----
class(grouped_ages)
----

----
## [1] "factor"
----


Converting Categorical Variables to be Continuous
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
dirty <- data.frame(x = c("1.23", "4..56", "7.89"))
----



[source,r]
----
as.numeric(dirty$x)
----

----
## [1] 1 2 3
----



[source,r]
----
as.numeric(as.character(dirty$x))
----

[WARNING]
====
.Warning
NAs introduced by coercion

====

----
## [1] 1.23   NA 7.89
----



[source,r]
----
as.numeric(levels(dirty$x))[as.integer(dirty$x)]
----

[WARNING]
====
.Warning
NAs introduced by coercion

====

----
## [1] 1.23   NA 7.89
----



[source,r]
----
factor_to_numeric <- function(f) {
    as.numeric(levels(f))[as.integer(f)]
}
----


Generating Factor Levels
^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
gl(3, 2)
----

----
## [1] 1 1 2 2 3 3
## Levels: 1 2 3
----

[source,r]
----
gl(3, 2, labels = c("placebo", "drug A", "drug B"))
----

----
## [1] placebo placebo drug A  drug A  drug B  drug B 
## Levels: placebo drug A drug B
----

[source,r]
----
gl(3, 1, 6, labels = c("placebo", "drug A", "drug B"))  #alternating
----

----
## [1] placebo drug A  drug B  placebo drug A  drug B 
## Levels: placebo drug A drug B
----


Combining Factors
^^^^^^^^^^^^^^^^^

[source,r]
----
treatment <- gl(3, 2, labels = c("placebo", "drug A", "drug B"))
gender <- gl(2, 1, 6, labels = c("female", "male"))
interaction(treatment, gender)
----

----
## [1] placebo.female placebo.male   drug A.female  drug A.male   
## [5] drug B.female  drug B.male   
## 6 Levels: placebo.female drug A.female drug B.female ... drug B.male
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
x <- c("Swan swam over the pond, Swim swan swim!", "Swan swam back again - Well swum swan!")
----



[source,r]
----
# n specifies the number of scores to generate. It should be a natural
# number.
three_d6 <- function(n) {
    random_numbers <- matrix(sample(6, 3 * n, replace = TRUE), nrow = 3)
    colSums(random_numbers)
}
----


Flow Control and Loops
----------------------
Chapter Goals
~~~~~~~~~~~~~
Flow Control
~~~~~~~~~~~~
if and else
^^^^^^^^^^^  

[source,r]
----
if (TRUE) message("It was true!")
----

[NOTE]
====
.Message
 It was true!

====

[source,r]
----
if (FALSE) message("It wasn't true!")
----



[source,r]
----
if (NA) message("Who knows if it was true?")
----

[CAUTION]
====
.Error
missing value where TRUE/FALSE needed

====



[source,r]
----
if (is.na(NA)) message("The value is missing!")
----

[NOTE]
====
.Message
 The value is missing!

====



[source,r]
----
if (runif(1) > 0.5) message("This message appears with a 50% chance.")
----



[source,r]
----
x <- 3
if (x > 2) {
    y <- 2 * x
    z <- 3 * y
}
----



[source,r]
----
if (FALSE) {
    message("This won't execute...")
} else {
    message("but this will.")
}
----

[NOTE]
====
.Message
 but this will.

====



[source,r]
----
# if(FALSE) { message('This won't execute...') } else { message('and you'll
# get an error before you reach this.') }
----



[source,r]
----
(r <- round(rnorm(2), 1))
----

----
## [1]  0.4 -0.7
----

[source,r]
----
(x <- r[1]/r[2])
----

----
## [1] -0.5714
----

[source,r]
----
if (is.nan(x)) {
    message("x is missing")
} else if (is.infinite(x)) {
    message("x is infinite")
} else if (x > 0) {
    message("x is positive")
} else if (x < 0) {
    message("x is negative")
} else {
    message("x is zero")
}
----

[NOTE]
====
.Message
 x is negative

====



[source,r]
----
x <- sqrt(-1 + 0)
----

[WARNING]
====
.Warning
NaNs produced

====

[source,r]
----
(reality <- if (Re(x) == 0) "real" else "imaginary")
----

[CAUTION]
====
.Error
missing value where TRUE/FALSE needed

====


Vectorised if
^^^^^^^^^^^^^

[source,r]
----
if (c(TRUE, FALSE)) message("two choices")
----

[WARNING]
====
.Warning
the condition has length > 1 and only the first element will be
## used

====

[NOTE]
====
.Message
 two choices

====



[source,r]
----
ifelse(rbinom(10, 1, 0.5), "Head", "Tail")
----

----
##  [1] "Head" "Head" "Tail" "Head" "Tail" "Tail" "Head" "Head" "Tail" "Tail"
----



[source,r]
----
(yn <- rep.int(c(TRUE, FALSE), 6))
----

----
##  [1]  TRUE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE  TRUE
## [12] FALSE
----

[source,r]
----
ifelse(yn, 1:3, -1:-12)
----

----
##  [1]   1  -2   3  -4   2  -6   1  -8   3 -10   2 -12
----



[source,r]
----
yn[c(3, 6, 9, 12)] <- NA
ifelse(yn, 1:3, -1:-12)
----

----
##  [1]   1  -2  NA  -4   2  NA   1  -8  NA -10   2  NA
----


Multiple Selection
^^^^^^^^^^^^^^^^^^

[source,r]
----
(greek <- switch("gamma", alpha = 1, beta = sqrt(4), gamma = {
    a <- sin(pi/3)
    4 * a^2
}))
----

----
## [1] 3
----



[source,r]
----
(greek <- switch("delta", alpha = 1, beta = sqrt(4), gamma = {
    a <- sin(pi/3)
    4 * a^2
}))
----

----
## NULL
----



[source,r]
----
(greek <- switch("delta", alpha = 1, beta = sqrt(4), gamma = {
    a <- sin(pi/3)
    4 * a^2
}, 4))
----

----
## [1] 4
----



[source,r]
----
switch(3, "first", "second", "third", "fourth")
----

----
## [1] "third"
----



[source,r]
----
switch(as.character(2147483647), `2147483647` = "a big number", "another number")
----

----
## [1] "a big number"
----


Loops
~~~~~   
repeat Loops
^^^^^^^^^^^^

[source,r]
----
repeat {
    message("Happy Groundhog Day!")
}
----



[source,r]
----
repeat {
    message("Happy Groundhog Day!")
    action <- sample(c("Learn French", "Make an ice statue", "Rob a bank", "Win heart of Andie McDowell"), 
        1)
    message("action = ", action)
    if (action == "Win heart of Andie McDowell") 
        break
}
----

[NOTE]
====
.Message
 Happy Groundhog Day! action = Make an ice statue Happy Groundhog Day!
## action = Win heart of Andie McDowell

====



[source,r]
----
repeat {
    message("Happy Groundhog Day!")
    action <- sample(c("Learn French", "Make an ice statue", "Rob a bank", "Win heart of Andie McDowell"), 
        1)
    if (action == "Rob a bank") {
        message("Quietly skipping to the next iteration")
        next
    }
    message("action = ", action)
    if (action == "Win heart of Andie McDowell") 
        break
}
----

[NOTE]
====
.Message
 Happy Groundhog Day! action = Win heart of Andie McDowell

====


while Loops
^^^^^^^^^^^

[source,r]
----
action <- sample(c("Learn French", "Make an ice statue", "Rob a bank", "Win heart of Andie McDowell"), 
    1)
while (action != "Win heart of Andie McDowell") {
    message("Happy Groundhog Day!")
    action <- sample(c("Learn French", "Make an ice statue", "Rob a bank", "Win heart of Andie McDowell"), 
        1)
    message("action = ", action)
}
----

[NOTE]
====
.Message
 Happy Groundhog Day! action = Learn French Happy Groundhog Day! action =
## Rob a bank Happy Groundhog Day! action = Win heart of Andie McDowell

====


for Loops
^^^^^^^^^

[source,r]
----
for (i in 1:5) message("i = ", i)
----

[NOTE]
====
.Message
 i = 1 i = 2 i = 3 i = 4 i = 5

====



[source,r]
----
for (i in 1:5) {
    j <- i^2
    message("j = ", j)
}
----

[NOTE]
====
.Message
 j = 1 j = 4 j = 9 j = 16 j = 25

====



[source,r]
----
for (month in month.name) {
    message("The month of ", month)
}
----

[NOTE]
====
.Message
 The month of January The month of February The month of March The month of
## April The month of May The month of June The month of July The month of
## August The month of September The month of October The month of November
## The month of December

====

[source,r]
----
for (yn in c(TRUE, FALSE, NA)) {
    message("This statement is ", yn)
}
----

[NOTE]
====
.Message
 This statement is TRUE This statement is FALSE This statement is NA

====

[source,r]
----
l <- list(pi, LETTERS[1:5], charToRaw("not as complicated as it looks"), list(TRUE))
for (i in l) {
    print(i)
}
----

----
## [1] 3.142
## [1] "A" "B" "C" "D" "E"
##  [1] 6e 6f 74 20 61 73 20 63 6f 6d 70 6c 69 63 61 74 65 64 20 61 73 20 69
## [24] 74 20 6c 6f 6f 6b 73
## [[1]]
## [1] TRUE
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
two_d6 <- function(n) {
    random_numbers <- matrix(sample(6, 2 * n, replace = TRUE), nrow = 2)
    colSums(random_numbers)
}
----



[source,r]
----
sea_shells <- c("She", "sells", "sea", "shells", "by", "the", "seashore", "The", 
    "shells", "she", "sells", "are", "surely", "seashells", "So", "if", "she", 
    "sells", "shells", "on", "the", "seashore", "I'm", "sure", "she", "sells", 
    "seashore", "shells")
----


Advanced Looping
----------------
Chapter Goals
~~~~~~~~~~~~~
Replication
~~~~~~~~~~~

[source,r]
----
rep(runif(1), 5)
----

----
## [1] 0.04105 0.04105 0.04105 0.04105 0.04105
----

[source,r]
----
replicate(5, runif(1))
----

----
## [1] 0.63653 0.36352 0.99207 0.49827 0.02777
----



[source,r]
----
time_for_commute <- function() {
    # Choose a mode of transport for the day
    mode_of_transport <- sample(c("car", "bus", "train", "bike"), size = 1, 
        prob = c(0.1, 0.2, 0.3, 0.4))
    # Find the time to travel, depending upon mode of transport
    time <- switch(mode_of_transport, car = rlnorm(1, log(30), 0.5), bus = rlnorm(1, 
        log(40), 0.5), train = rnorm(1, 30, 10), bike = rnorm(1, 60, 5))
    names(time) <- mode_of_transport
    time
}
----



[source,r]
----
replicate(5, time_for_commute())
----

----
##  bike train   car train   bus 
## 60.72 39.70 31.26 35.09 62.73
----


Looping Over Lists
~~~~~~~~~~~~~~~~~~

[source,r]
----
prime_factors <- list(two = 2, three = 3, four = c(2, 2), five = 5, six = c(2, 
    3), seven = 7, eight = c(2, 2, 2), nine = c(3, 3), ten = c(2, 5))
head(prime_factors)
----

----
## $two
## [1] 2
## 
## $three
## [1] 3
## 
## $four
## [1] 2 2
## 
## $five
## [1] 5
## 
## $six
## [1] 2 3
## 
## $seven
## [1] 7
----



[source,r]
----
unique_primes <- vector("list", length(prime_factors))
for (i in seq_along(prime_factors)) {
    unique_primes[[i]] <- unique(prime_factors[[i]])
}
names(unique_primes) <- names(prime_factors)
unique_primes
----

----
## $two
## [1] 2
## 
## $three
## [1] 3
## 
## $four
## [1] 2
## 
## $five
## [1] 5
## 
## $six
## [1] 2 3
## 
## $seven
## [1] 7
## 
## $eight
## [1] 2
## 
## $nine
## [1] 3
## 
## $ten
## [1] 2 5
----



[source,r]
----
lapply(prime_factors, unique)
----

----
## $two
## [1] 2
## 
## $three
## [1] 3
## 
## $four
## [1] 2
## 
## $five
## [1] 5
## 
## $six
## [1] 2 3
## 
## $seven
## [1] 7
## 
## $eight
## [1] 2
## 
## $nine
## [1] 3
## 
## $ten
## [1] 2 5
----



[source,r]
----
vapply(prime_factors, length, numeric(1))
----

----
##   two three  four  five   six seven eight  nine   ten 
##     1     1     2     1     2     1     3     2     2
----



[source,r]
----
sapply(prime_factors, unique)  #returns a list
----

----
## $two
## [1] 2
## 
## $three
## [1] 3
## 
## $four
## [1] 2
## 
## $five
## [1] 5
## 
## $six
## [1] 2 3
## 
## $seven
## [1] 7
## 
## $eight
## [1] 2
## 
## $nine
## [1] 3
## 
## $ten
## [1] 2 5
----

[source,r]
----
sapply(prime_factors, length)  #returns a vector
----

----
##   two three  four  five   six seven eight  nine   ten 
##     1     1     2     1     2     1     3     2     2
----

[source,r]
----
sapply(prime_factors, summary)  #returns an array
----

----
##         two three four five  six seven eight nine  ten
## Min.      2     3    2    5 2.00     7     2    3 2.00
## 1st Qu.   2     3    2    5 2.25     7     2    3 2.75
## Median    2     3    2    5 2.50     7     2    3 3.50
## Mean      2     3    2    5 2.50     7     2    3 3.50
## 3rd Qu.   2     3    2    5 2.75     7     2    3 4.25
## Max.      2     3    2    5 3.00     7     2    3 5.00
----



[source,r]
----
sapply(list(), length)
----

----
## list()
----



[source,r]
----
vapply(list(), length, numeric(1))
----

----
## numeric(0)
----



[source,r]
----
r_files <- dir(pattern = "\\.R$")
lapply(r_files, source)
----



[source,r]
----
complemented <- c(2, 3, 6, 18)  #See http://oeis.org/A000614
lapply(complemented, rep.int, times = 4)
----

----
## [[1]]
## [1] 2 2 2 2
## 
## [[2]]
## [1] 3 3 3 3
## 
## [[3]]
## [1] 6 6 6 6
## 
## [[4]]
## [1] 18 18 18 18
----



[source,r]
----
rep4x <- function(x) rep.int(4, times = x)
lapply(complemented, rep4x)
----

----
## [[1]]
## [1] 4 4
## 
## [[2]]
## [1] 4 4 4
## 
## [[3]]
## [1] 4 4 4 4 4 4
## 
## [[4]]
##  [1] 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
----



[source,r]
----
lapply(complemented, function(x) rep.int(4, times = x))
----

----
## [[1]]
## [1] 4 4
## 
## [[2]]
## [1] 4 4 4
## 
## [[3]]
## [1] 4 4 4 4 4 4
## 
## [[4]]
##  [1] 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
----



[source,r]
----
env <- new.env()
env$molien <- c(1, 0, 1, 0, 1, 1, 2, 1, 3)  #See http://oeis.org/A008584
env$larry <- c("Really", "leery", "rarely", "Larry")
eapply(env, length)
----

----
## $molien
## [1] 9
## 
## $larry
## [1] 4
----

[source,r]
----
lapply(env, length)  #same
----

----
## $molien
## [1] 9
## 
## $larry
## [1] 4
----


Looping Over Arrays
~~~~~~~~~~~~~~~~~~~

[source,r]
----
install.packages("matlab")
----


[NOTE]
====
When you load the +matlab+ package, it overrides some functions in the +base+, +stats+ and +utils+ packages to make them behave like their MATLAB counterparts.  After these examples that use the +matlab+ package, you may wish to restore the usual behaviour by unloading the package.  Call +detach("package:matlab")+.
====

[source,r]
----
library(matlab)
----

[NOTE]
====
.Message
 Attaching package: 'matlab'
## 
## The following object is masked from 'package:stats':
## 
## reshape
## 
## The following object is masked from 'package:utils':
## 
## find, fix
## 
## The following object is masked from 'package:base':
## 
## sum

====



[source,r]
----
(magic4 <- magic(4))
----

----
##      [,1] [,2] [,3] [,4]
## [1,]   16    2    3   13
## [2,]    5   11   10    8
## [3,]    9    7    6   12
## [4,]    4   14   15    1
----





[source,r]
----
rowSums(magic4)
----

----
## [1] 34 34 34 34
----



[source,r]
----
apply(magic4, 1, sum)  #same as rowSums
----

----
## [1] 34 34 34 34
----

[source,r]
----
apply(magic4, 1, toString)
----

----
## [1] "16, 2, 3, 13" "5, 11, 10, 8" "9, 7, 6, 12"  "4, 14, 15, 1"
----

[source,r]
----
apply(magic4, 2, toString)
----

----
## [1] "16, 5, 9, 4"  "2, 11, 7, 14" "3, 10, 6, 15" "13, 8, 12, 1"
----



[source,r]
----
(baldwins <- data.frame(name = c("Alec", "Daniel", "Billy", "Stephen"), date_of_birth = c("1958-Apr-03", 
    "1960-Oct-05", "1963-Feb-21", "1966-May-12"), n_spouses = c(2, 3, 1, 1), 
    n_children = c(1, 5, 3, 2), stringsAsFactors = FALSE))
----

----
##      name date_of_birth n_spouses n_children
## 1    Alec   1958-Apr-03         2          1
## 2  Daniel   1960-Oct-05         3          5
## 3   Billy   1963-Feb-21         1          3
## 4 Stephen   1966-May-12         1          2
----

[source,r]
----
apply(baldwins, 1, toString)
----

----
## [1] "Alec, 1958-Apr-03, 2, 1"    "Daniel, 1960-Oct-05, 3, 5" 
## [3] "Billy, 1963-Feb-21, 1, 3"   "Stephen, 1966-May-12, 1, 2"
----

[source,r]
----
apply(baldwins, 2, toString)
----

----
##                                                 name 
##                       "Alec, Daniel, Billy, Stephen" 
##                                        date_of_birth 
## "1958-Apr-03, 1960-Oct-05, 1963-Feb-21, 1966-May-12" 
##                                            n_spouses 
##                                         "2, 3, 1, 1" 
##                                           n_children 
##                                         "1, 5, 3, 2"
----



[source,r]
----
sapply(baldwins, toString)
----

----
##                                                 name 
##                       "Alec, Daniel, Billy, Stephen" 
##                                        date_of_birth 
## "1958-Apr-03, 1960-Oct-05, 1963-Feb-21, 1966-May-12" 
##                                            n_spouses 
##                                         "2, 3, 1, 1" 
##                                           n_children 
##                                         "1, 5, 3, 2"
----



[source,r]
----
sapply(baldwins, range)
----

----
##      name      date_of_birth n_spouses n_children
## [1,] "Alec"    "1958-Apr-03" "1"       "1"       
## [2,] "Stephen" "1966-May-12" "3"       "5"
----


Multiple-Input Apply
~~~~~~~~~~~~~~~~~~~~

[source,r]
----
msg <- function(name, factors) {
    ifelse(length(factors) == 1, paste(name, "is prime"), paste(name, "has factors", 
        toString(factors)))
}
mapply(msg, names(prime_factors), prime_factors)
----

----
##                         two                       three 
##              "two is prime"            "three is prime" 
##                        four                        five 
##     "four has factors 2, 2"             "five is prime" 
##                         six                       seven 
##      "six has factors 2, 3"            "seven is prime" 
##                       eight                        nine 
## "eight has factors 2, 2, 2"     "nine has factors 3, 3" 
##                         ten 
##      "ten has factors 2, 5"
----


Instant Vectorisation
^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
baby_gender_report <- function(gender) {
    switch(gender, male = "It's a boy!", female = "It's a girl!", "Um...")
}
----



[source,r]
----
genders <- c("male", "female", "other")
baby_gender_report(genders)
----





[source,r]
----
vectorised_baby_gender_report <- Vectorize(baby_gender_report)
vectorised_baby_gender_report(genders)
----

----
##           male         female          other 
##  "It's a boy!" "It's a girl!"        "Um..."
----


Split-Apply-Combine
~~~~~~~~~~~~~~~~~~~

[source,r]
----
(frogger_scores <- data.frame(player = rep(c("Tom", "Dick", "Harry"), times = c(2, 
    5, 3)), score = round(rlnorm(10, 8), -1)))
----

----
##    player score
## 1     Tom  1320
## 2     Tom 33730
## 3    Dick  2460
## 4    Dick 20990
## 5    Dick 27260
## 6    Dick  1470
## 7    Dick  1640
## 8   Harry 35190
## 9   Harry   510
## 10  Harry  1900
----



[source,r]
----
(scores_by_player <- with(frogger_scores, split(score, player)))
----

----
## $Dick
## [1]  2460 20990 27260  1470  1640
## 
## $Harry
## [1] 35190   510  1900
## 
## $Tom
## [1]  1320 33730
----



[source,r]
----
(list_of_means_by_player <- lapply(scores_by_player, mean))
----

----
## $Dick
## [1] 10764
## 
## $Harry
## [1] 12533
## 
## $Tom
## [1] 17525
----



[source,r]
----
(mean_by_player <- unlist(list_of_means_by_player))
----

----
##  Dick Harry   Tom 
## 10764 12533 17525
----



[source,r]
----
with(frogger_scores, tapply(score, player, mean))
----

----
##  Dick Harry   Tom 
## 10764 12533 17525
----


[TIP]
====
SQL fans may note split-apply-combine is the same as a +GROUP BY+ operation.
====
The plyr Package
~~~~~~~~~~~~~~~~

[source,r]
----
library(plyr)
llply(prime_factors, unique)
----

----
## $two
## [1] 2
## 
## $three
## [1] 3
## 
## $four
## [1] 2
## 
## $five
## [1] 5
## 
## $six
## [1] 2 3
## 
## $seven
## [1] 7
## 
## $eight
## [1] 2
## 
## $nine
## [1] 3
## 
## $ten
## [1] 2 5
----



[source,r]
----
laply(prime_factors, length)
----

----
## [1] 1 1 2 1 2 1 3 2 2
----

[source,r]
----
laply(list(), length)
----

----
## logical(0)
----



[source,r]
----
raply(5, runif(1))  #array output
----

----
## [1] 0.91805 0.03506 0.85453 0.86435 0.42124
----

[source,r]
----
rlply(5, runif(1))  #list output
----

----
## [[1]]
## [1] 0.03285
## 
## [[2]]
## [1] 0.2682
## 
## [[3]]
## [1] 0.4838
## 
## [[4]]
## [1] 0.02855
## 
## [[5]]
## [1] 0.5647
----

[source,r]
----
rdply(5, runif(1))  #data frame output
----

----
##   .n     V1
## 1  1 0.8438
## 2  2 0.1264
## 3  3 0.2929
## 4  4 0.6615
## 5  5 0.2411
----

[source,r]
----
r_ply(5, runif(1))  #discarded output
----

----
## NULL
----



[source,r]
----
frogger_scores$level <- floor(log(frogger_scores$score))
----



[source,r]
----
ddply(
  frogger_scores, 
  .(player), 
  colwise(mean) #call mean on every column except player.
)
----

----
##   player score level
## 1   Dick 10764 8.000
## 2  Harry 12533 7.667
## 3    Tom 17525 8.500
----

[source,r]
----
ddply(
  frogger_scores, 
  .(player), 
  summarise, 
  mean_score = mean(score), #call mean on score
  max_level  = max(level)   #...and max on level
)
----

----
##   player mean_score max_level
## 1   Dick      10764        10
## 2  Harry      12533        10
## 3    Tom      17525        10
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
wayans <- list(`Dwayne Kim` = list(), `Keenen Ivory` = list("Jolie Ivory Imani", 
    "Nala", "Keenen Ivory Jr", "Bella", "Daphne Ivory"), Damon = list("Damon Jr", 
    "Michael", "Cara Mia", "Kyla"), Kim = list(), Shawn = list("Laila", "Illia", 
    "Marlon"), Marlon = list("Shawn Howell", "Arnai Zachary"), Nadia = list(), 
    Elvira = list("Damien", "Chaunte"), Diedre = list("Craig", "Gregg", "Summer", 
        "Justin", "Jamel"), Vonnie = list())
----



[source,r]
----
state.x77
----

----
##                Population Income Illiteracy Life Exp Murder HS Grad Frost
## Alabama              3615   3624        2.1    69.05   15.1    41.3    20
## Alaska                365   6315        1.5    69.31   11.3    66.7   152
## Arizona              2212   4530        1.8    70.55    7.8    58.1    15
## Arkansas             2110   3378        1.9    70.66   10.1    39.9    65
## California          21198   5114        1.1    71.71   10.3    62.6    20
## Colorado             2541   4884        0.7    72.06    6.8    63.9   166
## Connecticut          3100   5348        1.1    72.48    3.1    56.0   139
## Delaware              579   4809        0.9    70.06    6.2    54.6   103
## Florida              8277   4815        1.3    70.66   10.7    52.6    11
## Georgia              4931   4091        2.0    68.54   13.9    40.6    60
## Hawaii                868   4963        1.9    73.60    6.2    61.9     0
## Idaho                 813   4119        0.6    71.87    5.3    59.5   126
## Illinois            11197   5107        0.9    70.14   10.3    52.6   127
## Indiana              5313   4458        0.7    70.88    7.1    52.9   122
## Iowa                 2861   4628        0.5    72.56    2.3    59.0   140
## Kansas               2280   4669        0.6    72.58    4.5    59.9   114
## Kentucky             3387   3712        1.6    70.10   10.6    38.5    95
## Louisiana            3806   3545        2.8    68.76   13.2    42.2    12
## Maine                1058   3694        0.7    70.39    2.7    54.7   161
## Maryland             4122   5299        0.9    70.22    8.5    52.3   101
## Massachusetts        5814   4755        1.1    71.83    3.3    58.5   103
## Michigan             9111   4751        0.9    70.63   11.1    52.8   125
## Minnesota            3921   4675        0.6    72.96    2.3    57.6   160
## Mississippi          2341   3098        2.4    68.09   12.5    41.0    50
## Missouri             4767   4254        0.8    70.69    9.3    48.8   108
## Montana               746   4347        0.6    70.56    5.0    59.2   155
## Nebraska             1544   4508        0.6    72.60    2.9    59.3   139
## Nevada                590   5149        0.5    69.03   11.5    65.2   188
## New Hampshire         812   4281        0.7    71.23    3.3    57.6   174
## New Jersey           7333   5237        1.1    70.93    5.2    52.5   115
## New Mexico           1144   3601        2.2    70.32    9.7    55.2   120
## New York            18076   4903        1.4    70.55   10.9    52.7    82
## North Carolina       5441   3875        1.8    69.21   11.1    38.5    80
## North Dakota          637   5087        0.8    72.78    1.4    50.3   186
## Ohio                10735   4561        0.8    70.82    7.4    53.2   124
## Oklahoma             2715   3983        1.1    71.42    6.4    51.6    82
## Oregon               2284   4660        0.6    72.13    4.2    60.0    44
## Pennsylvania        11860   4449        1.0    70.43    6.1    50.2   126
## Rhode Island          931   4558        1.3    71.90    2.4    46.4   127
## South Carolina       2816   3635        2.3    67.96   11.6    37.8    65
## South Dakota          681   4167        0.5    72.08    1.7    53.3   172
## Tennessee            4173   3821        1.7    70.11   11.0    41.8    70
## Texas               12237   4188        2.2    70.90   12.2    47.4    35
## Utah                 1203   4022        0.6    72.90    4.5    67.3   137
## Vermont               472   3907        0.6    71.64    5.5    57.1   168
## Virginia             4981   4701        1.4    70.08    9.5    47.8    85
## Washington           3559   4864        0.6    71.72    4.3    63.5    32
## West Virginia        1799   3617        1.4    69.48    6.7    41.6   100
## Wisconsin            4589   4468        0.7    72.48    3.0    54.5   149
## Wyoming               376   4566        0.6    70.29    6.9    62.9   173
##                  Area
## Alabama         50708
## Alaska         566432
## Arizona        113417
## Arkansas        51945
## California     156361
## Colorado       103766
## Connecticut      4862
## Delaware         1982
## Florida         54090
## Georgia         58073
## Hawaii           6425
## Idaho           82677
## Illinois        55748
## Indiana         36097
## Iowa            55941
## Kansas          81787
## Kentucky        39650
## Louisiana       44930
## Maine           30920
## Maryland         9891
## Massachusetts    7826
## Michigan        56817
## Minnesota       79289
## Mississippi     47296
## Missouri        68995
## Montana        145587
## Nebraska        76483
## Nevada         109889
## New Hampshire    9027
## New Jersey       7521
## New Mexico     121412
## New York        47831
## North Carolina  48798
## North Dakota    69273
## Ohio            40975
## Oklahoma        68782
## Oregon          96184
## Pennsylvania    44966
## Rhode Island     1049
## South Carolina  30225
## South Dakota    75955
## Tennessee       41328
## Texas          262134
## Utah            82096
## Vermont          9267
## Virginia        39780
## Washington      66570
## West Virginia   24070
## Wisconsin       54464
## Wyoming         97203
----





[source,r]
----
commute_times <- replicate(1000, time_for_commute())
commute_data <- data.frame(time = commute_times, mode = names(commute_times))
----


Packages
--------
Chapter Goals
~~~~~~~~~~~~~
Loading Packages
~~~~~~~~~~~~~~~~

[source,r]
----
library(lattice)
----



[source,r]
----
dotplot(variety ~ yield | site, data = barley, groups = year)
----
.A dotplot of Immer's barley data using lattice.
image::figure/dotplot.png[A dotplot of Immer's barley data using lattice.,align=default]


[source,r]
----
pkgs <- c("lattice", "utils", "rpart")
for (pkg in pkgs) {
    library(pkg, character.only = TRUE)
}
----



[source,r]
----
if (!require(apackagethatmightnotbeinstalled)) {
    warning("The package 'apackagethatmightnotbeinstalled' is not available.")
    # perhaps try to download it ...
}
----


The Search Path
^^^^^^^^^^^^^^^

[source,r]
----
search()
----

----
##  [1] ".GlobalEnv"        "package:rpart"     "package:lattice"  
##  [4] "package:knitr"     "package:learningr" "package:plyr"     
##  [7] "package:roxygen2"  "package:digest"    "package:devtools" 
## [10] "package:stats"     "package:graphics"  "package:grDevices"
## [13] "package:utils"     "package:datasets"  "package:methods"  
## [16] "Autoloads"         "package:base"
----


Libraries and Installed Packages
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
View(installed.packages())
----


[NOTE]
====
The following explanation is a little bit technical, so don't worry about remembering the minutiae of how R finds its packages.  This information can save you administration effort when you come to upgrade R, or where you have problems with packages loading, but it isn't required for day-to-day use of R.
====

[source,r]
----
R.home("library")  #or
----

----
## [1] "C:/PROGRA~1/R/R-devel/library"
----

[source,r]
----
.Library
----

----
## [1] "C:/PROGRA~1/R/R-devel/library"
----



[source,r]
----
path.expand("~")  #or
----

----
## [1] "C:\\Users\\richie\\Documents"
----

[source,r]
----
Sys.getenv("HOME")
----

----
## [1] "C:\\Users\\richie\\Documents"
----



[source,r]
----
.libPaths()
----

----
## [1] "D:/R/library"                      
## [2] "C:/Program Files/R/R-devel/library"
----


Installing Packages
~~~~~~~~~~~~~~~~~~~

[source,r]
----
View(available.packages())
----



[source,r]
----
install.packages(c("xts", "zoo"), repos = "http://www.stats.bris.ac.uk/R/")
----



[source,r]
----
install.packages(c("xts", "zoo"), lib = "some/other/folder/to/install/to", repos = "http://www.stats.bris.ac.uk/R/")
----



[source,r]
----
setInternet2()
----

[WARNING]
====
.Warning
internet routines were already initialized

====

----
## [1] FALSE
----



[source,r]
----
install.packages(
  "path/to/downloaded/file/xts_0.8-8.tar.gz",
  repos = NULL,       #NULL repo means "package already downloaded"
  type = "source"     #this means build the package now
)

install.packages(
  "path/to/downloaded/file/xts_0.8-8.zip",
  repos = NULL,       #still need this
  type = "win.binary" #Windows only!
)
----



[source,r]
----
install.packages("devtools")
----



[source,r]
----
library(devtools)
install_github("knitr", "yihui")
----


Maintaining Packages
~~~~~~~~~~~~~~~~~~~~

[source,r]
----
update.packages(ask = FALSE)
----



[source,r]
----
remove.packages("zoo")
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Dates and Times
---------------
Chapter Goals
~~~~~~~~~~~~~
Date and Time Classes
~~~~~~~~~~~~~~~~~~~~~
POSIX dates and times
^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
(now_ct <- Sys.time())
----

----
## [1] "2013-09-11 12:38:43 BST"
----



[source,r]
----
class(now_ct)
----

----
## [1] "POSIXct" "POSIXt"
----



[source,r]
----
unclass(now_ct)
----

----
## [1] 1.379e+09
----



[source,r]
----
(now_lt <- as.POSIXlt(now_ct))
----

----
## [1] "2013-09-11 12:38:43 BST"
----

[source,r]
----
class(now_lt)
----

----
## [1] "POSIXlt" "POSIXt"
----

[source,r]
----
unclass(now_lt)
----

----
## $sec
## [1] 43.47
## 
## $min
## [1] 38
## 
## $hour
## [1] 12
## 
## $mday
## [1] 11
## 
## $mon
## [1] 8
## 
## $year
## [1] 113
## 
## $wday
## [1] 3
## 
## $yday
## [1] 253
## 
## $isdst
## [1] 1
## 
## attr(,"tzone")
## [1] ""    "BST" "BST"
----



[source,r]
----
now_lt$sec
----

----
## [1] 43.47
----

[source,r]
----
now_lt[["min"]]
----

----
## [1] 38
----


The Date Class
^^^^^^^^^^^^^^

[source,r]
----
(now_date <- as.Date(now_ct))
----

----
## [1] "2013-09-11"
----

[source,r]
----
class(now_date)
----

----
## [1] "Date"
----

[source,r]
----
unclass(now_date)
----

----
## [1] 15959
----


Other Date Classes
^^^^^^^^^^^^^^^^^^
Conversion To and From Strings
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Parsing Dates
^^^^^^^^^^^^^

[source,r]
----
moon_landings_str <- c("20:17:40 20/07/1969", "06:54:35 19/11/1969", "09:18:11 05/02/1971", 
    "22:16:29 30/07/1971", "02:23:35 21/04/1972", "19:54:57 11/12/1972")
(moon_landings_lt <- strptime(moon_landings_str, "%H:%M:%S %d/%m/%Y", tz = "UTC"))
----

----
## [1] "1969-07-20 20:17:40 UTC" "1969-11-19 06:54:35 UTC"
## [3] "1971-02-05 09:18:11 UTC" "1971-07-30 22:16:29 UTC"
## [5] "1972-04-21 02:23:35 UTC" "1972-12-11 19:54:57 UTC"
----



[source,r]
----
strptime(moon_landings_str, "%H:%M:%S %d-%m-%Y", tz = "UTC")
----

----
## [1] NA NA NA NA NA NA
----


Formatting Dates
^^^^^^^^^^^^^^^^

[source,r]
----
strftime(now_ct, "It's %I:%M%p on %A %d %B, %Y.")
----

----
## [1] "It's 12:38PM on Wednesday 11 September, 2013."
----


Time Zones
~~~~~~~~~~

[source,r]
----
strftime(now_ct, tz = "America/Los_Angeles")
----

----
## [1] "2013-09-11 04:38:43"
----

[source,r]
----
strftime(now_ct, tz = "Africa/Brazzaville")
----

----
## [1] "2013-09-11 12:38:43"
----

[source,r]
----
strftime(now_ct, tz = "Asia/Kolkata")
----

----
## [1] "2013-09-11 17:08:43"
----

[source,r]
----
strftime(now_ct, tz = "Australia/Adelaide")
----

----
## [1] "2013-09-11 21:08:43"
----



[source,r]
----
strftime(now_ct, tz = "UTC-5")
----

[WARNING]
====
.Warning
unknown timezone 'UTC-5'

====

----
## [1] "2013-09-11 16:38:43"
----

[source,r]
----
strftime(now_ct, tz = "GMT-5")  #same
----

[WARNING]
====
.Warning
unknown timezone 'GMT-5'

====

----
## [1] "2013-09-11 16:38:43"
----

[source,r]
----
strftime(now_ct, tz = "-5")  #same, if supported on your OS
----

[WARNING]
====
.Warning
unknown timezone '-5'

====

----
## [1] "2013-09-11 16:38:43"
----

[source,r]
----
strftime(now_ct, tz = "UTC+2:30")
----

[WARNING]
====
.Warning
unknown timezone 'UTC+2:30'

====

----
## [1] "2013-09-11 09:08:43"
----



[source,r]
----
strftime(now_ct, tz = "EST")  #Canadian eastern standard time
----

----
## [1] "2013-09-11 06:38:43"
----

[source,r]
----
strftime(now_ct, tz = "PST8PDT")  #Pacific standard time w/ daylight saving
----

----
## [1] "2013-09-11 04:38:43"
----



[source,r]
----
strftime(now_ct, tz = "Asia/Tokyo")
----

----
## [1] "2013-09-11 20:38:43"
----

[source,r]
----
strftime(now_lt, tz = "Asia/Tokyo")  #no zone change!
----

----
## [1] "2013-09-11 12:38:43"
----

[source,r]
----
strftime(as.POSIXct(now_lt), tz = "Asia/Tokyo")
----

----
## [1] "2013-09-11 20:38:43"
----


Arithmetic With Dates and Times
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
now_ct + 86400  #Tomorrow.  I wonder what the world will be like!
----

----
## [1] "2013-09-12 12:38:43 BST"
----

[source,r]
----
now_lt + 86400  #Same behaviour for POSIXlt
----

----
## [1] "2013-09-12 12:38:43 BST"
----

[source,r]
----
now_date + 1  #Date arithmetic is in days.
----

----
## [1] "2013-09-12"
----



[source,r]
----
the_start_of_time <-    #according to POSIX
  as.Date("1970-01-01")
the_end_of_time <-      #according to Mayan conspiracy theorists
  as.Date("2012-12-21")
(all_time <- the_end_of_time - the_start_of_time)
----

----
## Time difference of 15695 days
----



[source,r]
----
class(all_time)
----

----
## [1] "difftime"
----

[source,r]
----
unclass(all_time)
----

----
## [1] 15695
## attr(,"units")
## [1] "days"
----



[source,r]
----
difftime(the_end_of_time, the_start_of_time, units = "secs")
----

----
## Time difference of 1.356e+09 secs
----

[source,r]
----
difftime(the_end_of_time, the_start_of_time, units = "weeks")
----

----
## Time difference of 2242 weeks
----



[source,r]
----
seq(the_start_of_time, the_end_of_time, by = "1 year")
----

----
##  [1] "1970-01-01" "1971-01-01" "1972-01-01" "1973-01-01" "1974-01-01"
##  [6] "1975-01-01" "1976-01-01" "1977-01-01" "1978-01-01" "1979-01-01"
## [11] "1980-01-01" "1981-01-01" "1982-01-01" "1983-01-01" "1984-01-01"
## [16] "1985-01-01" "1986-01-01" "1987-01-01" "1988-01-01" "1989-01-01"
## [21] "1990-01-01" "1991-01-01" "1992-01-01" "1993-01-01" "1994-01-01"
## [26] "1995-01-01" "1996-01-01" "1997-01-01" "1998-01-01" "1999-01-01"
## [31] "2000-01-01" "2001-01-01" "2002-01-01" "2003-01-01" "2004-01-01"
## [36] "2005-01-01" "2006-01-01" "2007-01-01" "2008-01-01" "2009-01-01"
## [41] "2010-01-01" "2011-01-01" "2012-01-01"
----

[source,r]
----
seq(the_start_of_time, the_end_of_time, by = "500 days")  #of Summer
----

----
##  [1] "1970-01-01" "1971-05-16" "1972-09-27" "1974-02-09" "1975-06-24"
##  [6] "1976-11-05" "1978-03-20" "1979-08-02" "1980-12-14" "1982-04-28"
## [11] "1983-09-10" "1985-01-22" "1986-06-06" "1987-10-19" "1989-03-02"
## [16] "1990-07-15" "1991-11-27" "1993-04-10" "1994-08-23" "1996-01-05"
## [21] "1997-05-19" "1998-10-01" "2000-02-13" "2001-06-27" "2002-11-09"
## [26] "2004-03-23" "2005-08-05" "2006-12-18" "2008-05-01" "2009-09-13"
## [31] "2011-01-26" "2012-06-09"
----


Lubridate
~~~~~~~~~

[source,r]
----
library(lubridate)
----

[NOTE]
====
.Message
 Attaching package: 'lubridate'
## 
## The following object is masked from 'package:plyr':
## 
## here

====

[source,r]
----
john_harrison_birth_date <- c( #He invented the marine chronometer
  "1693-03 24",
  "1693/03\\24",
  "Tuesday+1693.03*24"
)
ymd(john_harrison_birth_date)  #All the same
----

----
## [1] "1693-03-24 UTC" "1693-03-24 UTC" "1693-03-24 UTC"
----



[source,r]
----
date_format_function <- stamp("A moon landing occurred on Monday 01 January 1900 at 18:00:00.")
----

[NOTE]
====
.Message
 Multiple formats matched: "A moon landing occurred on %A %m January %d%y
## at %H:%M:%OS"(1), "A moon landing occurred on %A %m January %Y at
## %d:%H:%M."(1), "A moon landing occurred on %A %d %B %Y at %H:%M:%S."(1)
## Using: "A moon landing occurred on %A %d %B %Y at %H:%M:%S."

====

[source,r]
----
date_format_function(moon_landings_lt)
----

----
## [1] "A moon landing occurred on Sunday 20 July 1969 at 20:17:40."
----



[source,r]
----
(duration_one_to_ten_years <- dyears(1:10))
----

----
##  [1] "31536000s (~365 days)"   "63072000s (~730 days)"  
##  [3] "94608000s (~1095 days)"  "126144000s (~1460 days)"
##  [5] "157680000s (~1825 days)" "189216000s (~2190 days)"
##  [7] "220752000s (~2555 days)" "252288000s (~2920 days)"
##  [9] "283824000s (~3285 days)" "315360000s (~3650 days)"
----

[source,r]
----
today() + duration_one_to_ten_years
----

----
##  [1] "2014-09-11" "2015-09-11" "2016-09-10" "2017-09-10" "2018-09-10"
##  [6] "2019-09-10" "2020-09-09" "2021-09-09" "2022-09-09" "2023-09-09"
----





[source,r]
----
(period_one_to_ten_years <- years(1:10))
----

----
##  [1] "1y 0m 0d 0H 0M 0S"  "2y 0m 0d 0H 0M 0S"  "3y 0m 0d 0H 0M 0S" 
##  [4] "4y 0m 0d 0H 0M 0S"  "5y 0m 0d 0H 0M 0S"  "6y 0m 0d 0H 0M 0S" 
##  [7] "7y 0m 0d 0H 0M 0S"  "8y 0m 0d 0H 0M 0S"  "9y 0m 0d 0H 0M 0S" 
## [10] "10y 0m 0d 0H 0M 0S"
----

[source,r]
----
today() + period_one_to_ten_years
----

----
##  [1] "2014-09-11" "2015-09-11" "2016-09-11" "2017-09-11" "2018-09-11"
##  [6] "2019-09-11" "2020-09-11" "2021-09-11" "2022-09-11" "2023-09-11"
----



[source,r]
----
a_year <- dyears(1)  #exactly 60*60*24*365 seconds
as.period(a_year)  #only an estimate
----

[NOTE]
====
.Message
 estimate only: convert durations to intervals for accuracy

====

----
## [1] "1y 0m 0d 0H 0M 0S"
----



[source,r]
----
start_date <- ymd("2016-02-28")
(interval_over_leap_year <- new_interval(start_date, start_date + a_year))
----

----
## [1] 2016-02-28 UTC--2017-02-27 UTC
----

[source,r]
----
as.period(interval_over_leap_year)
----

----
## [1] "11m 30d 0H 0M 0S"
----



[source,r]
----
ymd("2016-02-28") %--% ymd("2016-03-01")  #another way to specify interval
----

----
## [1] 2016-02-28 UTC--2016-03-01 UTC
----

[source,r]
----
ymd("2016-02-29") %within% interval_over_leap_year
----

----
## [1] TRUE
----



[source,r]
----
with_tz(now_lt, tz = "America/Los_Angeles")
----

----
## [1] "2013-09-11 04:38:43 PDT"
----

[source,r]
----
with_tz(now_lt, tz = "Africa/Brazzaville")
----

----
## [1] "2013-09-11 12:38:43 WAT"
----

[source,r]
----
with_tz(now_lt, tz = "Asia/Kolkata")
----

----
## [1] "2013-09-11 17:08:43 IST"
----

[source,r]
----
with_tz(now_lt, tz = "Australia/Adelaide")
----

----
## [1] "2013-09-11 21:08:43 CST"
----



[source,r]
----
head(olson_time_zones())
----

----
## [1] "Africa/Abidjan"     "Africa/Accra"       "Africa/Addis_Ababa"
## [4] "Africa/Algiers"     "Africa/Asmara"      "Africa/Bamako"
----

[source,r]
----
head(olson_time_zones("longitude"))
----

----
## [1] "Pacific/Midway"    "America/Adak"      "Pacific/Chatham"  
## [4] "Pacific/Wallis"    "Pacific/Tongatapu" "Pacific/Enderbury"
----



[source,r]
----
floor_date(today(), "year")
----

----
## [1] "2013-01-01"
----

[source,r]
----
ceiling_date(today(), "year")
----

----
## [1] "2014-01-01"
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Getting Data
------------  
Chapter Goals
~~~~~~~~~~~~~
Built-in Datasets
~~~~~~~~~~~~~~~~~

[source,r]
----
data()
----



[source,r]
----
data(package = .packages(TRUE))
----



[source,r]
----
data("kidney", package = "survival")
----



[source,r]
----
head(kidney)
----

----
##   id time status age sex disease frail
## 1  1    8      1  28   1   Other   2.3
## 2  1   16      1  28   1   Other   2.3
## 3  2   23      1  48   2      GN   1.9
## 4  2   13      0  48   2      GN   1.9
## 5  3   22      1  32   1   Other   1.2
## 6  3   28      1  32   1   Other   1.2
----


Reading Text Files
~~~~~~~~~~~~~~~~~~
CSV and Tab Delimited Files
~~~~~~~~~~~~~~~~~~~~~~~~~~~



[source,r]
----
library(learningr)
deer_file <- system.file("extdata", "RedDeerEndocranialVolume.dlm", package = "learningr")
deer_data <- read.table(deer_file, header = TRUE, fill = TRUE)
----

[WARNING]
====
.Warning
file("") only supports open = "w+" and open = "w+b": using the
## former

====

[CAUTION]
====
.Error
no lines available in input

====

[source,r]
----
str(deer_data)
----

[CAUTION]
====
.Error
object 'deer_data' not found

====

[source,r]
----
head(deer_data)
----

[CAUTION]
====
.Error
object 'deer_data' not found

====



[source,r]
----
crab_file <- system.file("extdata", "crabtag.csv", package = "learningr")
(crab_id_block <- read.csv(crab_file, header = FALSE, skip = 3, nrow = 2))
----

[WARNING]
====
.Warning
file("") only supports open = "w+" and open = "w+b": using the
## former

====

[CAUTION]
====
.Error
no lines available in input

====

[source,r]
----
(crab_tag_notebook <- read.csv(crab_file, header = FALSE, skip = 8, nrow = 5))
----

[WARNING]
====
.Warning
file("") only supports open = "w+" and open = "w+b": using the
## former

====

[CAUTION]
====
.Error
no lines available in input

====

[source,r]
----
(crab_lifetime_notebook <- read.csv(crab_file, header = FALSE, skip = 15, nrow = 3))
----

[WARNING]
====
.Warning
file("") only supports open = "w+" and open = "w+b": using the
## former

====

[CAUTION]
====
.Error
no lines available in input

====


[TIP]
====
The +colbycol+ and +sqldf+ packages contain functions that allow you to read part of a CSV file into R.  This can provide a useful speed-up if you don't need all the columns or all the rows.
====
[TIP]
====
For data exported from Excel, use +na.strings = c("", "#N/A", "#DIV/0!", "#NUM!")+.
====

[source,r]
----
write.csv(crab_lifetime_notebook, "Data/Cleaned/crab lifetime data.csv", row.names = FALSE, 
    fileEncoding = "utf8")
----


Unstructured Text Files
^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
text_file <- system.file("extdata", "Shakespeare's The Tempest, from Project Gutenberg pg2235.txt", 
    package = "learningr")
the_tempest <- readLines(text_file)
----

[WARNING]
====
.Warning
file("") only supports open = "w+" and open = "w+b": using the
## former

====

[source,r]
----
the_tempest[1926:1927]
----

----
## [1] NA NA
----



[source,r]
----
writeLines(
  rev(text_file),     #rev reverses vectors
  "Shakespeare's The Tempest, backwards.txt"
)
----


XML and HTML files
^^^^^^^^^^^^^^^^^^

[source,r]
----
install.packages("XML")
----



[source,r]
----
library(XML)
xml_file <- system.file("extdata", "options.xml", package = "learningr")
r_options <- xmlParse(xml_file)
----

[CAUTION]
====
.Error
XML content does not seem to be XML: ''

====



[source,r]
----
xmlParse(xml_file, useInternalNodes = FALSE)
xmlTreeParse(xml_file)  #the same
----



[source,r]
----
xpathSApply(r_options, "//variable[contains(@name, 'warn')]")
----

[CAUTION]
====
.Error
object 'r_options' not found

====



[source,r]
----
library(Runiversal)
ops <- as.list(options())
cat(makexml(ops), file = "options.xml")
----


JSON and YAML Files
^^^^^^^^^^^^^^^^^^^

[source,r]
----
library(RJSONIO)
library(rjson)
----

[NOTE]
====
.Message
 Attaching package: 'rjson'
## 
## The following object is masked from 'package:RJSONIO':
## 
## fromJSON, toJSON

====

[source,r]
----
jamaican_city_file <- system.file("extdata", "Jamaican Cities.json", package = "learningr")
(jamaican_cities_RJSONIO <- RJSONIO::fromJSON(jamaican_city_file))
----

[CAUTION]
====
.Error
invalid JSON input

====

[source,r]
----
(jamaican_cities_rjson <- rjson::fromJSON(file = jamaican_city_file))
----

[WARNING]
====
.Warning
file("") only supports open = "w+" and open = "w+b": using the
## former

====

[CAUTION]
====
.Error
no data to parse

====



[source,r]
----
special_numbers <- c(NaN, NA, Inf, -Inf)
RJSONIO::toJSON(special_numbers)
----

----
## [1] "[ null, null,    Inf,   -Inf ]"
----

[source,r]
----
rjson::toJSON(special_numbers)
----

----
## [1] "[\"NaN\",\"NA\",\"Inf\",\"-Inf\"]"
----



[source,r]
----
library(yaml)
yaml.load_file(jamaican_city_file)
----

[WARNING]
====
.Warning
file("") only supports open = "w+" and open = "w+b": using the
## former

====

----
## NULL
----


Reading Binary Files
~~~~~~~~~~~~~~~~~~~~
Reading Excel Files
^^^^^^^^^^^^^^^^^^^

[source,r]
----
library(xlsx)
----

[NOTE]
====
.Message
 Loading required package: xlsxjars Loading required package: rJava

====

[source,r]
----
bike_file <- system.file("extdata", "Alpe d'Huez.xls", package = "learningr")
bike_data <- read.xlsx2(bike_file, sheetIndex = 1, startRow = 2, endRow = 38, 
    colIndex = 2:8, colClasses = c("character", "numeric", "character", "integer", 
        "character", "character", "character"))
----

[CAUTION]
====
.Error
Cannot find

====

[source,r]
----
head(bike_data)
----

[CAUTION]
====
.Error
object 'bike_data' not found

====


Reading SAS, Stata, SPSS and MATLAB Files
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Reading Other File Types
^^^^^^^^^^^^^^^^^^^^^^^^
Web Data
~~~~~~~~
Sites With an API
~~~~~~~~~~~~~~~~~

[source,r]
----
install.packages("WDI")
----



[source,r]
----
library(WDI)
# list all available datasets
wdi_datasets <- WDIsearch()
head(wdi_datasets)
# retrieve one of them
wdi_trade_in_services <- WDI(indicator = "BG.GSR.NFSV.GD.ZS")
str(wdi_trade_in_services)
----



----
##      indicator          
## [1,] "BG.GSR.NFSV.GD.ZS"
## [2,] "BM.KLT.DINV.GD.ZS"
## [3,] "BN.CAB.XOKA.GD.ZS"
## [4,] "BN.CUR.GDPM.ZS"   
## [5,] "BN.GSR.FCTY.CD.ZS"
## [6,] "BN.KLT.DINV.CD.ZS"
##      name                                                                      
## [1,] "Trade in services (% of GDP)"                                            
## [2,] "Foreign direct investment, net outflows (% of GDP)"                      
## [3,] "Current account balance (% of GDP)"                                      
## [4,] "Current account balance excluding net official capital grants (% of GDP)"
## [5,] "Net income (% of GDP)"                                                   
## [6,] "Foreign direct investment (% of GDP)"
----

[WARNING]
====
.Warning
Unable to download indicators BG.GSR.NFSV.GD.ZS

====

----
##  NULL
----



[source,r]
----
library(quantmod)
----

[NOTE]
====
.Message
 Loading required package: Defaults Loading required package: xts Loading
## required package: zoo
## 
## Attaching package: 'zoo'
## 
## The following object is masked from 'package:base':
## 
## as.Date, as.Date.numeric
## 
## Loading required package: TTR Version 0.4-0 included new data defaults.
## See ?getSymbols.

====

[source,r]
----
# If you are using a version before 0.5.0 then set this option or pass
# auto.assign = FALSE to getSymbols.
options(getSymbols.auto.assign = FALSE)
microsoft <- getSymbols("MSFT")
----

[NOTE]
====
.Message
 As of 0.4-0, 'getSymbols' uses env=parent.frame() and auto.assign=TRUE by
## default.
## 
## This behavior will be phased out in 0.5-0 when the call will default to
## use auto.assign=FALSE. getOption("getSymbols.env") and
## getOptions("getSymbols.auto.assign") are now checked for alternate
## defaults
## 
## This message is shown once per session and may be disabled by setting
## options("getSymbols.warning4.0"=FALSE). See ?getSymbol for more details

====

[source,r]
----
head(microsoft)
----

----
##            MSFT.Open MSFT.High MSFT.Low MSFT.Close MSFT.Volume
## 2007-01-03     29.91     30.25    29.40      29.86    76935100
## 2007-01-04     29.70     29.97    29.44      29.81    45774500
## 2007-01-05     29.63     29.75    29.45      29.64    44607200
## 2007-01-08     29.65     30.10    29.53      29.93    50220200
## 2007-01-09     30.00     30.18    29.73      29.96    44636600
## 2007-01-10     29.80     29.89    29.43      29.66    55017400
##            MSFT.Adjusted
## 2007-01-03         25.65
## 2007-01-04         25.61
## 2007-01-05         25.46
## 2007-01-08         25.71
## 2007-01-09         25.74
## 2007-01-10         25.48
----


Scraping Web Pages
~~~~~~~~~~~~~~~~~~

[source,r]
----
salary_url <- "http://www.justinmrao.com/salary_data.csv"
salary_data <- read.csv(salary_url)
str(salary_data)
----



[source,r]
----
salary_url <- "http://www.justinmrao.com/salary_data.csv"
local_copy <- "my local copy.csv"
download.file(salary_url, local_copy)
salary_data <- read.csv(local_copy)
----



[source,r]
----
library(RCurl)
----

[NOTE]
====
.Message
 Loading required package: bitops
## 
## Attaching package: 'RCurl'
## 
## The following object is masked from 'package:rJava':
## 
## clone

====

[source,r]
----
time_url <- "http://tycho.usno.navy.mil/cgi-bin/timer.pl"
time_page <- getURL(time_url)
cat(time_page)
----

----
## <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final"//EN>
## <html>
## <body>
## <TITLE>What time is it?</TITLE>
## <H2> US Naval Observatory Master Clock Time</H2> <H3><PRE>
## <BR>Sep. 11, 11:38:48 UTC		Universal Time
## <BR>Sep. 11, 07:38:48 AM EDT	Eastern Time
## <BR>Sep. 11, 06:38:48 AM CDT	Central Time
## <BR>Sep. 11, 05:38:48 AM MDT	Mountain Time
## <BR>Sep. 11, 04:38:48 AM PDT	Pacific Time
## <BR>Sep. 11, 03:38:48 AM AKDT	Alaska Time
## <BR>Sep. 11, 01:38:48 AM HAST	Hawaii-Aleutian Time
## </PRE></H3><P><A HREF="http://www.usno.navy.mil"> US Naval Observatory</A>
## 
## </body></html>
----



[source,r]
----
library(XML)
time_doc <- htmlParse(time_page)
pre <- xpathSApply(time_doc, "//pre")[[1]]
values <- strsplit(xmlValue(pre), "\n")[[1]][-1]
strsplit(values, "\t+")
----

----
## [[1]]
## [1] "Sep. 11, 11:38:48 UTC" "Universal Time"       
## 
## [[2]]
## [1] "Sep. 11, 07:38:48 AM EDT" "Eastern Time"            
## 
## [[3]]
## [1] "Sep. 11, 06:38:48 AM CDT" "Central Time"            
## 
## [[4]]
## [1] "Sep. 11, 05:38:48 AM MDT" "Mountain Time"           
## 
## [[5]]
## [1] "Sep. 11, 04:38:48 AM PDT" "Pacific Time"            
## 
## [[6]]
## [1] "Sep. 11, 03:38:48 AM AKDT" "Alaska Time"              
## 
## [[7]]
## [1] "Sep. 11, 01:38:48 AM HAST" "Hawaii-Aleutian Time"
----



[source,r]
----
library(httr)
time_page <- GET(time_url)
time_doc <- content(page, useInternalNodes = TRUE)
----


Accessing Databases
~~~~~~~~~~~~~~~~~~~

[source,r]
----
library(DBI)
library(RSQLite)
----



[source,r]
----
driver <- dbDriver("SQLite")
db_file <- system.file("extdata", "crabtag.sqlite", package = "learningr")
conn <- dbConnect(driver, db_file)
----



[source,r]
----
driver <- dbDriver("MySQL")
db_file <- "path/to/MySQL/database"
conn <- dbConnect(driver, db_file)
----



[source,r]
----
query <- "SELECT * FROM IdBlock"
(id_block <- dbGetQuery(conn, query))
----

[CAUTION]
====
.Error
RS-DBI driver: (error in statement: no such table: IdBlock)

====



[source,r]
----
dbDisconnect(conn)
----

----
## [1] TRUE
----

[source,r]
----
dbUnloadDriver(driver)
----

----
## [1] TRUE
----



[source,r]
----
query_crab_tag_db <- function(query) {
    driver <- dbDriver("SQLite")
    db_file <- system.file("extdata", "crabtag.sqlite", package = "learningr")
    conn <- dbConnect(driver, db_file)
    on.exit({
        # this code block runs at the end of the function, even if an error is
        # thrown
        dbDisconnect(conn)
        dbUnloadDriver(driver)
    })
    dbGetQuery(conn, query)
}
----



[source,r]
----
query_crab_tag_db("SELECT * FROM IdBlock")
----

[CAUTION]
====
.Error
RS-DBI driver: (error in statement: no such table: IdBlock)

====





[source,r]
----
dbReadTable(conn, "idblock")
----

[CAUTION]
====
.Error
could not find table idblock

====



----
## [1] TRUE
----

----
## [1] TRUE
----



[source,r]
----
library(RODBC)
conn <- odbcConnect("my data source name")
id_block <- sqlQuery(conn, "SELECT * FROM IdBlock")
odbcClose(conn)
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Cleaning And Transforming
-------------------------  
Chapter Goals
~~~~~~~~~~~~~
Cleaning Strings
~~~~~~~~~~~~~~~~

[source,r]
----
yn_to_logical <- function(x) {
    y <- rep.int(NA, length(x))
    y[x == "Y"] <- TRUE
    y[x == "N"] <- FALSE
    y
}
----



[source,r]
----
alpe_d_huez$DrugUse <- yn_to_logical(alpe_d_huez$DrugUse)
----





[source,r]
----
data(english_monarchs, package = "learningr")
head(english_monarchs)
----

----
##       name     house start.of.reign end.of.reign      domain
## 1    Wehha Wuffingas             NA          571 East Anglia
## 2    Wuffa Wuffingas            571          578 East Anglia
## 3   Tytila Wuffingas            578          616 East Anglia
## 4  Rdwald Wuffingas            616          627 East Anglia
## 5 Eorpwald Wuffingas            627          627 East Anglia
## 6 Ricberht Wuffingas            627          630 East Anglia
##   length.of.reign.years reign.was.more.than.30.years
## 1                    NA                           NA
## 2                     7                        FALSE
## 3                    38                         TRUE
## 4                    11                        FALSE
## 5                     0                        FALSE
## 6                     3                        FALSE
----



[source,r]
----
library(stringr)
multiple_kingdoms <- str_detect(english_monarchs$domain, fixed(","))
english_monarchs[multiple_kingdoms, c("name", "domain")]
----

----
##                           name                    domain
## 17                        Offa       East Anglia, Mercia
## 18                        Offa East Anglia, Kent, Mercia
## 19           Offa and Ecgfrith East Anglia, Kent, Mercia
## 20                    Ecgfrith East Anglia, Kent, Mercia
## 22                     Cnwulf East Anglia, Kent, Mercia
## 23        Cnwulf and Cynehelm East Anglia, Kent, Mercia
## 24                     Cnwulf East Anglia, Kent, Mercia
## 25                    Ceolwulf East Anglia, Kent, Mercia
## 26                   Beornwulf       East Anglia, Mercia
## 82      Ecgbehrt and thelwulf              Kent, Wessex
## 83      Ecgbehrt and thelwulf      Kent, Mercia, Wessex
## 84      Ecgbehrt and thelwulf              Kent, Wessex
## 85    thelwulf and elstan I              Kent, Wessex
## 86                   thelwulf              Kent, Wessex
## 87 thelwulf and elberht III              Kent, Wessex
## 88               elberht III              Kent, Wessex
## 89                  thelred I              Kent, Wessex
## 95                       Oswiu       Mercia, Northumbria
----



[source,r]
----
multiple_rulers <- str_detect(english_monarchs$name, ",|and")
english_monarchs$name[multiple_rulers & !is.na(multiple_rulers)]
----

----
##  [1] Sigeberht and Ecgric                       
##  [2] Hun, Beonna and Alberht                    
##  [3] Offa and Ecgfrith                          
##  [4] Cnwulf and Cynehelm                       
##  [5] Sighere and Sebbi                          
##  [6] Sigeheard and Swaefred                     
##  [7] Eorcenberht and Eormenred                  
##  [8] Oswine, Swfbehrt, Swfheard               
##  [9] Swfbehrt, Swfheard, Wihtred              
## [10] elberht II, lfric and Eadberht I        
## [11] elberht II and Eardwulf                  
## [12] Eadberht II, Eanmund and Sigered           
## [13] Heaberht and Ecgbehrt II                   
## [14] Ecgbehrt and thelwulf                     
## [15] Ecgbehrt and thelwulf                     
## [16] Ecgbehrt and thelwulf                     
## [17] thelwulf and elstan I                   
## [18] thelwulf and elberht III                
## [19] Penda and Eowa                             
## [20] Penda and Peada                            
## [21] thelred, Lord of the Mercians             
## [22] thelfld, Lady of the Mercians            
## [23] lfwynn, Second Lady of the Mercians       
## [24] Hlfdan and Eowils                         
## [25] Nohelm and Watt                           
## [26] Nohelm and Bryni                          
## [27] Nohelm and Osric                          
## [28] Nohelm and elstan                       
## [29] lfwald, Oslac and Osmund                  
## [30] lfwald, Ealdwulf, Oslac and Osmund        
## [31] lfwald, Ealdwulf, Oslac, Osmund and Oswald
## [32] Cenwalh and Seaxburh                       
## 211 Levels: Adda elbehrt elberht I ... Wulfhere
----



[source,r]
----
individual_rulers <- str_split(english_monarchs$name, ", | and ")
head(individual_rulers[sapply(individual_rulers, length) > 1])
----

----
## [[1]]
## [1] "Sigeberht" "Ecgric"   
## 
## [[2]]
## [1] "Hun"     "Beonna"  "Alberht"
## 
## [[3]]
## [1] "Offa"     "Ecgfrith"
## 
## [[4]]
## [1] "Cnwulf"  "Cynehelm"
## 
## [[5]]
## [1] "Sighere" "Sebbi"  
## 
## [[6]]
## [1] "Sigeheard" "Swaefred"
----



[source,r]
----
th <- c("th", "", "")
sapply(         #can also use laply from plyr
  th, 
  function(th) 
  {
    sum(str_count(english_monarchs$name, th))
  }
)
----

----
## th   
## 74  7  7
----



[source,r]
----
english_monarchs$new_name <- str_replace_all(english_monarchs$name, "[]", 
    "th")
----



[source,r]
----
gender <- c("MALE", "Male", "male", "M", "FEMALE", "Female", "female", "f", 
    NA)
clean_gender <- str_replace(gender, ignore.case("^m(ale)?$"), "Male")
(clean_gender <- str_replace(clean_gender, ignore.case("^f(emale)?$"), "Female"))
----

----
## [1] "Male"   "Male"   "Male"   "Male"   "Female" "Female" "Female" "Female"
## [9] NA
----


Manipulating Data Frames
~~~~~~~~~~~~~~~~~~~~~~~~
Adding and Replacing Columns
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
english_monarchs$length.of.reign.years <- 
  english_monarchs$end.of.reign - english_monarchs$start.of.reign
----



[source,r]
----
english_monarchs$length.of.reign.years <- with(english_monarchs, end.of.reign - 
    start.of.reign)
----



[source,r]
----
english_monarchs <- within(english_monarchs, {
    length.of.reign.years <- end.of.reign - start.of.reign
})
----



[source,r]
----
english_monarchs <- within(english_monarchs, {
    length.of.reign.years <- end.of.reign - start.of.reign
    reign.was.more.than.30.years <- length.of.reign.years > 30
})
----



[source,r]
----
english_monarchs <- mutate(english_monarchs, length.of.reign.years = end.of.reign - 
    start.of.reign, reign.was.more.than.30.years = length.of.reign.years > 30)
----


Dealing With Missing Values
^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
data("deer_endocranial_volume", package = "learningr")
has_all_measurements <- complete.cases(deer_endocranial_volume)
deer_endocranial_volume[has_all_measurements, ]
----

----
##    SkullID VolCT VolBead VolLWH VolFinarelli VolCT2 VolBead2 VolLWH2
## 7     C120   346     335   1250          289    346      330    1264
## 8      C25   302     295   1011          250    303      295    1009
## 9       F7   379     360   1621          347    375      365    1647
## 10     B12   410     400   1740          387    413      395    1728
## 11     B17   405     395   1652          356    408      395    1639
## 12     B18   391     370   1835          419    394      375    1825
## 13      J7   416     405   1834          408    417      405    1876
## 15      A4   336     330   1224          283    345      330    1192
## 20      K2   349     355   1239          286    354      365    1243
----



[source,r]
----
na.omit(deer_endocranial_volume)
----

----
##    SkullID VolCT VolBead VolLWH VolFinarelli VolCT2 VolBead2 VolLWH2
## 7     C120   346     335   1250          289    346      330    1264
## 8      C25   302     295   1011          250    303      295    1009
## 9       F7   379     360   1621          347    375      365    1647
## 10     B12   410     400   1740          387    413      395    1728
## 11     B17   405     395   1652          356    408      395    1639
## 12     B18   391     370   1835          419    394      375    1825
## 13      J7   416     405   1834          408    417      405    1876
## 15      A4   336     330   1224          283    345      330    1192
## 20      K2   349     355   1239          286    354      365    1243
----



[source,r]
----
na.fail(deer_endocranial_volume)
----


[NOTE]
====
You can use multiple imputation to fill in missing values in a statistically sound way.  This is beyond the scope of the book, but the +mice+ and +mix+ packages are good places to start.
====
Converting between wide and long form
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
deer_wide <- deer_endocranial_volume[, 1:5]
----



[source,r]
----
library(reshape2)
deer_long <- melt(deer_wide, id.vars = "SkullID")
head(deer_long)
----

----
##   SkullID variable value
## 1   DIC44    VolCT   389
## 2     B11    VolCT   389
## 3   DIC90    VolCT   352
## 4   DIC83    VolCT   388
## 5  DIC787    VolCT   375
## 6 DIC1573    VolCT   325
----



[source,r]
----
melt(deer_wide, measure.vars = c("VolCT", "VolBead", "VolLWH", "VolFinarelli"))
----



[source,r]
----
deer_wide_again <- dcast(deer_long, SkullID ~ variable)
----


[NOTE]
====
Spreadsheet aficionados might note that +acast+ and +dcast+ are effectively creating pivot tables.
====
Using SQL
^^^^^^^^^

[source,r]
----
install.packages("sqldf")
----



[source,r]
----
library(sqldf)
----

[NOTE]
====
.Message
 Loading required package: gsubfn Loading required package: proto Loading
## required namespace: tcltk Loading required package: chron
## 
## Attaching package: 'chron'
## 
## The following object is masked from 'package:lubridate':
## 
## days, hours, minutes, seconds, years
## 
## Loading required package: RSQLite.extfuns

====

[source,r]
----
subset(deer_endocranial_volume, VolCT > 400 | VolCT2 > 400, c(VolCT, VolCT2))
----

----
##    VolCT VolCT2
## 10   410    413
## 11   405    408
## 13   416    417
## 16   418     NA
----

[source,r]
----
query <- "SELECT \n      VolCT, \n      VolCT2 \n    FROM \n      deer_endocranial_volume \n    WHERE \n      VolCT > 400 OR\n      VolCT2 > 400"
sqldf(query)
----

[NOTE]
====
.Message
 Loading required package: tcltk

====

----
##   VolCT VolCT2
## 1   410    413
## 2   405    408
## 3   416    417
## 4   418     NA
----


Sorting
~~~~~~~

[source,r]
----
x <- c(2, 32, 4, 16, 8)
sort(x)
----

----
## [1]  2  4  8 16 32
----

[source,r]
----
sort(x, decreasing = TRUE)
----

----
## [1] 32 16  8  4  2
----



[source,r]
----
sort(c("I", "shot", "the", "city", "sheriff"))
----

----
## [1] "city"    "I"       "sheriff" "shot"    "the"
----



[source,r]
----
order(x)
----

----
## [1] 1 3 5 4 2
----

[source,r]
----
x[order(x)]
----

----
## [1]  2  4  8 16 32
----

[source,r]
----
identical(sort(x), x[order(x)])
----

----
## [1] TRUE
----



[source,r]
----
year_order <- order(english_monarchs$start.of.reign)
english_monarchs[year_order, ]
----



[source,r]
----
arrange(english_monarchs, start.of.reign)
----



[source,r]
----
(x <- sample(3, 7, replace = TRUE))
----

----
## [1] 3 3 3 3 1 1 3
----

[source,r]
----
rank(x)
----

----
## [1] 5.0 5.0 5.0 5.0 1.5 1.5 5.0
----

[source,r]
----
rank(x, ties.method = "first")
----

----
## [1] 3 4 5 6 1 2 7
----


Functional Programming
~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
ct2 <- deer_endocranial_volume$VolCT2  #for convenience of typing
isnt.na <- Negate(is.na)
identical(isnt.na(ct2), !is.na(ct2))
----

----
## [1] TRUE
----



[source,r]
----
Filter(isnt.na, ct2)
----

----
## [1] 346 303 375 413 408 394 417 345 354
----



[source,r]
----
Position(isnt.na, ct2)
----

----
## [1] 7
----



[source,r]
----
Find(isnt.na, ct2)
----

----
## [1] 346
----



[source,r]
----
get_volume <- function(ct, bead, lwh, finarelli, ct2, bead2, lwh2) {
    # If there is a second measurement, take the average
    if (!is.na(ct2)) {
        ct <- (ct + ct2)/2
        bead <- (bead + bead2)/2
        lwh <- (lwh + lwh2)/2
    }
    # Divide lwh by 4 to bring it in line with other measurements
    c(ct = ct, bead = bead, lwh.4 = lwh/4, finarelli = finarelli)
}
----



[source,r]
----
measurements_by_deer <- with(deer_endocranial_volume, Map(get_volume, VolCT, 
    VolBead, VolLWH, VolFinarelli, VolCT2, VolBead2, VolLWH2))
head(measurements_by_deer)
----

----
## [[1]]
##        ct      bead     lwh.4 finarelli 
##       389       375       371       337 
## 
## [[2]]
##        ct      bead     lwh.4 finarelli 
##     389.0     370.0     430.5     377.0 
## 
## [[3]]
##        ct      bead     lwh.4 finarelli 
##     352.0     345.0     373.8     328.0 
## 
## [[4]]
##        ct      bead     lwh.4 finarelli 
##     388.0     370.0     420.8     377.0 
## 
## [[5]]
##        ct      bead     lwh.4 finarelli 
##     375.0     355.0     364.5     328.0 
## 
## [[6]]
##        ct      bead     lwh.4 finarelli 
##     325.0     320.0     340.8     291.0
----



[source,r]
----
pmax2 <- function(x, y) ifelse(x >= y, x, y)
----



[source,r]
----
Reduce(pmax2, measurements_by_deer)
----

----
##        ct      bead     lwh.4 finarelli 
##     418.0     405.0     463.8     419.0
----





[source,r]
----
# Reduce('+', list(a, b, c, d, e))
((((a + b) + c) + d) + e)
----



[source,r]
----
mean(mean(mean(mean(a, b), c), d), e) != mean(a, b, c, d, e)
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Exploring And Visualising
-------------------------  
Chapter Goals
~~~~~~~~~~~~~
Summary Statistics
~~~~~~~~~~~~~~~~~~

[source,r]
----
data(obama_vs_mccain, package = "learningr")
obama <- obama_vs_mccain$Obama
mean(obama)
----

----
## [1] 51.29
----

[source,r]
----
median(obama)
----

----
## [1] 51.38
----



[source,r]
----
table(cut(obama, seq.int(0, 100, 10)))
----

----
## 
##   (0,10]  (10,20]  (20,30]  (30,40]  (40,50]  (50,60]  (60,70]  (70,80] 
##        0        0        0        8       16       16        9        1 
##  (80,90] (90,100] 
##        0        1
----



[source,r]
----
var(obama)
----

----
## [1] 123.1
----

[source,r]
----
sd(obama)
----

----
## [1] 11.09
----

[source,r]
----
mad(obama)
----

----
## [1] 11.49
----



[source,r]
----
min(obama)
----

----
## [1] 32.54
----

[source,r]
----
with(obama_vs_mccain, pmin(Obama, McCain))
----

----
##  [1] 38.74 37.89 44.91 38.86 36.91 44.71 38.22  6.53 36.93 48.10 46.90
## [12] 26.58 35.91 36.74 48.82 44.39 41.55 41.15 39.93 40.38 36.47 35.99
## [23] 40.89 43.82 43.00 49.23 47.11 41.60 42.65 44.52 41.61 41.78 36.03
## [34] 49.38 44.50 46.80 34.35 40.40 44.15 35.06 44.90 44.75 41.79 43.63
## [45] 34.22 30.45 46.33 40.26 42.51 42.31 32.54
----

[source,r]
----
range(obama)
----

----
## [1] 32.54 92.46
----



[source,r]
----
cummin(obama)
----

----
##  [1] 38.74 37.89 37.89 37.89 37.89 37.89 37.89 37.89 37.89 37.89 37.89
## [12] 37.89 35.91 35.91 35.91 35.91 35.91 35.91 35.91 35.91 35.91 35.91
## [23] 35.91 35.91 35.91 35.91 35.91 35.91 35.91 35.91 35.91 35.91 35.91
## [34] 35.91 35.91 35.91 34.35 34.35 34.35 34.35 34.35 34.35 34.35 34.35
## [45] 34.22 34.22 34.22 34.22 34.22 34.22 32.54
----

[source,r]
----
cumsum(obama)
----

----
##  [1]   38.74   76.63  121.54  160.40  221.34  275.00  335.59  428.05
##  [9]  489.96  540.87  587.77  659.62  695.53  757.38  807.23  861.16
## [17]  902.71  943.86  983.79 1041.50 1103.42 1165.22 1222.55 1276.61
## [25] 1319.61 1368.84 1415.95 1457.55 1512.70 1566.83 1623.97 1680.88
## [33] 1743.76 1793.46 1837.96 1889.34 1923.69 1980.44 2034.91 2097.77
## [41] 2142.67 2187.42 2229.21 2272.84 2307.06 2374.52 2427.15 2484.49
## [49] 2527.00 2583.22 2615.76
----

[source,r]
----
cumprod(obama)
----

----
##  [1] 3.874e+01 1.468e+03 6.592e+04 2.562e+06 1.561e+08 8.377e+09 5.076e+11
##  [8] 4.693e+13 2.905e+15 1.479e+17 6.937e+18 4.984e+20 1.790e+22 1.107e+24
## [15] 5.519e+25 2.976e+27 1.237e+29 5.089e+30 2.032e+32 1.173e+34 7.261e+35
## [22] 4.487e+37 2.572e+39 1.391e+41 5.980e+42 2.944e+44 1.387e+46 5.769e+47
## [29] 3.182e+49 1.722e+51 9.841e+52 5.601e+54 3.522e+56 1.750e+58 7.789e+59
## [36] 4.002e+61 1.375e+63 7.801e+64 4.249e+66 2.671e+68 1.199e+70 5.367e+71
## [43] 2.243e+73 9.785e+74 3.349e+76 2.259e+78 1.189e+80 6.817e+81 2.898e+83
## [50] 1.629e+85 5.302e+86
----



[source,r]
----
quantile(obama)
----

----
##    0%   25%   50%   75%  100% 
## 32.54 42.75 51.38 57.34 92.46
----

[source,r]
----
quantile(obama, type = 5)  #to reproduce SAS results
----

----
##    0%   25%   50%   75%  100% 
## 32.54 42.63 51.38 57.34 92.46
----

[source,r]
----
quantile(obama, c(0.9, 0.95, 0.99))
----

----
##   90%   95%   99% 
## 61.92 65.17 82.16
----



[source,r]
----
IQR(obama)
----

----
## [1] 14.58
----



[source,r]
----
fivenum(obama)
----

----
## [1] 32.54 42.75 51.38 57.34 92.46
----



[source,r]
----
summary(obama_vs_mccain)
----

----
##         State        Region       Obama          McCain     
##  Alabama   : 1   IV     : 8   Min.   :32.5   Min.   : 6.53  
##  Alaska    : 1   I      : 6   1st Qu.:42.8   1st Qu.:40.39  
##  Arizona   : 1   III    : 6   Median :51.4   Median :46.80  
##  Arkansas  : 1   V      : 6   Mean   :51.3   Mean   :47.00  
##  California: 1   VIII   : 6   3rd Qu.:57.3   3rd Qu.:55.88  
##  Colorado  : 1   VI     : 5   Max.   :92.5   Max.   :65.65  
##  (Other)   :45   (Other):14                                 
##     Turnout      Unemployment      Income        Population      
##  Min.   :50.8   Min.   :3.40   Min.   :19534   Min.   :  563626  
##  1st Qu.:61.0   1st Qu.:5.05   1st Qu.:23501   1st Qu.: 1702662  
##  Median :64.9   Median :5.90   Median :25203   Median : 4350606  
##  Mean   :64.1   Mean   :6.01   Mean   :26580   Mean   : 6074128  
##  3rd Qu.:68.0   3rd Qu.:7.25   3rd Qu.:28978   3rd Qu.: 6656506  
##  Max.   :78.0   Max.   :9.40   Max.   :40846   Max.   :37341989  
##  NA's   :4                                                       
##     Catholic      Protestant       Other      Non.religious     Black     
##  Min.   : 6.0   Min.   :26.0   Min.   :0.00   Min.   : 5    Min.   : 0.4  
##  1st Qu.:12.0   1st Qu.:46.0   1st Qu.:2.00   1st Qu.:12    1st Qu.: 3.1  
##  Median :21.0   Median :54.0   Median :3.00   Median :15    Median : 7.4  
##  Mean   :21.7   Mean   :53.8   Mean   :3.29   Mean   :16    Mean   :11.1  
##  3rd Qu.:29.0   3rd Qu.:62.0   3rd Qu.:4.00   3rd Qu.:19    3rd Qu.:15.2  
##  Max.   :46.0   Max.   :80.0   Max.   :8.00   Max.   :34    Max.   :50.7  
##  NA's   :2      NA's   :2      NA's   :2      NA's   :2                   
##      Latino      Urbanization 
##  Min.   : 1.2   Min.   :   1  
##  1st Qu.: 4.3   1st Qu.:  46  
##  Median : 8.2   Median : 101  
##  Mean   :10.3   Mean   : 386  
##  3rd Qu.:12.1   3rd Qu.: 221  
##  Max.   :46.3   Max.   :9856  
## 
----



[source,r]
----
with(obama_vs_mccain, cor(Obama, McCain))
----

----
## [1] -0.9981
----

[source,r]
----
with(obama_vs_mccain, cancor(Obama, McCain))
----

----
## $cor
## [1] 0.9981
## 
## $xcoef
##         [,1]
## [1,] 0.01275
## 
## $ycoef
##          [,1]
## [1,] -0.01287
## 
## $xcenter
## [1] 51.29
## 
## $ycenter
## [1] 47
----

[source,r]
----
with(obama_vs_mccain, cov(Obama, McCain))
----

----
## [1] -121.7
----


The Three Plotting Systems
~~~~~~~~~~~~~~~~~~~~~~~~~~
Scatterplots
~~~~~~~~~~~~~~
Take 1: base Graphics
^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
obama_vs_mccain <- obama_vs_mccain[!is.na(obama_vs_mccain$Turnout), ]
----



[source,r]
----
with(obama_vs_mccain, plot(Income, Turnout))
----
.A simple scatterplot using base graphics.
image::figure/base_scatterplot_simple.png[A simple scatterplot using base graphics.,align=default]


[source,r]
----
with(obama_vs_mccain, plot(Income, Turnout, col = "violet", pch = 20))
----
.Setting colour and point shape using base graphics.
image::figure/base_scatterplot_coloursize.png[Setting colour and point shape using base graphics.,align=default]


[source,r]
----
with(obama_vs_mccain, plot(Income, Turnout, log = "y"))
----
.Log y scale using base graphics.
image::figure/base_scatterplot_log1.png[Log y scale using base graphics.,align=default]


[source,r]
----
with(obama_vs_mccain, plot(Income, Turnout, log = "xy"))
----
.Log x and y scales using base graphics.
image::figure/base_scatterplot_log2.png[Log x and y scales using base graphics.,align=default]


[source,r]
----
par(mar = c(3, 3, 0.5, 0.5), oma = rep.int(0, 4), mgp = c(2, 1, 0))
regions <- levels(obama_vs_mccain$Region)
plot_numbers <- seq_along(regions)
layout(matrix(plot_numbers, ncol = 5, byrow = TRUE))
for (region in regions) {
    regional_data <- subset(obama_vs_mccain, Region == region)
    with(regional_data, plot(Income, Turnout))
}
----
.Multiple plots in the same figure using base graphics.
image::figure/base_scatterplot_multiple.png[Multiple plots in the same figure using base graphics.,align=default]

Take 2: lattice Graphics
^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
library(lattice)
xyplot(Turnout ~ Income, obama_vs_mccain)
----
.A simple scatterplot using lattice graphics.
image::figure/lattice_scatterplot_simple.png[A simple scatterplot using lattice graphics.,align=default]


[source,r]
----
xyplot(Turnout ~ Income, obama_vs_mccain, col = "violet", pch = 20)
----
.Setting colour and point shape using lattice graphics.
image::figure/lattice_scatterplot_coloursize.png[Setting colour and point shape using lattice graphics.,align=default]


[source,r]
----
xyplot(Turnout ~ Income, obama_vs_mccain, scales = list(log = TRUE)  #both axes log-scaled
)
----
.Log x and y scales using lattice graphics.
image::figure/lattice_scatterplot_log1.png[Log x and y scales using lattice graphics.,align=default]


[source,r]
----
xyplot(Turnout ~ Income, obama_vs_mccain, scales = list(y = list(log = TRUE))  #y axis log-scaled
)
----
.Log y scale using lattice graphics.
image::figure/lattice_scatterplot_log2.png[Log y scale using lattice graphics.,align=default]


[source,r]
----
xyplot(Turnout ~ Income | Region, obama_vs_mccain, scales = list(log = TRUE, 
    relation = "same", alternating = FALSE), layout = c(5, 2))
----
.Multiple plots in the same figure using lattice graphics.
image::figure/lattice_scatterplot_multiple.png[Multiple plots in the same figure using lattice graphics.,align=default]


[source,r]
----
(lat1 <- xyplot(Turnout ~ Income | Region, obama_vs_mccain))
----
.This plot is stored as a variable that is reused in Figure 14-12.
image::figure/lattice_scatterplot_reuse1.png[This plot is stored as a variable that is reused in Figure 14-12.,align=default]


[source,r]
----
(lat2 <- update(lat1, col = "violet", pch = 20))
----
.This plot reuses a lattice variable from Figure 14-11.
image::figure/lattice_scatterplot_reuse2.png[This plot reuses a lattice variable from Figure 14-11.,align=default]

Take 3: ggplot2 Graphics
^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
library(ggplot2)
ggplot(obama_vs_mccain, aes(Income, Turnout)) + geom_point()
----
.A simple scatterplot using ggplot2 graphics.
image::figure/ggplot2_scatterplot_simple.png[A simple scatterplot using ggplot2 graphics.,align=default]


[source,r]
----
ggplot(obama_vs_mccain, aes(Income, Turnout)) + geom_point(color = "violet", 
    shape = 20)
----
.Setting color and point shape using ggplot2 graphics.
image::figure/ggplot2_scatterplot_coloursize.png[Setting color and point shape using ggplot2 graphics.,align=default]


[source,r]
----
ggplot(obama_vs_mccain, aes(Income, Turnout)) + geom_point() + scale_x_log10(breaks = seq(20000, 
    40000, 10000)) + scale_y_log10(breaks = seq(50, 75, 5))
----
.Log scales using ggplot2 graphics.
image::figure/ggplot2_scatterplot_log.png[Log scales using ggplot2 graphics.,align=default]


[source,r]
----
ggplot(obama_vs_mccain, aes(Income, Turnout)) + geom_point() + scale_x_log10(breaks = seq(20000, 
    40000, 10000)) + scale_y_log10(breaks = seq(50, 75, 5)) + facet_wrap(~Region, 
    ncol = 5) + theme(axis.text.x = element_text(angle = 30, hjust = 1))
----
.Multiple plots in the same figure using ggplot2 graphics.
image::figure/ggplot2_scatterplot_multiple.png[Multiple plots in the same figure using ggplot2 graphics.,align=default]


[source,r]
----
(gg1 <- ggplot(obama_vs_mccain, aes(Income, Turnout)) + geom_point())
----
.This plot is stored as a variable that is reused in Figure 14-18.
image::figure/ggplot2_scatterplot_reuse1.png[This plot is stored as a variable that is reused in Figure 14-18.,align=default]


[source,r]
----
(gg2 <- gg1 + facet_wrap(~Region, ncol = 5))
----
.This plot reuses a ggplot2 variable from Figure 14-17.
image::figure/ggplot2_scatterplot_reuse2.png[This plot reuses a ggplot2 variable from Figure 14-17.,align=default]

Line Plots
~~~~~~~~~~

[source,r]
----
with(crab_tag$daylog, plot(Date, -Max.Depth, type = "l", ylim = c(-max(Max.Depth), 
    0)))
----
.A line plot using base graphics.
image::figure/base_lineplot_simple.png[A line plot using base graphics.,align=default]


[source,r]
----
with(crab_tag$daylog, lines(Date, -Min.Depth, col = "blue"))
----


.Adding a second line using base graphics.
image::figure/base_lineplot_2lines.png[Adding a second line using base graphics.,align=default]


[source,r]
----
xyplot(-Min.Depth + -Max.Depth ~ Date, crab_tag$daylog, type = "l")
----
.A line plot using lattice graphics.
image::figure/lattice_lineplot_simple.png[A line plot using lattice graphics.,align=default]


[source,r]
----
ggplot(crab_tag$daylog, aes(Date, -Min.Depth)) + geom_line()
----
.A line plot using ggplot2 graphics.
image::figure/ggplot2_lineplot_simple.png[A line plot using ggplot2 graphics.,align=default]


[source,r]
----
ggplot(crab_tag$daylog, aes(Date)) + geom_line(aes(y = -Max.Depth)) + geom_line(aes(y = -Min.Depth))
----
.Two lines with separate geoms using ggplot2 graphics.
image::figure/ggplot2_lineplot_2lines2geoms.png[Two lines with separate geoms using ggplot2 graphics.,align=default]


[source,r]
----
library(reshape2)
crab_long <- melt(crab_tag$daylog, id.vars = "Date", measure.vars = c("Min.Depth", 
    "Max.Depth"))
ggplot(crab_long, aes(Date, -value, group = variable)) + geom_line()
----
.Two lines with grouping using ggplot2 graphics.
image::figure/ggplot2_lineplot_2linesgrouped.png[Two lines with grouping using ggplot2 graphics.,align=default]


[source,r]
----
ggplot(crab_tag$daylog, aes(Date, ymin = -Min.Depth, ymax = -Max.Depth)) + geom_ribbon(color = "black", 
    fill = "white")
----
.A ribbon plot using ggplot2 graphics.
image::figure/ggplot2_ribbonplot.png[A ribbon plot using ggplot2 graphics.,align=default]

Histograms
~~~~~~~~~~

[source,r]
----
with(obama_vs_mccain, hist(Obama))
----
.A histogram using base graphics.
image::figure/base_histogram_simple.png[A histogram using base graphics.,align=default]


[source,r]
----
with(obama_vs_mccain, hist(Obama, 4, main = "An exact number of bins"))
----
.Specifying histogram breaks using an exact number of bins with base graphics.
image::figure/base_histogram_breaks1.png[Specifying histogram breaks using an exact number of bins with base graphics.,align=default]


[source,r]
----
with(obama_vs_mccain, hist(Obama, seq.int(0, 100, 5), main = "A vector of bin edges"))
----
.Specifying histogram breaks using an exact number of bins with base graphics.
image::figure/base_histogram_breaks2.png[Specifying histogram breaks using an exact number of bins with base graphics.,align=default]


[source,r]
----
with(obama_vs_mccain, hist(Obama, "FD", main = "The name of a method"))
----
.Specifying histogram breaks using the name of a method with base graphics.
image::figure/base_histogram_breaks3.png[Specifying histogram breaks using the name of a method with base graphics.,align=default]


[source,r]
----
with(obama_vs_mccain, hist(Obama, nclass.scott, main = "A function for the number of bins"))
----
.Specifying histogram breaks using a function for the number of bins with base graphics.
image::figure/base_histogram_breaks4.png[Specifying histogram breaks using a function for the number of bins with base graphics.,align=default]


[source,r]
----
binner <- function(x) {
    seq(min(x, na.rm = TRUE), max(x, na.rm = TRUE), length.out = 50)
}
with(obama_vs_mccain, hist(Obama, binner, main = "A function for the bin edges"))
----
.Specifying histogram breaks using a function for the bin edges with base graphics.
image::figure/base_histogram_breaks5.png[Specifying histogram breaks using a function for the bin edges with base graphics.,align=default]


[source,r]
----
with(obama_vs_mccain, hist(Obama, freq = FALSE))
----
.A probability density histogram using base graphics.
image::figure/base_histogram_pdf.png[A probability density histogram using base graphics.,align=default]


[source,r]
----
histogram(~Obama, obama_vs_mccain)
----
.Histograms using lattice graphics.
image::figure/lattice_histogram_simple.png[Histograms using lattice graphics.,align=default]


[source,r]
----
histogram(~Obama, obama_vs_mccain, breaks = 10)
----

[WARNING]
====
.Warning
no
## non-missing arguments to max; returning -Inf

====
.Specifying histogram breaks using lattice graphics.
image::figure/lattice_histogram_breaks.png[Specifying histogram breaks using lattice graphics.,align=default]


[source,r]
----
histogram(~Obama, obama_vs_mccain, type = "percent")
----
.A percentage scaled histogram using lattice graphics.
image::figure/lattice_histogram_percent.png[A percentage scaled histogram using lattice graphics.,align=default]


[source,r]
----
ggplot(obama_vs_mccain, aes(Obama)) + geom_histogram(binwidth = 5)
----
.A histogram using ggplot2 graphics.
image::figure/ggplot2_histogram_simple.png[A histogram using ggplot2 graphics.,align=default]


[source,r]
----
ggplot(obama_vs_mccain, aes(Obama, ..density..)) + geom_histogram(binwidth = 5)
----
.A probability density histogram using ggplot2 graphics.
image::figure/ggplot2_histogram_pdf.png[A probability density histogram using ggplot2 graphics.,align=default]

Boxplots
~~~~~~~~

[source,r]
----
boxplot(Obama ~ Region, data = obama_vs_mccain)
----
.A boxplot using base graphics.
image::figure/base_boxplot_simple.png[A boxplot using base graphics.,align=default]


[source,r]
----
ovm <- within(obama_vs_mccain, Region <- reorder(Region, Obama, median))
boxplot(Obama ~ Region, data = ovm)
----
.Ordering boxes using base graphics.
image::figure/base_boxplot_ordered.png[Ordering boxes using base graphics.,align=default]


[source,r]
----
bwplot(Obama ~ Region, data = ovm)
----
.A boxplot using lattice graphics.
image::figure/lattice_boxplot_simple.png[A boxplot using lattice graphics.,align=default]


[source,r]
----
ggplot(ovm, aes(Region, Obama)) + geom_boxplot()
----
.A boxplot using ggplot2 graphics.
image::figure/ggplot2_boxplot_simple.png[A boxplot using ggplot2 graphics.,align=default]

Barcharts
~~~~~~~~~

[source,r]
----
ovm <- ovm[!(ovm$State %in% c("Alaska", "Hawaii")), ]
----



[source,r]
----
par(las = 1, mar = c(3, 9, 1, 1))
with(ovm, barplot(Catholic, names.arg = State, horiz = TRUE))
----
.A barplot using base graphics.
image::figure/base_barplot_simple.png[A barplot using base graphics.,align=default]


[source,r]
----
religions <- with(ovm, rbind(Catholic, Protestant, Non.religious, Other))
colnames(religions) <- ovm$State
par(las = 1, mar = c(3, 9, 1, 1))
barplot(religions, horiz = TRUE, beside = FALSE)
----
.A stacked barplot using base graphics.
image::figure/base_barplot_stacked.png[A stacked barplot using base graphics.,align=default]


[source,r]
----
barchart(State ~ Catholic, ovm)
----
.A barplot using lattice graphics.
image::figure/lattice_barplot_simple.png[A barplot using lattice graphics.,align=default]


[source,r]
----
barchart(State ~ Catholic + Protestant + Non.religious + Other, ovm, stack = TRUE)
----
.A stacked barplot using lattice graphics.
image::figure/lattice_barplot_stacked.png[A stacked barplot using lattice graphics.,align=default]


[source,r]
----
religions_long <- melt(ovm, id.vars = "State", measure.vars = c("Catholic", 
    "Protestant", "Non.religious", "Other"))
----



[source,r]
----
ggplot(religions_long, aes(State, value, fill = variable)) + geom_bar(stat = "identity") + 
    coord_flip()
----
.A stacked barplot using ggplot2 graphics.
image::figure/ggplot2_barplot_stacked.png[A stacked barplot using ggplot2 graphics.,align=default]


[source,r]
----
ggplot(religions_long, aes(State, value, fill = variable)) + geom_bar(stat = "identity", 
    position = "dodge") + coord_flip()
----
.A dodged barplot using ggplot2 graphics.
image::figure/ggplot2_barplot_simple.png[A dodged barplot using ggplot2 graphics.,align=default]

Other Plotting Packages and Systems
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
library(devtools)
install_github("rCharts", "ramnathv")
----




Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Distributions And Modelling
---------------------------  
Chapter Goals
~~~~~~~~~~~~~
Random Numbers
~~~~~~~~~~~~~~
The sample Function
^^^^^^^^^^^^^^^^^^^

[source,r]
----
sample(7)
----

----
## [1] 4 6 2 3 7 1 5
----



[source,r]
----
sample(7, 5)
----

----
## [1] 4 7 2 5 1
----



[source,r]
----
sample(7, 10, replace = TRUE)
----

----
##  [1] 6 5 1 7 7 4 4 6 4 5
----



[source,r]
----
sample(colors(), 5)  #a great way to pick the colour scheme for your house
----

----
## [1] "gray92"      "seagreen3"   "darkorange4" "grey17"      "gray57"
----



[source,r]
----
sample(.leap.seconds, 4)
----

----
## [1] "1992-07-01 01:00:00 BST" "1979-01-01 00:00:00 GMT"
## [3] "1983-07-01 01:00:00 BST" "1973-01-01 00:00:00 GMT"
----



[source,r]
----
weights <- c(1, 1, 2, 3, 5, 8, 13, 21, 8, 3, 1, 1)
sample(month.abb, 1, prob = weights)
----

----
## [1] "Aug"
----


Sampling From Distributions
^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
runif(5)  #5 uniform random numbers between 0 and 1
runif(5, 1, 10)  #5 uniform random numbers between 1 and 10
rnorm(5)  #5 normal random numbers with mean 0 and std dev 1
rnorm(5, 3, 7)  #5 normal random numbers with mean 3 and std dev 7
----



[source,r]
----
RNGkind()
----

----
## [1] "Mersenne-Twister" "Inversion"
----



[source,r]
----
set.seed(1)
runif(5)
----

----
## [1] 0.2655 0.3721 0.5729 0.9082 0.2017
----

[source,r]
----
set.seed(1)
runif(5)
----

----
## [1] 0.2655 0.3721 0.5729 0.9082 0.2017
----

[source,r]
----
set.seed(1)
runif(5)
----

----
## [1] 0.2655 0.3721 0.5729 0.9082 0.2017
----


Distributions
~~~~~~~~~~~~~


.PDF, CDF and inverse CDF of a normal distribution.
image::figure/ggplot2_pdf_cdf_icdf.png[PDF, CDF and inverse CDF of a normal distribution.,align=default]

Formulae
~~~~~~~~

[source,r]
----
Rate ~ Year + Age.Group + Ethnicity + Gender
----



[source,r]
----
Rate ~ 0 + Year + Age.Group + Ethnicity + Gender
----



[source,r]
----
Rate ~ Year * Age.Group * Ethnicity * Gender
----



[source,r]
----
Rate ~ Year + Ethnicity + Gender + Year:Ethnicity + Year:Ethnicity:Gender
----



[source,r]
----
Rate ~ (Year + Ethnicity + Gender)^2
----



[source,r]
----
Rate ~ I(Year^2)  #year squared, not an interaction
----


A First Model: Linear Regressions
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
model1 <- lm(Rate ~ Year + Age.Group + Ethnicity + Gender, gonorrhoea)
----



[source,r]
----
model1
----

----
## 
## Call:
## lm(formula = Rate ~ Year + Age.Group + Ethnicity + Gender, data = gonorrhoea)
## 
## Coefficients:
##                         (Intercept)                                 Year  
##                            5540.496                               -2.770  
##                     Age.Group5 to 9                    Age.Group10 to 14  
##                              -0.614                               15.268  
##                   Age.Group15 to 19                    Age.Group20 to 24  
##                             415.698                              546.820  
##                   Age.Group25 to 29                    Age.Group30 to 34  
##                             291.098                              155.872  
##                   Age.Group35 to 39                    Age.Group40 to 44  
##                              84.612                               49.506  
##                   Age.Group45 to 54                    Age.Group55 to 64  
##                              27.364                                8.684  
##                 Age.Group65 or more  EthnicityAsians & Pacific Islanders  
##                               1.178                              -82.923  
##                  EthnicityHispanics         EthnicityNon-Hispanic Blacks  
##                             -49.000                              376.204  
##        EthnicityNon-Hispanic Whites                           GenderMale  
##                             -68.263                              -17.892
----



[source,r]
----
lapply(Filter(is.factor, gonorrhoea), levels)
----

----
## $Age.Group
##  [1] "0 to 4"     "5 to 9"     "10 to 14"   "15 to 19"   "20 to 24"  
##  [6] "25 to 29"   "30 to 34"   "35 to 39"   "40 to 44"   "45 to 54"  
## [11] "55 to 64"   "65 or more"
## 
## $Ethnicity
## [1] "American Indians & Alaskan Natives"
## [2] "Asians & Pacific Islanders"        
## [3] "Hispanics"                         
## [4] "Non-Hispanic Blacks"               
## [5] "Non-Hispanic Whites"               
## 
## $Gender
## [1] "Female" "Male"
----



[source,r]
----
summary(model1)
----

----
## 
## Call:
## lm(formula = Rate ~ Year + Age.Group + Ethnicity + Gender, data = gonorrhoea)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -376.7 -130.6   37.1   90.7 1467.1 
## 
## Coefficients:
##                                      Estimate Std. Error t value Pr(>|t|)
## (Intercept)                          5540.496  14866.406    0.37   0.7095
## Year                                   -2.770      7.400   -0.37   0.7083
## Age.Group5 to 9                        -0.614     51.268   -0.01   0.9904
## Age.Group10 to 14                      15.268     51.268    0.30   0.7660
## Age.Group15 to 19                     415.698     51.268    8.11  3.0e-15
## Age.Group20 to 24                     546.820     51.268   10.67  < 2e-16
## Age.Group25 to 29                     291.098     51.268    5.68  2.2e-08
## Age.Group30 to 34                     155.872     51.268    3.04   0.0025
## Age.Group35 to 39                      84.612     51.268    1.65   0.0994
## Age.Group40 to 44                      49.506     51.268    0.97   0.3346
## Age.Group45 to 54                      27.364     51.268    0.53   0.5937
## Age.Group55 to 64                       8.684     51.268    0.17   0.8656
## Age.Group65 or more                     1.178     51.268    0.02   0.9817
## EthnicityAsians & Pacific Islanders   -82.923     33.093   -2.51   0.0125
## EthnicityHispanics                    -49.000     33.093   -1.48   0.1392
## EthnicityNon-Hispanic Blacks          376.204     33.093   11.37  < 2e-16
## EthnicityNon-Hispanic Whites          -68.263     33.093   -2.06   0.0396
## GenderMale                            -17.892     20.930   -0.85   0.3930
##                                        
## (Intercept)                            
## Year                                   
## Age.Group5 to 9                        
## Age.Group10 to 14                      
## Age.Group15 to 19                   ***
## Age.Group20 to 24                   ***
## Age.Group25 to 29                   ***
## Age.Group30 to 34                   ** 
## Age.Group35 to 39                   .  
## Age.Group40 to 44                      
## Age.Group45 to 54                      
## Age.Group55 to 64                      
## Age.Group65 or more                    
## EthnicityAsians & Pacific Islanders *  
## EthnicityHispanics                     
## EthnicityNon-Hispanic Blacks        ***
## EthnicityNon-Hispanic Whites        *  
## GenderMale                             
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 256 on 582 degrees of freedom
## Multiple R-squared:  0.491,	Adjusted R-squared:  0.476 
## F-statistic: 33.1 on 17 and 582 DF,  p-value: <2e-16
----


Comparing and Updating Models
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[TIP]
====
In general, the simplest solution to finding a good model is to understand the problem domain, and see if the model gives you some insight.
====

[source,r]
----
model2 <- update(model1, ~. - Year)
summary(model2)
----

----
## 
## Call:
## lm(formula = Rate ~ Age.Group + Ethnicity + Gender, data = gonorrhoea)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -377.6 -128.4   34.6   92.2 1472.6 
## 
## Coefficients:
##                                     Estimate Std. Error t value Pr(>|t|)
## (Intercept)                          -25.103     43.116   -0.58   0.5606
## Age.Group5 to 9                       -0.614     51.230   -0.01   0.9904
## Age.Group10 to 14                     15.268     51.230    0.30   0.7658
## Age.Group15 to 19                    415.698     51.230    8.11  2.9e-15
## Age.Group20 to 24                    546.820     51.230   10.67  < 2e-16
## Age.Group25 to 29                    291.098     51.230    5.68  2.1e-08
## Age.Group30 to 34                    155.872     51.230    3.04   0.0025
## Age.Group35 to 39                     84.612     51.230    1.65   0.0992
## Age.Group40 to 44                     49.506     51.230    0.97   0.3343
## Age.Group45 to 54                     27.364     51.230    0.53   0.5934
## Age.Group55 to 64                      8.684     51.230    0.17   0.8655
## Age.Group65 or more                    1.178     51.230    0.02   0.9817
## EthnicityAsians & Pacific Islanders  -82.923     33.069   -2.51   0.0124
## EthnicityHispanics                   -49.000     33.069   -1.48   0.1389
## EthnicityNon-Hispanic Blacks         376.204     33.069   11.38  < 2e-16
## EthnicityNon-Hispanic Whites         -68.263     33.069   -2.06   0.0394
## GenderMale                           -17.892     20.915   -0.86   0.3926
##                                        
## (Intercept)                            
## Age.Group5 to 9                        
## Age.Group10 to 14                      
## Age.Group15 to 19                   ***
## Age.Group20 to 24                   ***
## Age.Group25 to 29                   ***
## Age.Group30 to 34                   ** 
## Age.Group35 to 39                   .  
## Age.Group40 to 44                      
## Age.Group45 to 54                      
## Age.Group55 to 64                      
## Age.Group65 or more                    
## EthnicityAsians & Pacific Islanders *  
## EthnicityHispanics                     
## EthnicityNon-Hispanic Blacks        ***
## EthnicityNon-Hispanic Whites        *  
## GenderMale                             
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 256 on 583 degrees of freedom
## Multiple R-squared:  0.491,	Adjusted R-squared:  0.477 
## F-statistic: 35.2 on 16 and 583 DF,  p-value: <2e-16
----



[source,r]
----
anova(model1, model2)
----

----
## Analysis of Variance Table
## 
## Model 1: Rate ~ Year + Age.Group + Ethnicity + Gender
## Model 2: Rate ~ Age.Group + Ethnicity + Gender
##   Res.Df      RSS Df Sum of Sq    F Pr(>F)
## 1    582 38243062                         
## 2    583 38252272 -1     -9210 0.14   0.71
----



[source,r]
----
AIC(model1, model2)
----

----
##        df  AIC
## model1 19 8378
## model2 18 8376
----

[source,r]
----
BIC(model1, model2)
----

----
##        df  BIC
## model1 19 8462
## model2 18 8456
----



[source,r]
----
silly_model <- update(model1, ~. - Age.Group)
anova(model1, silly_model)
----

----
## Analysis of Variance Table
## 
## Model 1: Rate ~ Year + Age.Group + Ethnicity + Gender
## Model 2: Rate ~ Year + Ethnicity + Gender
##   Res.Df      RSS  Df Sum of Sq    F Pr(>F)    
## 1    582 38243062                              
## 2    593 57212506 -11  -1.9e+07 26.2 <2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
----

[source,r]
----
AIC(model1, silly_model)
----

----
##             df  AIC
## model1      19 8378
## silly_model  8 8598
----

[source,r]
----
BIC(model1, silly_model)
----

----
##             df  BIC
## model1      19 8462
## silly_model  8 8633
----



[source,r]
----
model3 <- update(model2, ~. - Gender)
summary(model3)
----

----
## 
## Call:
## lm(formula = Rate ~ Age.Group + Ethnicity, data = gonorrhoea)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -380.1 -136.1   35.8   87.4 1481.5 
## 
## Coefficients:
##                                     Estimate Std. Error t value Pr(>|t|)
## (Intercept)                          -34.050     41.820   -0.81   0.4159
## Age.Group5 to 9                       -0.614     51.218   -0.01   0.9904
## Age.Group10 to 14                     15.268     51.218    0.30   0.7657
## Age.Group15 to 19                    415.698     51.218    8.12  2.9e-15
## Age.Group20 to 24                    546.820     51.218   10.68  < 2e-16
## Age.Group25 to 29                    291.098     51.218    5.68  2.1e-08
## Age.Group30 to 34                    155.872     51.218    3.04   0.0024
## Age.Group35 to 39                     84.612     51.218    1.65   0.0991
## Age.Group40 to 44                     49.506     51.218    0.97   0.3342
## Age.Group45 to 54                     27.364     51.218    0.53   0.5934
## Age.Group55 to 64                      8.684     51.218    0.17   0.8654
## Age.Group65 or more                    1.178     51.218    0.02   0.9817
## EthnicityAsians & Pacific Islanders  -82.923     33.061   -2.51   0.0124
## EthnicityHispanics                   -49.000     33.061   -1.48   0.1389
## EthnicityNon-Hispanic Blacks         376.204     33.061   11.38  < 2e-16
## EthnicityNon-Hispanic Whites         -68.263     33.061   -2.06   0.0394
##                                        
## (Intercept)                            
## Age.Group5 to 9                        
## Age.Group10 to 14                      
## Age.Group15 to 19                   ***
## Age.Group20 to 24                   ***
## Age.Group25 to 29                   ***
## Age.Group30 to 34                   ** 
## Age.Group35 to 39                   .  
## Age.Group40 to 44                      
## Age.Group45 to 54                      
## Age.Group55 to 64                      
## Age.Group65 or more                    
## EthnicityAsians & Pacific Islanders *  
## EthnicityHispanics                     
## EthnicityNon-Hispanic Blacks        ***
## EthnicityNon-Hispanic Whites        *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 256 on 584 degrees of freedom
## Multiple R-squared:  0.491,	Adjusted R-squared:  0.477 
## F-statistic: 37.5 on 15 and 584 DF,  p-value: <2e-16
----



[source,r]
----
g2 <- within(gonorrhoea, {
    Age.Group <- relevel(Age.Group, "30 to 34")
    Ethnicity <- relevel(Ethnicity, "Non-Hispanic Whites")
})
model4 <- update(model3, data = g2)
summary(model4)
----

----
## 
## Call:
## lm(formula = Rate ~ Age.Group + Ethnicity, data = g2)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -380.1 -136.1   35.8   87.4 1481.5 
## 
## Coefficients:
##                                             Estimate Std. Error t value
## (Intercept)                                     53.6       41.8    1.28
## Age.Group0 to 4                               -155.9       51.2   -3.04
## Age.Group5 to 9                               -156.5       51.2   -3.06
## Age.Group10 to 14                             -140.6       51.2   -2.75
## Age.Group15 to 19                              259.8       51.2    5.07
## Age.Group20 to 24                              390.9       51.2    7.63
## Age.Group25 to 29                              135.2       51.2    2.64
## Age.Group35 to 39                              -71.3       51.2   -1.39
## Age.Group40 to 44                             -106.4       51.2   -2.08
## Age.Group45 to 54                             -128.5       51.2   -2.51
## Age.Group55 to 64                             -147.2       51.2   -2.87
## Age.Group65 or more                           -154.7       51.2   -3.02
## EthnicityAmerican Indians & Alaskan Natives     68.3       33.1    2.06
## EthnicityAsians & Pacific Islanders            -14.7       33.1   -0.44
## EthnicityHispanics                              19.3       33.1    0.58
## EthnicityNon-Hispanic Blacks                   444.5       33.1   13.44
##                                             Pr(>|t|)    
## (Intercept)                                   0.2008    
## Age.Group0 to 4                               0.0024 ** 
## Age.Group5 to 9                               0.0024 ** 
## Age.Group10 to 14                             0.0062 ** 
## Age.Group15 to 19                            5.3e-07 ***
## Age.Group20 to 24                            9.4e-14 ***
## Age.Group25 to 29                             0.0085 ** 
## Age.Group35 to 39                             0.1647    
## Age.Group40 to 44                             0.0383 *  
## Age.Group45 to 54                             0.0124 *  
## Age.Group55 to 64                             0.0042 ** 
## Age.Group65 or more                           0.0026 ** 
## EthnicityAmerican Indians & Alaskan Natives   0.0394 *  
## EthnicityAsians & Pacific Islanders           0.6576    
## EthnicityHispanics                            0.5603    
## EthnicityNon-Hispanic Blacks                 < 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 256 on 584 degrees of freedom
## Multiple R-squared:  0.491,	Adjusted R-squared:  0.477 
## F-statistic: 37.5 on 15 and 584 DF,  p-value: <2e-16
----


Plotting and Inspecting Models
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
plot_numbers <- 1:6
layout(matrix(plot_numbers, ncol = 2, byrow = TRUE))
plot(model4, plot_numbers)
----


.Diagnostic plots for a linear model.
image::figure/unnamed-chunk-470.png[Diagnostic plots for a linear model.,align=default]


[source,r]
----
gonorrhoea[c(40, 41, 160), ]
----

----
##     Year Age.Group           Ethnicity Gender Rate
## 40  2007  15 to 19 Non-Hispanic Blacks Female 2239
## 41  2007  20 to 24 Non-Hispanic Blacks Female 2200
## 160 2008  15 to 19 Non-Hispanic Blacks Female 2233
----



[source,r]
----
str(model4)
unclass(model4)
----



[source,r]
----
formula(model4)
----

----
## Rate ~ Age.Group + Ethnicity
----

[source,r]
----
nobs(model4)
----

----
## [1] 600
----

[source,r]
----
head(residuals(model4))
----

----
##       1       2       3       4       5       6 
##  102.61  102.93   87.25 -282.38 -367.61 -125.38
----

[source,r]
----
head(fitted(model4))
----

----
##       1       2       3       4       5       6 
## -102.31 -102.93  -87.05  313.38  444.51  188.78
----

[source,r]
----
head(coefficients(model4))
----

----
##       (Intercept)   Age.Group0 to 4   Age.Group5 to 9 Age.Group10 to 14 
##             53.56           -155.87           -156.49           -140.60 
## Age.Group15 to 19 Age.Group20 to 24 
##            259.83            390.95
----



[source,r]
----
head(cooks.distance(model4))
----

----
##         1         2         3         4         5         6 
## 0.0002824 0.0002842 0.0002042 0.0021390 0.0036250 0.0004217
----

[source,r]
----
summary(model4)$r.squared
----

----
## [1] 0.4906
----



[source,r]
----
diagnostics <- data.frame(residuals = residuals(model4), fitted = fitted(model4))
ggplot(diagnostics, aes(fitted, residuals)) + geom_point() + geom_smooth(method = "loess")
----
.A ggplot2-based diagnostic plot of residuals vs. fitted values
image::figure/unnamed-chunk-475.png[A ggplot2-based diagnostic plot of residuals vs. fitted values,align=default]


[source,r]
----
new_data <- data.frame(Age.Group = "30 to 34", Ethnicity = "Non-Hispanic Whites")
predict(model4, new_data)
----

----
##     1 
## 53.56
----



[source,r]
----
subset(gonorrhoea, Age.Group == "30 to 34" & Ethnicity == "Non-Hispanic Whites")
----

----
##     Year Age.Group           Ethnicity Gender Rate
## 7   2007  30 to 34 Non-Hispanic Whites   Male 41.0
## 19  2007  30 to 34 Non-Hispanic Whites Female 45.6
## 127 2008  30 to 34 Non-Hispanic Whites   Male 35.1
## 139 2008  30 to 34 Non-Hispanic Whites Female 40.8
## 247 2009  30 to 34 Non-Hispanic Whites   Male 34.6
## 259 2009  30 to 34 Non-Hispanic Whites Female 33.8
## 367 2010  30 to 34 Non-Hispanic Whites   Male 40.8
## 379 2010  30 to 34 Non-Hispanic Whites Female 38.5
## 487 2011  30 to 34 Non-Hispanic Whites   Male 48.0
## 499 2011  30 to 34 Non-Hispanic Whites Female 40.7
----


Other Model Types
~~~~~~~~~~~~~~~~~
[TIP]
====
The modelling capabilities of R are spread across many package written by many poeple, and consequently their syntax varies.  The +caret+ package provides wrappers to about 150 models to give them a consistent interface, along with some tools for model training and validation.  <<kuhn, Max Kuhn's Applied Predictive Modeling>> is the definitive reference to this package.
====

[source,r]
----
glm(true_or_false ~ some + predictor + variables, data, family = binomial())
----



[source,r]
----
lme(y ~ some + fixed + effects, data, random = ~1 | random/effects)
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Programming
-----------
Chapter Goals
~~~~~~~~~~~~~
Messages, Warnings and Errors
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
f <- function(x) {
    message("'x' contains ", toString(x))
    x
}
f(letters[1:5])
----

[NOTE]
====
.Message
 'x' contains a, b, c, d, e

====

----
## [1] "a" "b" "c" "d" "e"
----



[source,r]
----
suppressMessages(f(letters[1:5]))
----

----
## [1] "a" "b" "c" "d" "e"
----



[source,r]
----
g <- function(x) {
    if (any(x < 0)) {
        warning("'x' contains negative values: ", toString(x[x < 0]))
    }
    x
}
g(c(3, -7, 2, -9))
----

[WARNING]
====
.Warning
'x' contains negative values: -7, -9

====

----
## [1]  3 -7  2 -9
----



[source,r]
----
suppressWarnings(g(c(3, -7, 2, -9)))
----

----
## [1]  3 -7  2 -9
----



[source,r]
----
getOption("warn")
----

----
## [1] 1
----





[source,r]
----
old_ops <- options(warn = -1)
g(c(3, -7, 2, -9))
----

----
## [1]  3 -7  2 -9
----



[source,r]
----
options(old_ops)
----





[source,r]
----
h <- function(x, na.rm = FALSE) {
    if (!na.rm && any(is.na(x))) {
        stop("'x' has missing values.")
    }
    x
}
h(c(1, NA))
----

[CAUTION]
====
.Error
'x' has missing values.

====



[source,r]
----
h <- function(x, na.rm = FALSE) {
    if (!na.rm) {
        stopifnot(!any(is.na(x)))
    }
    x
}
h(c(1, NA))
----

[CAUTION]
====
.Error
!any(is.na(x)) is not TRUE

====



[source,r]
----
library(assertive)
h <- function(x, na.rm = FALSE) {
    if (!na.rm) {
        assert_all_are_not_na(x)
    }
    x
}
h(c(1, NA))
----

[CAUTION]
====
.Error
x contains NAs.

====


Error Handling
~~~~~~~~~~~~~~

[source,r]
----
to_convert <- list(first = sapply(letters[1:5], charToRaw), second = polyroot(c(1, 
    0, 0, 0, 1)), third = list(x = 1:2, y = 3:5))
----



[source,r]
----
lapply(to_convert, as.data.frame)
----

[CAUTION]
====
.Error
arguments imply differing number of rows: 2, 3

====



[source,r]
----
result <- try(lapply(to_convert, as.data.frame))
----



[source,r]
----
if (inherits(result, "try-error")) {
    # special error handling code
} else {
    # code for normal execution
}
----

----
## NULL
----



[source,r]
----
tryCatch(lapply(to_convert, as.data.frame), error = function(e) {
    message("An error was thrown: ", e$message)
    data.frame()
})
----

[NOTE]
====
.Message
 An error was thrown: arguments imply differing number of rows: 2, 3

====

----
## data frame with 0 columns and 0 rows
----



[source,r]
----
lapply(to_convert, function(x) {
    tryCatch(as.data.frame(x), error = function(e) NULL)
})
----

----
## $first
##    x
## a 61
## b 62
## c 63
## d 64
## e 65
## 
## $second
##                 x
## 1  0.7071+0.7071i
## 2 -0.7071+0.7071i
## 3 -0.7071-0.7071i
## 4  0.7071-0.7071i
## 
## $third
## NULL
----



[source,r]
----
tryapply(to_convert, as.data.frame)
----

----
## $first
##    x
## a 61
## b 62
## c 63
## d 64
## e 65
## 
## $second
##                 x
## 1  0.7071+0.7071i
## 2 -0.7071+0.7071i
## 3 -0.7071-0.7071i
## 4  0.7071-0.7071i
----


Debugging
~~~~~~~~~

[source,r]
----
outer_fn <- function(x) inner_fn(x)
inner_fn <- function(x) exp(x)
----



[source,r]
----
outer_fn(list(1))
----

[CAUTION]
====
.Error
non-numeric argument to mathematical function

====



[source,r]
----
inner_fn <- function(x) {
    browser()  #execution pauses here
    exp(x)
}
----



[source,r]
----
debug(buggy_count)
x <- factor(sample(c("male", "female"), 20, replace = TRUE))
buggy_count(x)
----



[source,r]
----
undebug(buggy_count)
----


Testing
^^^^^^^

[source,r]
----
hypotenuse <- function(x, y) {
    sqrt(x^2 + y^2)
}
----


RUnit
^^^^^
[TIP]
====
+test.name_of_function.description_of_inputs.returns_a_value+.
====

[source,r]
----
library(RUnit)
test.hypotenuse.3_4.returns_5 <- function() {
    expected <- 5
    actual <- hypotenuse(3, 4)
    checkEqualsNumeric(expected, actual)
}
----



[source,r]
----
test.hypotenuse.no_inputs.fails <- function() {
    checkException(hypotenuse())
}
----



[source,r]
----
.Machine$double.xmin
----

----
## [1] 2.225e-308
----

[source,r]
----
.Machine$double.xmax
----

----
## [1] 1.798e+308
----



[source,r]
----
test.hypotenuse.very_small_inputs.returns_small_positive <- function() {
    expected <- sqrt(2) * 1e-300
    actual <- hypotenuse(1e-300, 1e-300)
    checkEqualsNumeric(expected, actual, tolerance = 1e-305)
}
test.hypotenuse.very_large_inputs.returns_large_finite <- function() {
    expected <- sqrt(2) * 1e+300
    actual <- hypotenuse(1e+300, 1e+300)
    checkEqualsNumeric(expected, actual)
}
----



[source,r]
----
test_dir <- system.file("tests", package = "learningr")
suite <- defineTestSuite("hypotenuse suite", test_dir)
----



[source,r]
----
runTestSuite(suite)
----



----
##  Timing stopped at: 0 0 0 done successfully.
----

[source,r]
----
test.log.minus1.throws_warning <- function() {
    old_ops <- options(warn = 2)  #warnings become errors
    on.exit(old_ops)  #restore old behaviour
    checkException(log(-1))
}
----


testthat
^^^^^^^^

[NOTE]
====
.Message
 Attaching package: 'testthat'
## 
## The following object is masked from 'package:assertive':
## 
## is_false, is_true

====



[source,r]
----
library(testthat)
expect_equal(hypotenuse(3, 4), 5)
expect_error(hypotenuse())
expect_equal(hypotenuse(1e-300, 1e-300), sqrt(2) * 1e-300, tol = 1e-305)
expect_equal(hypotenuse(1e+300, 1e+300), sqrt(2) * 1e+300)
----



[source,r]
----
filename <- system.file("tests", "testthat_hypotenuse_tests.R", package = "learningr")
test_file(filename)
----

[CAUTION]
====
.Error
'' is not an existing file

====



[source,r]
----
expect_warning(log(-1))
----


Magic
~~~~~
Turning strings into code
^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
atan(c(-Inf, -1, 0, 1, Inf))
----

----
## [1] -1.5708 -0.7854  0.0000  0.7854  1.5708
----



[source,r]
----
(quoted_r_code <- quote(atan(c(-Inf, -1, 0, 1, Inf))))
----

----
## atan(c(-Inf, -1, 0, 1, Inf))
----

[source,r]
----
class(quoted_r_code)
----

----
## [1] "call"
----



[source,r]
----
eval(quoted_r_code)
----

----
## [1] -1.5708 -0.7854  0.0000  0.7854  1.5708
----



[source,r]
----
as.list(quoted_r_code)
----

----
## [[1]]
## atan
## 
## [[2]]
## c(-Inf, -1, 0, 1, Inf)
----



[source,r]
----
vapply(list(`+`, `if`, `for`, `<-`, `[`, `[[`), is.function, logical(1))
----

----
## [1] TRUE TRUE TRUE TRUE TRUE TRUE
----


[TIP]
====
When you call +parse+ in this way, you must explicitly name the +text+ argument.
====

[source,r]
----
parsed_r_code <- parse(text = "atan(c(-Inf, -1, 0, 1, Inf))")
class(parsed_r_code)
----

----
## [1] "expression"
----



[source,r]
----
eval(parsed_r_code)
----

----
## [1] -1.5708 -0.7854  0.0000  0.7854  1.5708
----


[WARNING]
====
This sort of mucking about with evaluating strings is a handy trick, but the resulting code is usually fragile and fiendish to debug, making your code unmaintainable.  This is the zombie (code) apocalypse mentioned above.
====
Turning code into strings
^^^^^^^^^^^^^^^^^^^^^^^^^

[source,r]
----
random_numbers <- rt(1000, 2)
hist(random_numbers)
----





[source,r]
----
divider <- function(numerator, denominator) {
    if (denominator == 0) {
        denominator_name <- deparse(substitute(denominator))
        warning("The denominator, ", sQuote(denominator_name), ", is zero.")
    }
    numerator/denominator
}
top <- 3
bottom <- 0
divider(top, bottom)
----

[WARNING]
====
.Warning
The denominator, 'bottom', is zero.

====

----
## [1] Inf
----



[source,r]
----
eval(substitute(levels(Gender)), hafu)
----

----
## [1] "F" "M"
----



[source,r]
----
with(hafu, levels(Gender))
----

----
## [1] "F" "M"
----


Object Oriented Programming
~~~~~~~~~~~~~~~~~~~~~~~~~~~
[TIP]
====
In many object oriented programming languages, functions are called methods. In R, the two words are interchangeable, but ``method'' is often used in an OOP context. 
====
S3 Classes
^^^^^^^^^^

[source,r]
----
print
----

----
## function (x, ...) 
## UseMethod("print")
## <bytecode: 0x0000000006a8d480>
## <environment: namespace:base>
----



[source,r]
----
today <- Sys.Date()
print(today)
----

----
## [1] "2013-09-11"
----



[source,r]
----
print.Date
----

----
## function (x, max = NULL, ...) 
## {
##     if (is.null(max)) 
##         max <- getOption("max.print", 9999L)
##     if (max < length(x)) {
##         print(format(x[seq_len(max)]), max = max, ...)
##         cat(" [ reached getOption(\"max.print\") -- omitted", 
##             length(x) - max, "entries ]\n")
##     }
##     else print(format(x), max = max, ...)
##     invisible(x)
## }
## <bytecode: 0x000000001959a6b0>
## <environment: namespace:base>
----


[WARNING]
====
If a class-specific method can't be found, and there is no default method, then an error is thrown.
====

[source,r]
----
head(methods(print))
----

----
## [1] "print.abbrev"      "print.acf"         "print.AES"        
## [4] "print.anova"       "print.Anova"       "print.anova.loglm"
----

[source,r]
----
methods(mean)
----

----
## [1] mean.Date     mean.default  mean.difftime mean.POSIXct  mean.POSIXlt 
## [6] mean.times*   mean.yearmon* mean.yearqtr* mean.zoo*    
## 
##    Non-visible functions are asterisked
----


[TIP]
====
If you use dots in your function names, like +data.frame+, then it can get confusing as to which S3 method gets called.  For example +print.data.frame+ could mean a +print.data+ method for a +frame+ input, as well as the correct sense.  This means that using +lower_under_case+ or +lowerCamelCase+ is preferred for function new names.
====
Reference Classes
^^^^^^^^^^^^^^^^^
[NOTE]
====
A +class+ is the general template for how the variables should be structured. An +object+ is a particular instance of the class.  For example, +1:10+ is an _object_ of _class_ ``numeric''.
====

[source,r]
----
my_class_generator <- setRefClass(
  "MyClass",
  fields = list(
    #data variables are defined here
  ),
  methods = list(
    #functions to operate on that data go here
    initialize = function(...)
    {
      #initialize is a special function called
      #when an object is created.
    }
  )
)
----



[source,r]
----
point_generator <- setRefClass("point", fields = list(x = "numeric", y = "numeric"), 
    methods = list(# TODO))
----



[source,r]
----
point_generator <- setRefClass("point", fields = list(x = "numeric", y = "numeric"), 
    methods = list(initialize = function(x = NA_real_, y = NA_real_) {
        "Assign x and y upon object creation."
        x <<- x
        y <<- y
    }))
----



[source,r]
----
(a_point <- point_generator$new(5, 3))
----

----
## Reference class object of class "point"
## Field "x":
## [1] 5
## Field "y":
## [1] 3
----



[source,r]
----
point_generator$help("initialize")
----

----
## Call:
## $initialize(x = , y = )
## 
## 
## Assign x and y upon object creation.
----



[source,r]
----
create_point <- function(x, y) {
    point_generator$new(x, y)
}
----



[source,r]
----
point_generator <- setRefClass("point", fields = list(x = "numeric", y = "numeric"), 
    methods = list(initialize = function(x = NA_real_, y = NA_real_) {
        "Assign x and y upon object creation."
        x <<- x
        y <<- y
    }, distanceFromOrigin = function() {
        "Euclidean distance from the origin"
        sqrt(x^2 + y^2)
    }, add = function(point) {
        "Add another point to this point"
        x <<- x + point$x
        y <<- y + point$y
        .self
    }))
----



[source,r]
----
a_point <- create_point(3, 4)
a_point$distanceFromOrigin()
----

----
## [1] 5
----

[source,r]
----
another_point <- create_point(4, 2)
(a_point$add(another_point))
----

----
## Reference class object of class "point"
## Field "x":
## [1] 7
## Field "y":
## [1] 6
----



[source,r]
----
point_generator$fields()
----

----
##         x         y 
## "numeric" "numeric"
----

[source,r]
----
point_generator$methods()
----

----
##  [1] "add"                "callSuper"          "copy"              
##  [4] "distanceFromOrigin" "export"             "field"             
##  [7] "getClass"           "getRefClass"        "import"            
## [10] "initFields"         "initialize"         "show"              
## [13] "trace"              "untrace"            "usingMethods"
----



[source,r]
----
three_d_point_generator <- setRefClass(
  "three_d_point",
  fields   = list(
    z = "numeric"
  ),
  contains = "point",         #this line lets us inherit
  methods  = list(
    initialize = function(x, y, z)
    {
      "Assign x and y upon object creation."
      x <<- x
      y <<- y
      z <<- z
    }
  )
)
a_three_d_point <- three_d_point_generator$new(3, 4, 5)
----



[source,r]
----
a_three_d_point$distanceFromOrigin()  #wrong!
----

----
## [1] 5
----



[source,r]
----
three_d_point_generator <- setRefClass(
  "three_d_point",
  fields   = list(
    z = "numeric"
  ),
  contains = "point",
  methods  = list(
    initialize = function(x, y, z)
    {
      "Assign x and y upon object creation."
      x <<- x
      y <<- y
      z <<- z
    },
    distanceFromOrigin = function()
    {
      "Euclidean distance from the origin"
      sqrt(x ^ 2 + y ^ 2 + z ^ 2)
    }
  )
)
----



[source,r]
----
a_three_d_point <- three_d_point_generator$new(3, 4, 5)
a_three_d_point$distanceFromOrigin()
----

----
## [1] 7.071
----



[source,r]
----
distanceFromOrigin = function() {
    "Euclidean distance from the origin"
    two_d_distance <- callSuper()
    sqrt(two_d_distance^2 + z^2)
}
----


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Making Packages
---------------  
Chapter Goals
~~~~~~~~~~~~~
Why Create Packages?
~~~~~~~~~~~~~~~~~~~~
Prerequisites
~~~~~~~~~~~~~

[source,r]
----
install.packages(c("devtools", "roxygen2"))
----


The Package Directory Structure
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
Your First Package
~~~~~~~~~~~~~~~~~~  

[source,r]
----
hypotenuse <- function(x, y) {
    sqrt(x^2 + y^2)
}
pythagorean_triples <- data.frame(x = c(3, 5, 8, 7, 9, 11, 12, 13, 15, 16, 17, 
    19), y = c(4, 12, 15, 24, 40, 60, 35, 84, 112, 63, 144, 180), z = c(5, 13, 
    17, 25, 41, 61, 37, 85, 113, 65, 145, 181))
----



[source,r]
----
package.skeleton("pythagorus", c("hypotenuse", "pythagorean_triples"))
----


Documenting packages
~~~~~~~~~~~~~~~~~~~~

[source,r]
----
#' Help page title
#' 
#' A couple of lines of description about the function(s).
#' If you want to include code, use \code{my_code()}.
#' @param x Description of the first argument.
#' @param y Description of the second argument.
#' @return description of the return value from a function.
#' If it returns a list, use
#' \itemize{
#'    \item{item1}{A description of item1.}
#'    \item{item2}{A description of item2.}
#' }
#' @note Describe how the algorithm works, or if the function has 
#' any quirks here.
#' @author Your name here!
#' @references Journal papers, algorithms or other inspiration here.
#' You can include web links like this 
#' \url{http://www.thewebsiteyouarelinkingto.com}
#' @seealso Link to functions in the same package with
#' \code{\link{a_function_or_dataset}}
#' and functions in other packages with
#' \code{\link[another_package]{a_function_or_dataset}}
#' @examples
#' #R code run by the example function
#' \dontrun{
#' #R code that isn't run by example or when the package is built
#' }
#' @keywords misc
#' @export
f <- function(x, y) {
    # Function content goes here, as usual
}
----



[source,r]
----
library(R.oo)
Rdoc$getKeywords()
----



[source,r]
----
#' Help page title.  Probably the package name and tagline.
#' 
#' A description of what the package does, why you might want to use it,
#' which functions to look at first, and anything else that the user 
#' really, absolutely, must look at because you've created it and it is 
#' astonishing.
#' 
#' @author You again!
#' @docType package
#' @name packagename
#' @aliases packagename packagename-package
#' @keywords package
NULL
----



[source,r]
----
#' Help page title
#' 
#' Explain the contents of each column here in the description.
#' \itemize{
#'   \item{column1}{Description of column1.}
#'   \item{column2}{Description of column2.}
#' }
#' 
#' @references Where you found the data.
#' @docType data
#' @keywords datasets
#' @name datasetname
#' @usage data(datasetname)
#' @format A data frame with m rows of n variables
NULL
----



[source,r]
----
roxygenise("path/to/root/of/package")
----


Checking and Building Packages
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

[source,r]
----
library(devtools)
check("path/to/root/of/package")
----



[source,r]
----
build("path/to/root/of/package")
----



[source,r]
----
release("path/to/root/of/package")
----


[WARNING]
====
When you upload a package to CRAN, R-Core members will check that your package builds without warnings.  Their time is precious, so it's important that you run the +check+ function, and that you fix _all_ the errors and warnings before uploading to CRAN.
====
Maintaining packages
~~~~~~~~~~~~~~~~~~~~

[source,r]
----
hypotenuse <- function(x, y, p = 2) {
    if (!missing(p)) {
        .NotYetUsed("p")
    }
    sqrt(x^2 + y^2)
}
hypotenuse(5, 12)  #behaviour as before
----

----
## [1] 13
----

[source,r]
----
hypotenuse(5, 12, 1)
----

[CAUTION]
====
.Error
argument 'p' is not used (yet)

====



[source,r]
----
hypotenuse <- function(x, y, p = 2) {
    (x^p + y^p)^(1/p)
}
----



[source,r]
----
triangular <- function(n) {
    .NotYetImplemented()
}
triangular()
----

[CAUTION]
====
.Error
'triangular' is not implemented yet

====



[source,r]
----
hypotenuse <- function(x, y, p = 2) {
    .Deprecated("p_norm")
    (x^p + y^p)^(1/p)
}
hypotenuse(5, 12)
----

[WARNING]
====
.Warning
'hypotenuse' is deprecated. Use 'p_norm' instead. See
## help("Deprecated")

====

----
## [1] 13
----



[source,r]
----
hypotenuse <- function(x, y, p = 2) {
    .Defunct("p_norm")
}
hypotenuse(5, 12)
----

[CAUTION]
====
.Error
'hypotenuse' is defunct. Use 'p_norm' instead. See help("Defunct")

====


Summary
~~~~~~~
Test Your Knowledge: Quiz
~~~~~~~~~~~~~~~~~~~~~~~~~
Test Your Knowledge: Exercises
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Other Things to Do in R
=======================
Properties of Variables
=======================


[width="90%",frame="topbot",options="header"]
|=================================================================
|                |class      |typeof     |mode       |storage.mode
|logical         |logical    |logical    |logical    |logical     
|integer         |integer    |integer    |numeric    |integer     
|floating point  |numeric    |double     |numeric    |double      
|complex         |complex    |complex    |complex    |complex     
|string          |character  |character  |character  |character   
|raw byte        |raw        |raw        |raw        |raw         
|categorical     |factor     |integer    |numeric    |integer     
|null            |NULL       |NULL       |NULL       |NULL        
|logical matrix  |matrix     |logical    |logical    |logical     
|numeric matrix  |matrix     |double     |numeric    |double      
|character matrix|matrix     |character  |character  |character   
|logical array   |array      |logical    |logical    |logical     
|numeric array   |array      |double     |numeric    |double      
|character array |array      |character  |character  |character   
|list            |list       |list       |list       |list        
|data frame      |data.frame |list       |list       |list        
|function        |function   |closure    |function   |function    
|environment     |environment|environment|environment|environment 
|expression      |expression |expression |expression |expression  
|call            |call       |language   |call       |language    
|formula         |formula    |language   |call       |language    
|=================================================================


[TIP]
====
Factors _are not_ vectors.
====
[TIP]
====
Matrices and arrays _are_ atomic.
====
[width="70%",frame="topbot",options="header"]
|=============================================================
|                |is.vector|is.atomic|is.recursive|is.language
|logical         |TRUE     |TRUE     |FALSE       |FALSE      
|integer         |TRUE     |TRUE     |FALSE       |FALSE      
|floating point  |TRUE     |TRUE     |FALSE       |FALSE      
|complex         |TRUE     |TRUE     |FALSE       |FALSE      
|string          |TRUE     |TRUE     |FALSE       |FALSE      
|raw byte        |TRUE     |TRUE     |FALSE       |FALSE      
|categorical     |FALSE    |TRUE     |FALSE       |FALSE      
|null            |FALSE    |TRUE     |FALSE       |FALSE      
|logical matrix  |FALSE    |TRUE     |FALSE       |FALSE      
|numeric matrix  |FALSE    |TRUE     |FALSE       |FALSE      
|character matrix|FALSE    |TRUE     |FALSE       |FALSE      
|logical array   |FALSE    |TRUE     |FALSE       |FALSE      
|numeric array   |FALSE    |TRUE     |FALSE       |FALSE      
|character array |FALSE    |TRUE     |FALSE       |FALSE      
|list            |TRUE     |FALSE    |TRUE        |FALSE      
|data frame      |FALSE    |FALSE    |TRUE        |FALSE      
|function        |FALSE    |FALSE    |TRUE        |FALSE      
|environment     |FALSE    |FALSE    |TRUE        |FALSE      
|expression      |TRUE     |FALSE    |TRUE        |TRUE       
|call            |FALSE    |FALSE    |TRUE        |TRUE       
|formula         |FALSE    |FALSE    |TRUE        |TRUE       
|=============================================================


Answers to Quizzes
==================

[source,r]
----
x <- Sys.time()
x + 3600
----

----
## [1] "2013-09-11 13:39:38 BST"
----


Solutions to Exercises
======================

[source,r]
----
sd(0:100)
----



[source,r]
----
demo(plotmath)
----



[source,r]
----
atan(1/1:1000)
----



[source,r]
----
x <- 1:1000
y <- atan(1/x)
z <- 1/tan(y)
----



[source,r]
----
x == z
identical(x, z)
all.equal(x, z)
all.equal(x, z, tolerance = 0)
----



[source,r]
----
true_and_missing <- c(NA, TRUE, NA)
false_and_missing <- c(FALSE, FALSE, NA)
mixed <- c(TRUE, FALSE, NA)

any(true_and_missing)
any(false_and_missing)
any(mixed)
all(true_and_missing)
all(false_and_missing)
all(mixed)
----



[source,r]
----
class(Inf)
class(NA)
class(NaN)
class("")
----



[source,r]
----
pets <- factor(sample(c("dog", "cat", "hamster", "goldfish"), 1000, replace = TRUE))
head(pets)
summary(pets)
----





[source,r]
----
carrot <- 1
potato <- 2
swede <- 3
ls(pattern = "a")
----



[source,r]
----
n <- seq_len(20)
triangular <- n * (n + 1)/2
names(triangular) <- letters[seq_along(n)]
triangular[c("a", "e", "i", "o")]
----



[source,r]
----
diag(abs(seq.int(-11, 11)))
----



[source,r]
----
identity_20_by_21 <- diag(rep.int(1, 20), 20, 21)
below_the_diagonal <- rbind(0, identity_20_by_21)
identity_21_by_20 <- diag(rep.int(1, 20), 21, 20)
above_the_diagonal <- cbind(0, identity_21_by_20)
on_the_diagonal <- diag(abs(seq.int(-10, 10)))
wilkinson_21 <- below_the_diagonal + above_the_diagonal + on_the_diagonal
eigen(wilkinson_21)$values
----



[source,r]
----
list(`0 to 9` = c(0, 1, 4, 9), `10 to 19` = 16, `20 to 29` = 25, `30 to 39` = 36, 
    `40 to 49` = 49, `50 to 59` = NULL, `60 to 69` = 64, `70 to 79` = NULL, 
    `80 to 89` = 81, `90 to 99` = NULL)
----



[source,r]
----
x <- 0:99
sqrt_x <- sqrt(x)
is_square_number <- sqrt_x == floor(sqrt_x)
square_numbers <- x[is_square_number]
groups <- cut(square_numbers, seq.int(min(x), max(x), 10), include.lowest = TRUE, 
    right = FALSE)
split(square_numbers, groups)
----



[source,r]
----
iris_numeric <- iris[, 1:4]
colMeans(iris_numeric)
----



[source,r]
----
beaver1$id <- 1
beaver2$id <- 2
both_beavers <- rbind(beaver1, beaver2)
subset(both_beavers, as.logical(activ))
----



[source,r]
----
multiples_of_pi <- new.env()
multiples_of_pi[["two_pi"]] <- 2 * pi
multiples_of_pi$three_pi <- 3 * pi
assign("four_pi", 4 * pi, multiples_of_pi)
ls(multiples_of_pi)
----

----
## [1] "four_pi"  "three_pi" "two_pi"
----



[source,r]
----
is_even <- function(x) (x%%2) == 0
is_even(c(-5:5, Inf, -Inf, NA, NaN))
----

----
##  [1] FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE
## [12]    NA    NA    NA    NA
----



[source,r]
----
args_and_body <- function(fn) {
    list(arguments = formals(fn), body = body(fn))
}
args_and_body(var)
----

----
## $arguments
## $arguments$x
## 
## 
## $arguments$y
## NULL
## 
## $arguments$na.rm
## [1] FALSE
## 
## $arguments$use
## 
## 
## 
## $body
## {
##     if (missing(use)) 
##         use <- if (na.rm) 
##             "na.or.complete"
##         else "everything"
##     na.method <- pmatch(use, c("all.obs", "complete.obs", "pairwise.complete.obs", 
##         "everything", "na.or.complete"))
##     if (is.na(na.method)) 
##         stop("invalid 'use' argument")
##     if (is.data.frame(x)) 
##         x <- as.matrix(x)
##     else stopifnot(is.atomic(x))
##     if (is.data.frame(y)) 
##         y <- as.matrix(y)
##     else stopifnot(is.atomic(y))
##     .Call(C_cov, x, y, na.method, FALSE)
## }
----

[source,r]
----
args_and_body(alarm)
----

----
## $arguments
## NULL
## 
## $body
## {
##     cat("\a")
##     flush.console()
## }
----



[source,r]
----
formatC(pi, digits = 16)
----

----
## [1] "3.141592653589793"
----





[source,r]
----
#'split on an optional comma, a compulsory space, an optional
# hyphen and an optional space'
strsplit(x, ",? -? ?")
----

----
## [[1]]
## [1] "Swan"  "swam"  "over"  "the"   "pond"  "Swim"  "swan"  "swim!"
## 
## [[2]]
## [1] "Swan"  "swam"  "back"  "again" "Well"  "swum"  "swan!"
----

[source,r]
----
# or, grouping the final hyphen and space
strsplit(x, ",? (- )?")
----

----
## [[1]]
## [1] "Swan"  "swam"  "over"  "the"   "pond"  "Swim"  "swan"  "swim!"
## 
## [[2]]
## [1] "Swan"  "swam"  "back"  "again" "Well"  "swum"  "swan!"
----





[source,r]
----
scores <- three_d6(1000)
bonuses <- cut(scores, c(2, 3, 5, 8, 12, 15, 17, 18), labels = -3:3)
table(bonuses)
----

----
## bonuses
##  -3  -2  -1   0   1   2   3 
##   9  37 229 482 194  46   3
----





[source,r]
----
score <- two_d6(1)
if (score %in% c(2, 3, 12)) {
    game_status <- FALSE
    point <- NA
} else if (score %in% c(7, 11)) {
    game_status <- TRUE
    point <- NA
} else {
    game_status <- NA
    point <- score
}
----



[source,r]
----
if (is.na(game_status)) {
    repeat ({
        score <- two_d6(1)
        if (score == 7) {
            game_status <- FALSE
            break
        } else if (score == point) {
            game_status <- TRUE
            break
        }
    })
}
----





[source,r]
----
nchar_sea_shells <- nchar(sea_shells)

for (i in min(nchar_sea_shells):max(nchar_sea_shells)) {
    message("These words have ", i, " letters:")
    print(toString(unique(sea_shells[nchar_sea_shells == i])))
}
----

[NOTE]
====
.Message
 These words have 2 letters:

====

----
## [1] "by, So, if, on"
----

[NOTE]
====
.Message
 These words have 3 letters:

====

----
## [1] "She, sea, the, The, she, are, I'm"
----

[NOTE]
====
.Message
 These words have 4 letters:

====

----
## [1] "sure"
----

[NOTE]
====
.Message
 These words have 5 letters:

====

----
## [1] "sells"
----

[NOTE]
====
.Message
 These words have 6 letters:

====

----
## [1] "shells, surely"
----

[NOTE]
====
.Message
 These words have 7 letters:

====

----
## [1] ""
----

[NOTE]
====
.Message
 These words have 8 letters:

====

----
## [1] "seashore"
----

[NOTE]
====
.Message
 These words have 9 letters:

====

----
## [1] "seashells"
----





[source,r]
----
vapply(wayans, length, integer(1))
----

----
##   Dwayne Kim Keenen Ivory        Damon          Kim        Shawn 
##            0            5            4            0            3 
##       Marlon        Nadia       Elvira       Diedre       Vonnie 
##            2            0            2            5            0
----



----
##  num [1:50, 1:8] 3615 365 2212 2110 21198 ...
##  - attr(*, "dimnames")=List of 2
##   ..$ : chr [1:50] "Alabama" "Alaska" "Arizona" "Arkansas" ...
##   ..$ : chr [1:8] "Population" "Income" "Illiteracy" "Life Exp" ...
----

----
##            Population Income Illiteracy Life Exp Murder HS Grad Frost
## Alabama          3615   3624        2.1    69.05   15.1    41.3    20
## Alaska            365   6315        1.5    69.31   11.3    66.7   152
## Arizona          2212   4530        1.8    70.55    7.8    58.1    15
## Arkansas         2110   3378        1.9    70.66   10.1    39.9    65
## California      21198   5114        1.1    71.71   10.3    62.6    20
## Colorado         2541   4884        0.7    72.06    6.8    63.9   166
##              Area
## Alabama     50708
## Alaska     566432
## Arizona    113417
## Arkansas    51945
## California 156361
## Colorado   103766
----

----
## [1] "matrix"
----



----
## Population     Income Illiteracy   Life Exp     Murder    HS Grad 
##   4246.420   4435.800      1.170     70.879      7.378     53.108 
##      Frost       Area 
##    104.460  70735.880
----

----
## Population     Income Illiteracy   Life Exp     Murder    HS Grad 
##  4.464e+03  6.145e+02  6.095e-01  1.342e+00  3.692e+00  8.077e+00 
##      Frost       Area 
##  5.198e+01  8.533e+04
----





[source,r]
----
with(commute_data, tapply(time, mode, quantile, prob = 0.75))
----

----
##  bike   bus   car train 
## 63.98 58.37 47.07 37.15
----

[source,r]
----
ddply(commute_data, .(mode), summarise, time_p75 = quantile(time, 0.75))
----

----
##    mode time_p75
## 1  bike    63.98
## 2   bus    58.37
## 3   car    47.07
## 4 train    37.15
----



[source,r]
----
install.packages("lubridate")
----



[source,r]
----
pkgs <- installed.packages()
table(pkgs[, "LibPath"])
----

----
## 
## C:/Program Files/R/R-devel/library                       D:/R/library 
##                                 29                                175
----



[source,r]
----
in_string <- c("1940-07-07", "1940-10-09", "1942-06-18", "1943-02-25")
(parsed <- strptime(in_string, "%Y-%m-%d"))
----

----
## [1] "1940-07-07" "1940-10-09" "1942-06-18" "1943-02-25"
----

[source,r]
----
(out_string <- strftime(parsed, "%a %d %b %y"))
----

----
## [1] "Sun 07 Jul 40" "Wed 09 Oct 40" "Thu 18 Jun 42" "Thu 25 Feb 43"
----



[source,r]
----
tzfile <- file.path(R.home("share"), "zoneinfo", "zone.tab")
tzones <- read.delim(tzfile, row.names = NULL, header = FALSE, col.names = c("country", 
    "coords", "name", "comments"), as.is = TRUE, fill = TRUE, comment.char = "#")
----



[source,r]
----
zodiac_sign <- function(x) {
    month_x <- month(x, label = TRUE)
    day_x <- day(x)
    switch(month_x, Jan = if (day_x < 20) "Capricorn" else "Aquarius", Feb = if (day_x < 
        19) "Aquarius" else "Pisces", Mar = if (day_x < 21) "Pisces" else "Aries", 
        Apr = if (day_x < 20) "Aries" else "Taurus", May = if (day_x < 21) "Taurus" else "Gemini", 
        Jun = if (day_x < 21) "Gemini" else "Cancer", Jul = if (day_x < 23) "Cancer" else "Leo", 
        Aug = if (day_x < 23) "Leo" else "Virgo", Sep = if (day_x < 23) "Virgo" else "Libra", 
        Oct = if (day_x < 23) "Libra" else "Scorpio", Nov = if (day_x < 22) "Scorpio" else "Sagittarius", 
        Dec = if (day_x < 22) "Sagittarius" else "Capricorn")
}
# Usage is, for example,
nicolaus_copernicus_birth_date <- as.Date("1473-02-19")
zodiac_sign(nicolaus_copernicus_birth_date)
----

----
## [1] "Pisces"
----



[source,r]
----
hafu_file <- system.file("extdata", "hafu.csv", package = "learningr")
hafu_data <- read.csv(hafu_file)
----

[WARNING]
====
.Warning
file("") only supports open = "w+" and open = "w+b": using the
## former

====

[CAUTION]
====
.Error
no lines available in input

====



[source,r]
----
library(xlsx)
gonorrhoea_file <- system.file("extdata", "multi-drug-resistant gonorrhoea infection.xls", 
    package = "learningr")
gonorrhoea_data <- read.xlsx2(gonorrhoea_file, sheetIndex = 1, colClasses = c("integer", 
    "character", "character", "numeric"))
----

[CAUTION]
====
.Error
Cannot find

====



[source,r]
----
library(RSQLite)
driver <- dbDriver("SQLite")
db_file <- system.file("extdata", "crabtag.sqlite", package = "learningr")
conn <- dbConnect(driver, db_file)

query <- "SELECT * FROM Daylog"
head(daylog <- dbGetQuery(conn, query))
----

[CAUTION]
====
.Error
error in evaluating the argument 'x' in selecting a method for
## function 'head': Error in sqliteExecStatement(con, statement, bind.data) :
## RS-DBI driver: (error in statement: no such table: Daylog)

====

[source,r]
----

dbDisconnect(conn)
----

----
## [1] TRUE
----

[source,r]
----
dbUnloadDriver(driver)
----

----
## [1] TRUE
----



[source,r]
----
head(daylog <- query_crab_tag_db("SELECT * FROM Daylog"))
----



[source,r]
----
get_table_from_crab_tag_db <- function(tbl) {
    driver <- dbDriver("SQLite")
    db_file <- system.file("extdata", "crabtag.sqlite", package = "learningr")
    conn <- dbConnect(driver, db_file)
    on.exit({
        dbDisconnect(conn)
        dbUnloadDriver(driver)
    })
    dbReadTable(conn, tbl)
}
head(daylog <- get_table_from_crab_tag_db("Daylog"))
----

[CAUTION]
====
.Error
error in evaluating the argument 'x' in selecting a method for
## function 'head': Error in sqliteReadTable(conn, name, ...) : could not
## find table Daylog

====



[source,r]
----
library(stringr)
data(hafu, package = "learningr")
hafu$FathersNationalityIsUncertain <- str_detect(hafu$Father, fixed("?"))
hafu$MothersNationalityIsUncertain <- str_detect(hafu$Mother, fixed("?"))
----



[source,r]
----
hafu$Father <- str_replace(hafu$Father, fixed("?"), "")
hafu$Mother <- str_replace(hafu$Mother, fixed("?"), "")
----



[source,r]
----
hafu_long <- melt(hafu, measure.vars = c("Father", "Mother"))
----



[source,r]
----
top10 <- function(x) {
    counts <- table(x, useNA = "always")
    head(sort(counts, decreasing = TRUE), 10)
}
top10(hafu$Mother)
----

----
## x
##  Japanese      <NA>   English  American    French    German   Russian 
##       120        50        29        23        20        12        10 
##   Fantasy   Italian Brazilian 
##         8         4         3
----



[source,r]
----
top10_v2 <- function(x) {
    counts <- count(x)
    head(arrange(counts, desc(freq)), 10)
}
top10_v2(hafu$Mother)
----

----
##            x freq
## 1   Japanese  120
## 2       <NA>   50
## 3    English   29
## 4   American   23
## 5     French   20
## 6     German   12
## 7    Russian   10
## 8    Fantasy    8
## 9    Italian    4
## 10 Brazilian    3
----





[source,r]
----
with(obama_vs_mccain, cor(Unemployment, Obama))
----

----
## [1] 0.2897
----



[source,r]
----
with(obama_vs_mccain, plot(Unemployment, Obama))
xyplot(Obama ~ Unemployment, obama_vs_mccain)
ggplot(obama_vs_mccain, aes(Unemployment, Obama)) + geom_point()
----



[source,r]
----
plot_numbers <- 1:2
layout(matrix(plot_numbers, ncol = 2, byrow = TRUE))
for (drug_use in c(FALSE, TRUE)) {
    group_data <- subset(alpe_d_huez2, DrugUse == drug_use)
    with(group_data, hist(NumericTime))
}

histogram(~NumericTime | DrugUse, alpe_d_huez2)

ggplot(alpe_d_huez2, aes(NumericTime)) + geom_histogram(binwidth = 2) + facet_wrap(~DrugUse)
----



[source,r]
----
boxplot(NumericTime ~ DrugUse, alpe_d_huez2)
bwplot(DrugUse ~ NumericTime, alpe_d_huez2)

ggplot(alpe_d_huez2, aes(DrugUse, NumericTime, group = DrugUse)) + geom_boxplot()
----



[source,r]
----
ggplot(gonorrhoea, aes(Age.Group, Rate)) + geom_bar(stat = "identity") + facet_wrap(~Year + 
    Ethnicity + Gender)
----



[source,r]
----
ggplot(gonorrhoea, aes(Age.Group, Rate, group = Year, fill = Year)) + geom_bar(stat = "identity", 
    position = "dodge") + facet_wrap(~Ethnicity + Gender)
----



[source,r]
----
ggplot(gonorrhoea, aes(Age.Group, Rate, group = Year, colour = Year)) + geom_line() + 
    facet_wrap(~Ethnicity + Gender)
----



[source,r]
----
ggplot(gonorrhoea, aes(Age.Group, Rate, group = Year, colour = Year)) + geom_line() + 
    facet_grid(Ethnicity ~ Gender)
----



[source,r]
----
ggplot(gonorrhoea, aes(Age.Group, Rate, group = Year, colour = Year)) + geom_line() + 
    facet_grid(Ethnicity ~ Gender, scales = "free_y")
----



[source,r]
----
dpois(3, 3)
----

----
## [1] 0.224
----



[source,r]
----
pnbinom(12, 1, 0.25)
----

----
## [1] 0.9762
----



[source,r]
----
qbirthday(0.9)
----

----
## [1] 41
----



[source,r]
----
model1 <- lm(Rate ~ Year + Age.Group + Ethnicity + Gender, gonorrhoea, subset = Age.Group %in% 
    c("15 to 19", "20 to 24", "25 to 29", "30 to 34"))
summary(model1)
----

----
## 
## Call:
## lm(formula = Rate ~ Year + Age.Group + Ethnicity + Gender, data = gonorrhoea, 
##     subset = Age.Group %in% c("15 to 19", "20 to 24", "25 to 29", 
##         "30 to 34"))
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -774.0 -127.7  -10.3  106.2  857.7 
## 
## Coefficients:
##                                     Estimate Std. Error t value Pr(>|t|)
## (Intercept)                          9491.13   25191.00    0.38   0.7068
## Year                                   -4.55      12.54   -0.36   0.7173
## Age.Group20 to 24                     131.12      50.16    2.61   0.0097
## Age.Group25 to 29                    -124.60      50.16   -2.48   0.0138
## Age.Group30 to 34                    -259.83      50.16   -5.18  5.6e-07
## EthnicityAsians & Pacific Islanders  -212.76      56.08   -3.79   0.0002
## EthnicityHispanics                   -124.06      56.08   -2.21   0.0281
## EthnicityNon-Hispanic Blacks         1014.35      56.08   18.09  < 2e-16
## EthnicityNon-Hispanic Whites         -174.72      56.08   -3.12   0.0021
## GenderMale                            -83.85      35.47   -2.36   0.0191
##                                        
## (Intercept)                            
## Year                                   
## Age.Group20 to 24                   ** 
## Age.Group25 to 29                   *  
## Age.Group30 to 34                   ***
## EthnicityAsians & Pacific Islanders ***
## EthnicityHispanics                  *  
## EthnicityNon-Hispanic Blacks        ***
## EthnicityNon-Hispanic Whites        ** 
## GenderMale                          *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 251 on 190 degrees of freedom
## Multiple R-squared:  0.798,	Adjusted R-squared:  0.789 
## F-statistic: 83.7 on 9 and 190 DF,  p-value: <2e-16
----



[source,r]
----
model2 <- update(model1, ~. - Year)
summary(model2)
----

----
## 
## Call:
## lm(formula = Rate ~ Age.Group + Ethnicity + Gender, data = gonorrhoea, 
##     subset = Age.Group %in% c("15 to 19", "20 to 24", "25 to 29", 
##         "30 to 34"))
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -774.0 -129.3   -6.7  104.3  866.8 
## 
## Coefficients:
##                                     Estimate Std. Error t value Pr(>|t|)
## (Intercept)                            358.2       53.1    6.75  1.7e-10
## Age.Group20 to 24                      131.1       50.0    2.62  0.00949
## Age.Group25 to 29                     -124.6       50.0   -2.49  0.01363
## Age.Group30 to 34                     -259.8       50.0   -5.19  5.3e-07
## EthnicityAsians & Pacific Islanders   -212.8       55.9   -3.80  0.00019
## EthnicityHispanics                    -124.1       55.9   -2.22  0.02777
## EthnicityNon-Hispanic Blacks          1014.3       55.9   18.13  < 2e-16
## EthnicityNon-Hispanic Whites          -174.7       55.9   -3.12  0.00207
## GenderMale                             -83.8       35.4   -2.37  0.01881
##                                        
## (Intercept)                         ***
## Age.Group20 to 24                   ** 
## Age.Group25 to 29                   *  
## Age.Group30 to 34                   ***
## EthnicityAsians & Pacific Islanders ***
## EthnicityHispanics                  *  
## EthnicityNon-Hispanic Blacks        ***
## EthnicityNon-Hispanic Whites        ** 
## GenderMale                          *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 250 on 191 degrees of freedom
## Multiple R-squared:  0.798,	Adjusted R-squared:  0.79 
## F-statistic: 94.5 on 8 and 191 DF,  p-value: <2e-16
----



----
## 
## Call:
## lm(formula = Rate ~ Age.Group + Ethnicity + Gender + Ethnicity:Gender, 
##     data = gonorrhoea, subset = Age.Group %in% c("15 to 19", 
##         "20 to 24", "25 to 29", "30 to 34"))
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -806.0 -119.4   -9.4  105.3  834.8 
## 
## Coefficients:
##                                                Estimate Std. Error t value
## (Intercept)                                       405.1       63.9    6.34
## Age.Group20 to 24                                 131.1       50.1    2.62
## Age.Group25 to 29                                -124.6       50.1   -2.49
## Age.Group30 to 34                                -259.8       50.1   -5.19
## EthnicityAsians & Pacific Islanders              -296.9       79.2   -3.75
## EthnicityHispanics                               -197.2       79.2   -2.49
## EthnicityNon-Hispanic Blacks                      999.5       79.2   12.62
## EthnicityNon-Hispanic Whites                     -237.0       79.2   -2.99
## GenderMale                                       -177.6       79.2   -2.24
## EthnicityAsians & Pacific Islanders:GenderMale    168.2      112.0    1.50
## EthnicityHispanics:GenderMale                     146.2      112.0    1.30
## EthnicityNon-Hispanic Blacks:GenderMale            29.7      112.0    0.27
## EthnicityNon-Hispanic Whites:GenderMale           124.6      112.0    1.11
##                                                Pr(>|t|)    
## (Intercept)                                     1.7e-09 ***
## Age.Group20 to 24                               0.00960 ** 
## Age.Group25 to 29                               0.01377 *  
## Age.Group30 to 34                               5.6e-07 ***
## EthnicityAsians & Pacific Islanders             0.00024 ***
## EthnicityHispanics                              0.01370 *  
## EthnicityNon-Hispanic Blacks                    < 2e-16 ***
## EthnicityNon-Hispanic Whites                    0.00315 ** 
## GenderMale                                      0.02615 *  
## EthnicityAsians & Pacific Islanders:GenderMale  0.13487    
## EthnicityHispanics:GenderMale                   0.19361    
## EthnicityNon-Hispanic Blacks:GenderMale         0.79092    
## EthnicityNon-Hispanic Whites:GenderMale         0.26754    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 251 on 187 degrees of freedom
## Multiple R-squared:  0.802,	Adjusted R-squared:  0.789 
## F-statistic: 63.2 on 12 and 187 DF,  p-value: <2e-16
----



[source,r]
----
install.packages("betareg")
----



[source,r]
----
ovm <- within(obama_vs_mccain, Obama <- Obama/100)
----



[source,r]
----
library(betareg)
----

[NOTE]
====
.Message
 Loading required package: Formula

====

[source,r]
----
beta_model1 <- betareg(Obama ~ Turnout + Population + Unemployment + Urbanisation + 
    Black + Protestant, ovm, subset = State != "District of Columbia")
----

[CAUTION]
====
.Error
object 'Urbanisation' not found

====

[source,r]
----
summary(beta_model1)
----

[CAUTION]
====
.Error
object 'beta_model1' not found

====



[source,r]
----
beta_model2 <- update(beta_model1, ~. - Urbanisation)
----

[CAUTION]
====
.Error
object 'beta_model1' not found

====

[source,r]
----
summary(beta_model2)
----

[CAUTION]
====
.Error
object 'beta_model2' not found

====



[source,r]
----
beta_model3 <- update(beta_model2, ~. - Population)
----

[CAUTION]
====
.Error
object 'beta_model2' not found

====

[source,r]
----
summary(beta_model3)
----

[CAUTION]
====
.Error
object 'beta_model3' not found

====



[source,r]
----
plot_numbers <- 1:6
layout(matrix(plot_numbers, ncol = 2, byrow = TRUE))
plot(beta_model3, plot_numbers)
----



[source,r]
----
harmonic_mean <- function(x, na.rm = FALSE) {
    if (!is.numeric(x)) {
        warning("Coercing 'x' to be numeric.")
        x <- as.numeric(x)
    }
    if (any(!is.na(x) & x <= 0)) {
        stop("'x' contains non-positive values")
    }
    1/mean(1/x, na.rm = na.rm)
}
----



[source,r]
----
test.harmonic_mean.1_2_4.returns_12_over_7 <- function() {
    expected <- 12/7
    actual <- harmonic_mean(c(1, 2, 4))
    checkEqualsNumeric(expected, actual)
}
test.harmonic_mean.no_inputs.throws_error <- function() {
    checkException(harmonic_mean())
}
test.harmonic_mean.some_missing.returns_na <- function() {
    expected <- NA_real_
    actual <- harmonic_mean(c(1, 2, 4, NA))
    checkEqualsNumeric(expected, actual)
}
test.harmonic_mean.some_missing_with_nas_removed.returns_12_over_7 <- function() {
    expected <- 12/7
    actual <- harmonic_mean(c(1, 2, 4, NA), na.rm = TRUE)
    checkEqualsNumeric(expected, actual)
}
test.harmonic_mean.non_numeric_input.throws_warning <- function() {
    old_ops <- options(warn = 2)
    on.exit(options(old_ops))
    checkException(harmonic_mean("1"))
}
test.harmonic_mean.zero_inputs.throws_error <- function() {
    checkException(harmonic_mean(0))
}
----



[source,r]
----
expect_equal(12/7, harmonic_mean(c(1, 2, 4)))
expect_error(harmonic_mean())
expect_equal(NA_real_, harmonic_mean(c(1, 2, 4, NA)))
expect_equal(12/7, harmonic_mean(c(1, 2, 4, NA), na.rm = TRUE))
expect_warning(harmonic_mean("1"))
expect_error(harmonic_mean(0))
----



[source,r]
----
harmonic_mean <- function(x, na.rm = FALSE) {
    if (!is.numeric(x)) {
        warning("Coercing 'x' to be numeric.")
        x <- as.numeric(x)
    }
    if (any(!is.na(x) & x <= 0)) {
        stop("'x' contains non-positive values")
    }
    result <- 1/mean(1/x, na.rm = na.rm)
    class(result) <- "harmonic"
    result
}
----



[source,r]
----
print.harmonic <- function(x, ...) {
    cat("The harmonic mean is", x, "\n", ...)
}
----



[source,r]
----
sum_of_squares <- function(n) {
    n * (n + 1) * (2 * n + 1)/6
}
x <- 1:10
squares_data <- data.frame(x = x, y = sum_of_squares(x))
----



[source,r]
----
package.skeleton("squares", c("sum_of_squares", "squares_data"))
----



[source,r]
----
#' Sum of Squares
#' 
#' Calculates the sum of squares of the first \code{n} natural numbers.
#'
#' @param n A positive integer.
#' @return A integer equal to the sum of the squars of the first \code{n}
#' natural numbers.
#' @author Richie Cotton.
#' @seealso \code{\link[base]{sum}}
#' @examples
#' sum_of_squares(1:20)
#' @keywords misc
#' @export
----



[source,r]
----
#' squares: Sums of squares.
#' 
#' A test package that contains data of the sum of squares of natural 
#' numbers, and a function to calculate more values.
#' 
#' @author Richie Cotton
#' @docType package
#' @name squares
#' @aliases squares squares-package
#' @keywords package
NULL
----



[source,r]
----
#' Sum of squares dataset
#' 
#' The sum of squares of natural numbers.
#' \itemize{
#'   \item{x}{Natural numbers.}
#'   \item{y}{The sum of squares from 1 to \code{x}.}
#' }
#' 
#' @docType data
#' @keywords datasets
#' @name squares_data
#' @usage data(squares_data)
#' @format A data frame with 10 rows and 2 variables.
NULL
----



[source,r]
----
check("squares")
build("squares")
----


References
==========   
